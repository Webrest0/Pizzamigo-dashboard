<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dashboard â€” PIZZâ€™AMIGO</title>
<style>
  :root{
    --bg:#0b0f14;--panel:#101722;--line:#283149;--muted:#b8c2d6;
    --green:#1fcf7c;--red:#e55252;--white:#ffffff;--accent:#ffb54c;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:#fff;font-family:system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:1080px;margin:22px auto;padding:0 14px}
  h1{margin:0 0 14px;font-size:36px;line-height:1.1}

  .panel{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:12px}
  .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  input[type=text]{flex:1 1 380px;min-width:260px;border:1px solid var(--line);background:#0e1420;color:#fff;border-radius:12px;padding:10px}
  .btn{border:1px solid rgba(255,255,255,.28);background:transparent;color:#fff;border-radius:999px;padding:8px 12px;cursor:pointer}
  .btn.primary{background:var(--green);color:#001b10;border-color:transparent}
  .btn.red{border-color:#ff9a9a;color:#ffc9c9}
  .btn.small{padding:6px 10px;font-size:.95rem}
  .tag{display:inline-flex;align-items:center;gap:6px;border:1px solid rgba(255,255,255,.25);padding:8px 12px;border-radius:999px}
  .tag.warn{border-color:#ffd591;color:#ffd591;background:rgba(255,181,76,.06)}
  .muted{color:var(--muted)}
  .right{margin-left:auto}
  .vol{display:flex;align-items:center;gap:10px}

  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{border-bottom:1px solid rgba(255,255,255,.07);padding:12px 10px;vertical-align:top}
  th{font-weight:700;text-align:left;color:#cfe0ff}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  .status{padding:4px 8px;border:1px solid var(--line);border-radius:999px}
  .status.new{color:#e0e8ff;border-color:#6171a0}
  .status.ready{color:#ffe6b3;border-color:#a0834a}
  .status.done{color:#b2ffd9;border-color:#1fcf7c}
  .status.canceled{color:#ffc1c1;border-color:#e55252}

  /* mobile */
  @media (max-width:720px){
    h1{font-size:28px}
    .row input[type=text]{flex:1 1 100%}
    th:nth-child(2), td:nth-child(2){display:none;} /* cache ID sur mobile */
    th:nth-child(5), td:nth-child(5){display:none;} /* cache tÃ©lÃ©phone sur mobile */
    th:nth-child(7), td:nth-child(7){display:none;} /* cache total, laissÃ© dans les pizzas */
  }

  /* panneau erreur */
  #err{position:fixed;right:8px;bottom:8px;max-width:92vw;background:#2a1b1b;border:1px solid #5d2f2f;border-radius:10px;padding:10px 12px;display:none;z-index:999}
  #err pre{white-space:pre-wrap;margin:6px 0 0 0;color:#ffd1d1}
</style>
</head>
<body>
<div class="wrap">
  <h1>Dashboard â€” PIZZâ€™AMIGO</h1>

  <div class="panel">
    <div class="row">
      <input id="api" type="text" placeholder="URL de lâ€™API (Apps Script)">
      <input id="adm" type="text" placeholder="ClÃ© admin (facultatif)" style="max-width:260px">
      <button id="save" class="btn">Enregistrer</button>
      <button id="refresh" class="btn">Actualiser</button>

      <span class="right muted" id="net">â€”</span>
    </div>
    <div class="row" style="margin-top:10px">
      <label class="tag warn"><span>ðŸ””</span> <input id="snd" type="checkbox" style="margin-right:6px"> Activer le son</label>
      <div class="vol">Son :
        <input id="vol" type="range" min="0" max="1" step=".01" value=".8" style="width:220px">
      </div>
    </div>
  </div>

  <div class="panel" style="margin-top:14px">
    <table>
      <thead>
        <tr>
          <th>Heure</th>
          <th>ID</th>
          <th>Client</th>
          <th>TÃ©lÃ©phone</th>
          <th>Horaire</th>
          <th>Pizzas</th>
          <th>Total</th>
          <th>Statut</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="tb"></tbody>
    </table>
  </div>
</div>

<!-- Panneau erreur -->
<div id="err"><b>Erreur JavaScript</b><pre id="err-msg"></pre></div>

<script>
/*** utilitaires ***/
const $ = sel => document.querySelector(sel);
function showErr(msg,txt){
  const b = $('#err'); b.style.display='block';
  $('#err-msg').textContent = (msg||'') + (txt ? ('\\n'+txt) : '');
  console.error('Dashboard error:', msg, txt||'');
}
const euro = n => (Number(n)||0).toFixed(2).replace('.', ',')+' â‚¬';
const hhmm = s => {
  if(!s) return 'â€”';
  try{
    // accepte "19:30", timestamp, ou date iso
    if(String(s).match(/^\\d{1,2}:\\d{2}$/)) return s;
    const d = new Date(s);
    if(!isNaN(d)) return String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0');
  }catch(e){}
  return String(s);
};

/*** Ã©tat + sonnerie ***/
const store = {
  read(){ try{return JSON.parse(localStorage.getItem('pzadm')||'{}')}catch{return{}} },
  write(o){ localStorage.setItem('pzadm', JSON.stringify(o)); }
};
let pref = Object.assign({api:'', adminkey:'', snd:false, vol:.8}, store.read());
let bell, unlocked=false;

/*** API helpers ***/
function safeJSON(text){
  try{ return JSON.parse(text); }catch(e){ return {ok:false, nonjson:true, raw:text}; }
}
async function apiGetList(){
  const url = new URL(pref.api);
  url.searchParams.set('list','1');
  const r = await fetch(url.toString(), {method:'GET'});
  const t = await r.text();
  const data = safeJSON(t);
  if(!data.ok && !data.orders){
    throw new Error(data.nonjson ? 'RÃ©ponse non JSON' : (data.error||'RÃ©ponse invalide'));
  }
  return (data.orders||[]);
}
async function apiPost(payload){
  const r = await fetch(pref.api, {
    method:'POST',
    headers:{'Content-Type':'text/plain;charset=utf-8'},
    body: JSON.stringify(payload)
  });
  const t = await r.text();
  const data = safeJSON(t);
  if(!r.ok || data.ok===false){
    throw new Error((data && (data.error||data.message)) || ('HTTP '+r.status));
  }
  return data;
}

/*** rendu ***/
function normalizeBasket(o){
  // cherche items dans plusieurs formes possibles
  try{
    if(typeof o.panier === 'string') o.panier = JSON.parse(o.panier);
  }catch(e){}
  const b = o.basket || o.panier || {};
  let items = [];
  if (Array.isArray(b)) items = b;
  else if (Array.isArray(b.items)) items = b.items;
  else if (Array.isArray(o.items)) items = o.items;
  // sÃ©curise
  if(!Array.isArray(items)) items = [];
  return items;
}

function render(list){
  const tb = $('#tb'); tb.innerHTML = '';
  for(const o of list){
    const items = normalizeBasket(o);
    const pizzas = items.map(it => {
      const sup = it.supplType ? ` (+1â‚¬ ${it.supplType})` : '';
      return `${it.name} Ã— ${it.qty}${sup}`;
    }).join('<br>');

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${o.when ? hhmm(o.when) : 'â€”'}</td>
      <td>${o.id || 'â€”'}</td>
      <td>${o.name || 'â€”'}</td>
      <td>${o.phone || 'â€”'}</td>
      <td>${o.slot ? hhmm(o.slot) : 'â€”'}</td>
      <td>${pizzas||'â€”'}</td>
      <td>${euro(o.total)}</td>
      <td><span class="status ${o.status||'new'}">${o.status||'new'}</span></td>
      <td class="actions">
        <button class="btn small" data-act="ready">PrÃªte</button>
        <button class="btn small" data-act="done">TerminÃ©e</button>
        <button class="btn small" data-act="canceled">Annuler</button>
        <button class="btn small red" data-act="delete">Supprimer</button>
      </td>
    `;
    // actions
    tr.querySelectorAll('button[data-act]').forEach(b=>{
      b.onclick = async () => {
        try{
          const act = b.getAttribute('data-act');
          if(act === 'delete'){
            if(!confirm('Supprimer cette commande ?')) return;
            await apiPost({action:'delete', id:o.id, adminkey:pref.adminkey});
          }else{
            await apiPost({action:'status', id:o.id, status:act, adminkey:pref.adminkey});
          }
          await refreshNow(true);
        }catch(err){ showErr('Action Ã©chouÃ©e', String(err)); }
      };
    });
    tb.appendChild(tr);
  }
}

/*** rafraÃ®chissement ***/
let lastIds=new Set();
async function refreshNow(manual=false){
  if(!pref.api){ $('#net').textContent='URL API manquante'; return; }
  try{
    $('#net').textContent='Chargementâ€¦';
    const orders = await apiGetList();
    render(orders);

    // son si nouvelle(s) commande(s)
    const ids = new Set(orders.map(o=>o.id));
    const hasNew = [...ids].some(id => !lastIds.has(id));
    lastIds = ids;
    if(hasNew && pref.snd && bell){
      // jouer seulement si lâ€™utilisateur a dÃ©jÃ  interagi
      try{ await bell.play(); }catch(_){}
    }
    $('#net').textContent = new Date().toLocaleTimeString('fr-FR')+' â€” OK';
  }catch(err){
    $('#net').textContent='Erreur rÃ©seau';
    showErr(err.message);
  }
}

/*** init ***/
function init(){
  // UI init
  $('#api').value = pref.api||'';
  $('#adm').value = pref.adminkey||'';
  $('#snd').checked = !!pref.snd;
  $('#vol').value = pref.vol ?? .8;

  // events
  $('#save').onclick = () => {
    pref.api = $('#api').value.trim();
    pref.adminkey = $('#adm').value.trim();
    store.write(pref);
    $('#net').textContent='ParamÃ¨tres enregistrÃ©s';
  };
  $('#refresh').onclick = () => refreshNow(true);
  $('#snd').onchange = ()=>{ pref.snd = $('#snd').checked; store.write(pref); };
  $('#vol').oninput  = ()=>{ pref.vol = Number($('#vol').value)||.8; if(bell) bell.volume = pref.vol; store.write(pref); };

  // bell
  bell = new Audio('https://cdn.jsdelivr.net/gh/maphna/tinyfiles@master/chime.mp3');
  bell.volume = pref.vol ?? .8;
  // dÃ©verrouiller l'audio aprÃ¨s 1Ã¨re interaction
  const unlock = ()=>{ if(unlocked) return; bell.play().then(()=>{ unlocked=true; }).catch(()=>{}); window.removeEventListener('click', unlock); };
  window.addEventListener('click', unlock);

  // premier chargement + polling toutes les 5 s
  refreshNow(true);
  setInterval(refreshNow, 5000);
}

/*** sÃ©curitÃ© globale ***/
window.addEventListener('error', e=>showErr(e.message, (e.error&&e.error.stack)||''));
window.addEventListener('unhandledrejection', e=>showErr('Promise rejetÃ©e: '+(e.reason&&e.reason.message||e.reason)));

// go!
init();
</script>
</body>
</html>
