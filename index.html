<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dashboard — PIZZ’AMIGO</title>
<style>
  :root{--bg:#0b0f14;--panel:#101722;--line:#283149;--muted:#b8c2d6;--green:#1fcf7c;--red:#e55252;--accent:#ffb54c}
  *{box-sizing:border-box} html,body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:#fff}
  .wrap{max-width:1060px;margin:20px auto;padding:0 12px}
  h1{margin:4px 0 12px;font-size:26px}
  .box{border:1px solid var(--line);border-radius:14px;padding:10px;background:#0f1622}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  input[type=text]{background:#0e1420;border:1px solid var(--line);color:#fff;border-radius:10px;padding:8px 10px;min-width:260px}
  button{border:1px solid rgba(255,255,255,.25);background:#162235;color:#fff;border-radius:999px;padding:8px 12px;cursor:pointer}
  button.primary{background:var(--green);color:#001b10;border-color:transparent}
  button.red{color:#ffb4b4;border-color:#ff8b8b}
  .tbl{width:100%;border-collapse:collapse;margin-top:10px}
  .tbl th,.tbl td{border-bottom:1px dashed #24304a;padding:8px 10px;text-align:left}
  .pill{display:inline-flex;gap:6px;align-items:center;border:1px solid #2a3856;border-radius:999px;padding:3px 8px;font-size:.9rem}
  .status{opacity:.8}
  .muted{color:var(--muted)}
  /* mobile */
  @media (max-width:720px){
    .tbl th:nth-child(3), .tbl td:nth-child(3){display:none} /* client tel */
    .tbl th:nth-child(6), .tbl td:nth-child(6){display:none} /* pizzas détaillées restent mais on conserve total */
    input[type=text]{min-width:100%}
  }
  /* panneau erreur JS */
  #err{position:fixed;right:8px;bottom:8px;max-width:92vw;background:#2a1b1b;border:1px solid #5d2f2f;border-radius:10px;padding:10px 12px;display:none;z-index:999}
  #err pre{white-space:pre-wrap;margin:6px 0 0 0;color:#ffd1d1}
</style>
</head>
<body>
<div class="wrap">
  <h1>Dashboard — PIZZ’AMIGO</h1>

  <div class="box">
    <div class="row">
      <input id="api" type="text" placeholder="URL de l’API (…/exec)" />
      <input id="adm" type="text" placeholder="Clé admin (facultatif)" />
      <button id="btnSave">Enregistrer</button>
      <button id="btnRefresh">Actualiser</button>
      <button id="btnDemo">Démo</button>
      <span id="status" class="muted"></span>
    </div>
  </div>

  <div class="box" style="margin-top:10px">
    <table class="tbl" id="tbl">
      <thead>
        <tr>
          <th>Heure</th><th>ID</th><th>Client</th><th>Téléphone</th><th>Horaire</th><th>Pizzas</th><th>Total</th><th>Statut</th><th>Action</th>
        </tr>
      </thead>
      <tbody id="body"></tbody>
    </table>
  </div>
</div>

<!-- Panneau erreurs -->
<div id="err"><b>Erreur JavaScript</b><pre id="err-msg"></pre></div>

<audio id="bell" preload="auto">
  <source src="https://assets.mixkit.co/active_storage/sfx/2850/2850-preview.mp3" type="audio/mpeg">
</audio>

<script>
/* ===== util erreurs ===== */
function showErr(msg){const b=document.getElementById('err');b.style.display='block';document.getElementById('err-msg').textContent=msg;}
window.addEventListener('error', e=>showErr(e.message+'\n'+(e.error&&e.error.stack||'')));
window.addEventListener('unhandledrejection', e=>showErr('Promise rejetée: '+(e.reason&&e.reason.message||e.reason)));

/* ===== storage cfg ===== */
const LS_KEY = 'pizzamigo.cfg';
function loadCfg(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||'{}'); }catch{ return {}; } }
function saveCfg(v){ localStorage.setItem(LS_KEY, JSON.stringify(v)); }
const cfg = loadCfg();
const $api = document.getElementById('api');
const $adm = document.getElementById('adm');
$api.value = cfg.api||'';
$adm.value = cfg.adm||'';

function setStatus(t){ document.getElementById('status').textContent = t; }
function getApi(){ return document.getElementById('api').value.trim(); }
function getAdminKey(){ return document.getElementById('adm').value.trim(); }

/* ===== helpers ===== */
const euro = v => (Number(v)||0).toFixed(2).replace('.', ',') + ' €';
function fmtTime(hhmm){ // "19:30" ou date
  try{
    if (typeof hhmm === 'string' && /^\d{2}:\d{2}$/.test(hhmm)) return hhmm;
    const d = new Date(hhmm);
    const h = String(d.getHours()).padStart(2,'0');
    const m = String(d.getMinutes()).padStart(2,'0');
    return `${h}:${m}`;
  }catch{ return String(hhmm||''); }
}

/* ===== rendu tableau (sans effacer l’existant) ===== */
const rows = new Map(); // id => DOM <tr>

function renderOrders(list){
  const body = document.getElementById('body');
  list.forEach(o=>{
    const id = o.id || o.ID || o.Id || o.code || '';
    let tr = rows.get(id);
    const pizzas = Array.isArray(o.items) ? o.items.map(i=>{
      const s = (i.supplType && i.supplPrice) ? ` (+${i.supplPrice}€ ${i.supplType})` : '';
      return `${i.name || i.item || ''} × ${i.qty || i.q || 1}${s}`;
    }).join('<br>') : (o.pizzas || o.basket || '');
    const total = o.total || o.amount || 0;
    const status = o.status || o.statut || 'nouvelle';
    const when = o.when || o.date || '';
    const slot = fmtTime(o.slot || o.horaire || '');

    if(!tr){
      tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="when"></td>
        <td class="id"></td>
        <td class="name"></td>
        <td class="phone"></td>
        <td class="slot"></td>
        <td class="pizzas"></td>
        <td class="total"></td>
        <td class="status"></td>
        <td class="act"></td>`;
      body.prepend(tr);
      rows.set(id, tr);
    }
    tr.querySelector('.when').textContent = when ? String(when).slice(11,19) : '';
    tr.querySelector('.id').textContent = id;
    tr.querySelector('.name').textContent = o.name || o.client || '';
    tr.querySelector('.phone').textContent = o.phone || '';
    tr.querySelector('.slot').textContent = slot;
    tr.querySelector('.pizzas').innerHTML = pizzas;
    tr.querySelector('.total').textContent = euro(total);
    tr.querySelector('.status').innerHTML = `<span class="pill">${status}</span>`;
    tr.querySelector('.act').innerHTML = `
      <button class="small" data-a="ready"  data-id="${id}">Prête</button>
      <button class="small" data-a="done"   data-id="${id}">Terminée</button>
      <button class="small red" data-a="cancel" data-id="${id}">Annuler</button>
      <button class="small" data-a="delete" data-id="${id}">✖</button>`;
  });

  // actions
  document.querySelectorAll('[data-a]').forEach(btn=>{
    btn.onclick = async ()=>{
      const id = btn.getAttribute('data-id');
      const act = btn.getAttribute('data-a');

      if (act === 'delete'){ // suppression uniquement côté affichage (volontaire)
        const tr = rows.get(id);
        if (tr){ tr.remove(); rows.delete(id); }
        return;
      }

      try{
        const api = getApi();
        const admin = getAdminKey();
        const res = await fetch(api, {
          method:'POST',
          headers:{'Content-Type':'text/plain;charset=utf-8'},
          body: JSON.stringify({ admin, action: act, id })
        });
        const txt = await res.text();
        let ok=false; try{ok=!!(JSON.parse(txt).ok);}catch{ ok=/^(ok|true)$/i.test(txt.trim()); }
        if(!res.ok && !ok) return alert('Échec de mise à jour du statut.\nHTTP '+res.status+'\n'+(txt||'(réponse vide)'));
        setStatus(new Date().toLocaleTimeString('fr-FR')+' — statut: OK');
      }catch(err){
        alert('Échec de mise à jour du statut.\n'+String(err));
      }
    };
  });
}

/* ===== fetch list ===== */
async function fetchOrders(){
  const api = getApi();
  const url = api.replace(/\/exec.*/,'/exec') + '?list=1'; // ton Apps Script doit répondre avec les commandes du jour
  const r = await fetch(url, {method:'GET'});
  const txt = await r.text();
  let data=[]; try{
    const j = JSON.parse(txt);
    data = j.orders || j.data || j || [];
  }catch{
    data = [];
  }
  return Array.isArray(data) ? data : [];
}
async function refreshOnce(){
  try{
    setStatus('Chargement…');
    const list = await fetchOrders();
    const before = rows.size;
    renderOrders(list);
