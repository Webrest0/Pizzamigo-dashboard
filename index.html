<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Dashboard — PIZZ’AMIGO</title>
<style>
  :root{--bg:#0b0f14;--panel:#101722;--line:#283149;--muted:#b8c2d6;--green:#1fcf7c;--red:#e55252}
  *{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:#fff;font-family:system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:1200px;margin:0 auto;padding:14px}
  h1{margin:6px 0 10px}
  .bar{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:10px}
  .bar .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  input{background:#0e1420;color:#fff;border:1px solid var(--line);border-radius:8px;padding:8px 10px;min-width:260px}
  .btn{border:1px solid #666;background:transparent;color:#fff;border-radius:8px;padding:8px 10px;cursor:pointer}
  .btn.primary{background:var(--green);color:#001b10;border-color:transparent}
  .btn.red{background:var(--red);border-color:transparent}
  .muted{color:var(--muted)}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left;font-size:14px}
  th{background:#0f1521;position:sticky;top:0;z-index:2}
  tr:nth-child(even){background:#121a27}
  .actions .btn{padding:6px 8px;margin:2px;font-size:13px}

  /* Mobile responsive table */
  @media(max-width:760px){
    table, thead, tbody, th, td, tr{display:block}
    thead{display:none}
    tbody tr{margin:10px 0;border:1px solid var(--line);border-radius:10px;overflow:hidden}
    td{border:none;border-bottom:1px solid var(--line);position:relative;padding-left:45%}
    td:last-child{border-bottom:none}
    td::before{position:absolute;left:8px;top:10px;width:40%;white-space:nowrap;color:#9ec7ff;font-weight:700}
    td:nth-of-type(1)::before{content:"Heure";}
    td:nth-of-type(2)::before{content:"ID";}
    td:nth-of-type(3)::before{content:"Client";}
    td:nth-of-type(4)::before{content:"Téléphone";}
    td:nth-of-type(5)::before{content:"Horaire";}
    td:nth-of-type(6)::before{content:"Pizzas";}
    td:nth-of-type(7)::before{content:"Total";}
    td:nth-of-type(8)::before{content:"Statut";}
    td:nth-of-type(9)::before{content:"Action";}
  }
</style>
</head>
<body>
<div class="wrap">
  <h1>Dashboard — PIZZ’AMIGO</h1>

  <div class="bar">
    <div class="row">
      <label class="muted">API :</label>
      <input id="api" />
      <label class="muted">Clé admin (facultatif) :</label>
      <input id="adminkey" placeholder="ex: PIZZAMIGO-ADMIN-123"/>
      <button class="btn" onclick="saveCfg()">Enregistrer</button>
      <button class="btn" onclick="loadOrders()">Actualiser</button>
      <button class="btn primary" onclick="demoOrder()">Démo</button>
    </div>
    <div id="status" class="muted" style="margin-top:6px"></div>
  </div>

  <table id="orders">
    <thead>
      <tr><th>Heure</th><th>ID</th><th>Client</th><th>Téléphone</th><th>Horaire</th><th>Pizzas</th><th>Total</th><th>Statut</th><th>Action</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- son court, propre -->
<audio id="ding" preload="auto">
  <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
</audio>

<script>
const LSKEY="pizzapi", LSADM="pizzadm";
const DEFAULT_API="https://script.google.com/macros/s/AKfycbyePXcqPFPs0uhNOcVM5J5Nq3LCgsrB9UKVOmit1HVoTBzCdZRDCxEntrydbXSyQMXu/exec";

api.value = localStorage.getItem(LSKEY) || DEFAULT_API;
adminkey.value = localStorage.getItem(LSADM) || "";

function saveCfg(){
  localStorage.setItem(LSKEY, api.value.trim());
  localStorage.setItem(LSADM, adminkey.value.trim());
  alert("Config enregistrée.");
}

async function loadOrders(){
  try{
    status.textContent="Chargement…";
    const res = await fetch(api.value + "?t=" + Date.now());
    const data = await res.json();
    if(!data.ok) throw new Error(data.error||"API");
    renderOrders(data.orders||[]);
    status.textContent = "Dernière mise à jour — " + new Date().toLocaleTimeString("fr-FR");
  }catch(e){
    status.textContent="Erreur: "+e.message;
    console.error(e);
  }
}

function renderOrders(orders){
  const tb = document.querySelector("#orders tbody");
  const before = tb.childElementCount;
  tb.innerHTML="";

  orders.forEach(o=>{
    const items = (o.basket || o.items || []).map(i=>(i.name||i.n)+" x"+i.qty).join(", ");
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${o.when||""}</td>
      <td>${o.id||""}</td>
      <td>${o.name||""}</td>
      <td>${o.phone||""}</td>
      <td>${o.slot||""}</td>
      <td>${items}</td>
      <td>${(Number(o.total)||0).toFixed(2)} €</td>
      <td>${o.status||""}</td>
      <td class="actions">
        <button class="btn" onclick="setStatus('${o.id}','ready')">Prête</button>
        <button class="btn primary" onclick="setStatus('${o.id}','done')">Terminée</button>
        <button class="btn red" onclick="setStatus('${o.id}','canceled')">Annuler</button>
      </td>`;
    tb.appendChild(tr);
  });

  // ding si nouvelle commande affichée
  if(orders.length > before){ try{ document.getElementById("ding").play(); }catch{} }
}

async function setStatus(id,statusNew){
  try{
    await fetch(api.value, {
      method:"POST",
      headers:{"Content-Type":"text/plain;charset=utf-8"},
      body: JSON.stringify({ admin: adminkey.value||"", id, status: statusNew })
    });
    loadOrders();
  }catch(e){ alert("Erreur: "+e.message); }
}

function demoOrder(){
  const demo = {
    id:"DEMO-"+Math.random().toString(36).slice(2,6).toUpperCase(),
    when: new Date().toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"}),
    name:"Test JSONP", phone:"06 00 00 00 00", slot:"19:00",
    basket:[{name:"Margharita",qty:1}], total:7.50, status:"new"
  };
  renderOrders([demo]);
  status.textContent = "Démo ajoutée";
}

loadOrders();
setInterval(loadOrders, 10000);
</script>
</body>
</html>
