<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Dashboard â€” PIZZâ€™AMIGO</title>
<style>
  :root{
    --bg:#0b0f14;--panel:#101722;--line:#283149;--muted:#b8c2d6;
    --green:#1fcf7c;--red:#e55252;--white:#ffffff;--accent:#ffb54c;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:#fff;font-family:system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:1100px;margin:16px auto;padding:0 12px}

  h1{margin:0 0 12px;font-size:32px;letter-spacing:.4px}

  .bar{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:10px 12px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .inp,.btn,.pill{border-radius:12px;border:1px solid var(--line);background:#0e1420;color:#fff}
  .inp{padding:10px 12px;min-width:260px;flex:1}
  .btn{padding:8px 12px;background:#162033;border-color:#2a3655;cursor:pointer}
  .btn.primary{background:var(--green);color:#001b10;border-color:transparent}
  .btn.red{border-color:#ff8b8b;color:#ffb4b4}
  .muted{color:var(--muted)}

  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{border-bottom:1px solid rgba(255,255,255,.08);padding:10px 8px;vertical-align:top;text-align:left}
  th{color:#cdd7ef}
  .status{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:4px 8px;min-width:54px;text-align:center}
  .status[data-s="new"]{background:#18202e}
  .status[data-s="ready"]{background:#13281f;border-color:#1f824e}
  .status[data-s="done"]{background:#1f1f33;border-color:#5050b5}
  .row-actions{display:flex;gap:6px;flex-wrap:wrap}

  #err{position:fixed;right:8px;bottom:8px;max-width:92vw;background:#2a1b1b;border:1px solid #5d2f2f;border-radius:10px;padding:10px 12px;display:none;z-index:999}
  #err pre{white-space:pre-wrap;margin:6px 0 0 0;color:#ffd1d1}

  @media (max-width:720px){
    .wrap{padding:0 8px}
    .inp{min-width:200px}
    /* allÃ¨gement mobile */
    th:nth-child(2),td:nth-child(2){display:none}      /* ID */
    th:nth-child(4),td:nth-child(4){display:none}      /* TÃ©lÃ©phone */
    th:nth-child(7),td:nth-child(7){display:none}      /* Total */
  }
</style>
</head>
<body>
<div class="wrap">
  <h1>Dashboard â€” PIZZâ€™AMIGO</h1>

  <div class="bar">
    <div class="row">
      <input id="api" class="inp" placeholder="URL de lâ€™API (Google Apps Script)">
      <input id="adm" class="inp" placeholder="ClÃ© admin (facultatif)">
    </div>
    <div class="row" style="margin-top:8px">
      <button id="save" class="btn">Enregistrer</button>
      <button id="refresh" class="btn">Actualiser</button>
      <span id="net" class="muted" style="margin-left:auto">â€”</span>
    </div>
    <div class="row" style="margin-top:8px">
      <label class="pill" style="display:flex;align-items:center;gap:8px;padding:8px 10px;">
        <span>ðŸ”” Activer le son</span>
        <input id="snd" type="checkbox" style="accent-color:#1fcf7c">
      </label>
      <span>Son :</span>
      <input id="vol" type="range" min="0" max="1" step="0.01" value="0.85" style="flex:1">
    </div>
  </div>

  <table>
    <thead>
      <tr>
        <th>Heure</th>
        <th>ID</th>
        <th>Client</th>
        <th>TÃ©lÃ©phone</th>
        <th>Horaire</th>
        <th>Pizzas</th>
        <th>Total</th>
        <th>Statut</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="rows"></tbody>
  </table>
</div>

<!-- Panneau erreurs (anti page blanche) -->
<div id="err"><b>Erreur JavaScript</b><pre id="err-msg"></pre></div>

<script>
/* ===== util ===== */
function showErr(e){
  const box=document.getElementById('err');
  const msg=(e && (e.message||e.statusText)) || String(e);
  box.style.display='block';
  document.getElementById('err-msg').textContent=msg;
}
window.addEventListener('error', e=>showErr(e.error||e.message||e));
window.addEventListener('unhandledrejection', e=>showErr(e.reason||e));

const S = { list:[], known:new Set(), bell:null, pollMs:12000 };
const euro = v => (Number(v)||0).toFixed(2).replace('.',',')+' â‚¬';
const hhmm = v => {
  if (typeof v==='string' && /^\d{1,2}:\d{2}$/.test(v)) return v;
  const d = new Date(v); return isNaN(+d) ? '' : d.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'});
};
const store = {
  k:'PZ_DASH_PREFS',
  read(){ try{return JSON.parse(localStorage.getItem(this.k)||'{}')}catch{return{}} },
  write(o){ localStorage.setItem(this.k, JSON.stringify(o)); }
};
const apiURL  = ()=> document.getElementById('api').value.trim();
const adminKey= ()=> document.getElementById('adm').value.trim();

/* Ajoute proprement un query ?x=y ou &x=y */
function withQuery(u,q){ return u + (u.includes('?')?'&':'?') + q; }

/* GET liste jour */
async function apiList(){
  const url = withQuery(apiURL(), 'list=1');
  const res = await fetch(url, {cache:'no-store'});
  const txt = await res.text();
  try{ return JSON.parse(txt); }catch{ throw new Error('RÃ©ponse non JSON: '+txt.slice(0,120)); }
}

/* POST action */
async function apiPost(payload){
  const res = await fetch(apiURL(), {
    method:'POST',
    headers:{'Content-Type':'text/plain;charset=utf-8'},
    body: JSON.stringify(payload)
  });
  const txt = await res.text();
  try{ return JSON.parse(txt); }catch{ throw new Error('RÃ©ponse non JSON: '+txt.slice(0,120)); }
}

/* ===== rendu ===== */
function render(){
  const tb = document.getElementById('rows');
  tb.innerHTML = '';
  for(const o of S.list){
    const tr = document.createElement('tr');

    const items = (o.basket||o.items||[]).map(it=>{
      const s = it.supplType ? ` (+1â‚¬ ${it.supplType})` : '';
      return `${it.name} Ã— ${it.qty||1}${s}`;
    }).join('<br>');

    tr.innerHTML = `
      <td>${o.when||''}</td>
      <td>${o.id||''}</td>
      <td>${o.name||''}</td>
      <td>${o.phone||''}</td>
      <td>${hhmm(o.slot||'')}</td>
      <td>${items}</td>
      <td>${euro(o.total)}</td>
      <td><span class="status" data-s="${o.status||'new'}">${o.status||'new'}</span></td>
      <td class="row-actions"></td>
    `;

    const act = tr.querySelector('.row-actions');
    [
      ['ready','PrÃªte'],
      ['done','TerminÃ©e'],
      ['canceled','Annuler']
    ].forEach(([status,label])=>{
      const b=document.createElement('button');
      b.className='btn';
      b.textContent=label;
      b.onclick=()=>updateStatus(o.id,status);
      act.appendChild(b);
    });

    const del=document.createElement('button');
    del.className='btn red';
    del.textContent='Supprimer';
    del.onclick=()=>deleteOrder(o.id);
    act.appendChild(del);

    tb.appendChild(tr);
  }
}

/* ===== actions ===== */
async function refreshNow(){
  try{
    document.getElementById('net').textContent='Chargementâ€¦';
    const data = await apiList();
    const orders = data.orders||[];

    // dÃ©tection des nouvelles commandes (son)
    const incoming = [];
    for(const o of orders){
      if(!S.known.has(o.id)){ incoming.push(o.id); S.known.add(o.id); }
    }
    if(incoming.length && document.getElementById('snd').checked) ring();

    S.list = orders;
    render();
    document.getElementById('net').textContent =
      new Date().toLocaleTimeString('fr-FR')+' â€” OK';
  }catch(err){
    showErr(err);
    document.getElementById('net').textContent='Erreur rÃ©seau';
  }
}

async function updateStatus(id,status){
  try{
    await apiPost({action:'status', id, status, adminKey:adminKey()});
    refreshNow();
  }catch(err){ showErr(err); alert("Ã‰chec de mise Ã  jour du statut."); }
}

async function deleteOrder(id){
  if(!confirm("Supprimer cette commande ?")) return;
  try{
    await apiPost({action:'delete', id, adminKey:adminKey()});
    // enlever localement pour feedback instantanÃ©
    S.list = S.list.filter(o=>o.id!==id);
    render();
  }catch(err){ showErr(err); alert("Suppression impossible."); }
}

/* ===== sonnerie ===== */
function ring(){
  if(!S.bell){
    S.bell = new Audio("https://cdn.jsdelivr.net/gh/naptha/tinyfiles@master/chime.mp3"); // cloche courte
  }
  S.bell.volume = Number(document.getElementById('vol').value||'0.85');
  // Sur certains navigateurs il faut une interaction utilisateur prÃ©alable
  S.bell.play().catch(()=>{ /* ignore */ });
}

/* ===== init ===== */
function init(){
  const pref = store.read();
  document.getElementById('api').value = pref.api||'';
  document.getElementById('adm').value = pref.adm||'';
  document.getElementById('snd').checked = !!pref.snd;
  document.getElementById('vol').value = pref.vol ?? 0.85;

  document.getElementById('save').onclick = () => {
    store.write({
      api: apiURL(),
      adm: adminKey(),
      snd: document.getElementById('snd').checked,
      vol: document.getElementById('vol').value
    });
    document.getElementById('net').textContent = 'ParamÃ¨tres enregistrÃ©s';
  };
  document.getElementById('refresh').onclick = refreshNow;

  // Sauvegarde auto des prÃ©fÃ©rences
  document.getElementById('snd').onchange =
  document.getElementById('vol').oninput = () => {
    const p = store.read();
    store.write({...p, snd:document.getElementById('snd').checked, vol:document.getElementById('vol').value});
  };

  // Premier chargement + polling
  refreshNow();
  setInterval(refreshNow, S.pollMs);
}
init();
</script>
</body>
</html>
