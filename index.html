<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Dashboard â€” PIZZâ€™AMIGO</title>
<style>
  :root{--bg:#0b0f14;--panel:#101722;--line:#283149;--muted:#b8c2d6;--green:#1fcf7c;--red:#e55252}
  *{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:#fff;font-family:system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:1100px;margin:18px auto;padding:0 14px}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:12px}
  h1{margin:4px 0 12px 0}
  input,button{font:inherit}
  input[type=text]{width:100%;border:1px solid var(--line);background:#0e1420;color:#fff;border-radius:10px;padding:10px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{border:1px solid rgba(255,255,255,.25);background:#1a2333;color:#fff;border-radius:999px;padding:8px 12px;cursor:pointer}
  .btn.primary{background:var(--green);color:#001b10;border:none}
  .btn.red{border-color:#ff8b8b;color:#ffb4b4}
  .muted{color:var(--muted)}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border-top:1px solid rgba(255,255,255,.08);padding:8px 10px;vertical-align:middle}
  th{font-weight:700;text-align:left}
  .tag{padding:3px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.25)}
  .tag.new{background:#233048}
  .price{white-space:nowrap}
  .actions .btn{padding:6px 10px}
  .badge{display:inline-flex;gap:6px;align-items:center}
  .dot{width:8px;height:8px;border-radius:50%;background:#36d36a;box-shadow:0 0 6px #36d36a}
  /* Mobile */
  @media (max-width:740px){
    .hide-sm{display:none}
    table{font-size:14px}
    .actions .btn{padding:6px 8px}
  }
  /* panneau erreurs */
  #err{position:fixed;right:8px;bottom:8px;max-width:92vw;background:#2a1b1b;border:1px solid #5d2f2f;border-radius:10px;padding:10px 12px;display:none;z-index:999}
  #err pre{white-space:pre-wrap;margin:6px 0 0 0;color:#ffd1d1}
</style>
</head>
<body>
<div class="wrap">
  <h1>Dashboard â€” PIZZâ€™AMIGO</h1>

  <div class="card">
    <div class="row">
      <input id="api" type="text" placeholder="URL de lâ€™API Google Apps Script">
      <input id="adm" type="text" placeholder="ClÃ© admin (facultatif)">
    </div>
    <div class="row" style="margin-top:8px">
      <button class="btn" id="save">Enregistrer</button>
      <button class="btn" id="refresh">Actualiser</button>
      <button class="btn" id="demo">DÃ©mo</button>
      <span class="muted" id="status">â€“</span>
      <span class="badge" style="margin-left:auto">
        <button class="btn" id="soundBtn">ðŸ”” Activer le son</button>
        <label class="muted">Son :</label>
        <input type="range" min="0" max="1" step="0.05" id="vol" value="0.7" style="width:120px">
      </span>
    </div>
  </div>

  <div class="card" style="margin-top:12px;overflow:auto">
    <table id="tbl">
      <thead>
        <tr>
          <th>Heure</th>
          <th class="hide-sm">ID</th>
          <th class="hide-sm">Client</th>
          <th class="hide-sm">TÃ©lÃ©phone</th>
          <th>Horaire</th>
          <th>Pizzas</th>
          <th>Total</th>
          <th>Statut</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </div>
</div>

<!-- erreurs JS -->
<div id="err"><b>Erreur JavaScript</b><pre id="err-msg"></pre></div>

<script>
/* ===== Anti page blanche ===== */
function showErr(msg){const b=document.getElementById('err');b.style.display='block';document.getElementById('err-msg').textContent=msg;}
window.addEventListener('error', e=>showErr(e.message+'\\n'+(e.error&&e.error.stack||'')));
window.addEventListener('unhandledrejection', e=>showErr('Promise rejetÃ©e: '+(e.reason&&e.reason.message||e.reason)));

/* ===== State ===== */
const S = {
  api: localStorage.getItem('pizz_api') || '',
  adm: localStorage.getItem('pizz_adm') || 'PIZZAMIGO-ADMIN-123', // <- mets ici EXACTEMENT la clÃ© cÃ´tÃ© Apps Script
  orders: new Map(), // id -> order
  audioReady:false,
  bell: (() => {
    // bip cloche trÃ¨s court (WebAudio)
    const ctx = new (window.AudioContext||window.webkitAudioContext)();
    const ding = () => {
      const o = ctx.createOscillator(); const g = ctx.createGain();
      o.type='triangle'; o.frequency.value=880; // aigue court
      g.gain.value=0; g.gain.linearRampToValueAtTime(+document.getElementById('vol').value, ctx.currentTime+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.35);
      o.connect(g); g.connect(ctx.destination); o.start(); o.stop(ctx.currentTime+0.35);
    };
    return {ctx, play:ding};
  })()
};

document.getElementById('api').value = S.api;
document.getElementById('adm').value = S.adm;

/* ===== Helpers ===== */
const â‚¬ = v => Number(v).toFixed(2).replace('.', ',')+' â‚¬';
const fmtTime = iso => {
  // accepte "19:30" ou Date-like; sors "19:30"
  if (!iso) return '';
  if (/^\d{2}:\d{2}$/.test(iso)) return iso;
  try{ const d = new Date(iso); return String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0'); }
  catch{ return String(iso); }
};

function rowHtml(o){
  const items = (o.items||o.basket||[]).map(it=>{
    const sup = it.supplType ? ` (+1â‚¬ ${it.supplType})` : '';
    return `${it.name} Ã— ${it.qty||1}${sup}`;
  }).join('<br>');
  return `
  <tr data-id="${o.id}">
    <td>${o.time||o.when||''}</td>
    <td class="hide-sm">${o.id||''}</td>
    <td class="hide-sm">${o.name||o.client||''}</td>
    <td class="hide-sm">${o.phone||''}</td>
    <td>${fmtTime(o.slot||o.horaire||o.when||'')}</td>
    <td>${items||'-'}</td>
    <td class="price">${â‚¬(o.total||o.total11||0)}</td>
    <td><span class="tag new">${o.status||'new'}</span></td>
    <td class="actions">
      <button class="btn" data-act="ready">PrÃªte</button>
      <button class="btn" data-act="done">TerminÃ©e</button>
      <button class="btn red" data-act="cancel">Annuler</button>
      <button class="btn" data-act="remove">Ã—</button>
    </td>
  </tr>`;
}

/* ===== Rendering ===== */
function upsertRows(list){
  const body = document.getElementById('rows');
  let added = 0;
  list.forEach(o=>{
    if(!S.orders.has(o.id)){
      S.orders.set(o.id, o);
      body.insertAdjacentHTML('afterbegin', rowHtml(o));
      added++;
    }
  });
  if(added>0 && S.audioReady) S.bell.play();
}

/* ===== API calls ===== */
async function apiGet(params){
  const u = new URL(S.api);
  Object.entries(params||{}).forEach(([k,v])=>u.searchParams.set(k,v));
  const r = await fetch(u, {method:'GET', cache:'no-store'});
  const t = await r.text();
  try{ return JSON.parse(t); } catch{ throw new Error(t); }
}

async function apiPost(obj){
  // IMPORTANT: text/plain pour Ã©viter CORS des Apps Script
  const r = await fetch(S.api, {
    method:'POST',
    headers:{'Content-Type':'text/plain;charset=utf-8'},
    body: JSON.stringify(obj)
  });
  const t = await r.text();
  try{ return JSON.parse(t); } catch{ throw new Error(t); }
}

/* ===== Actions ===== */
async function refreshNow(){
  if(!S.api){ alert('Renseigne lâ€™URL de lâ€™API.'); return; }
  try{
    const data = await apiGet({list:'today'});
    if(!data.ok) throw new Error(data.error||'RÃ©ponse invalide');
    upsertRows(data.orders||[]);
    document.getElementById('status').textContent = new Date().toTimeString().slice(0,8)+' â€” OK';
  }catch(e){
    document.getElementById('status').textContent = 'Erreur rÃ©seau';
    showErr(String(e));
  }
}

async function sendDemo(){
  if(!S.api){ alert('Renseigne lâ€™URL de lâ€™API.'); return; }
  try{
    const demo = {
      adminKey: S.adm,          // <-- vÃ©rifie que Ã§a matche la clÃ© cÃ´tÃ© Apps Script
      demo: true,               // flag cÃ´tÃ© serveur
      name: 'Test JSONP',
      phone: '600000000',
      slot: '19:30',
      items: [{name:'Margharita', qty:1, price:8.50, supplType:'viande', supplPrice:1}],
      total: 8.50,
      source: 'site'
    };
    const res = await apiPost(demo);
    if(!res.ok) throw new Error(res.error||'Ã‰chec envoi dÃ©mo');
    await refreshNow();
  }catch(e){
    alert('Ã‰chec dâ€™envoi de la dÃ©mo.');
    showErr(String(e));
  }
}

function tableClick(e){
  const btn = e.target.closest('button[data-act]'); if(!btn) return;
  const tr = e.target.closest('tr'); const id = tr?.dataset.id; if(!id) return;
  const act = btn.dataset.act;
  if(act==='remove'){ S.orders.delete(id); tr.remove(); return; }
  // changement de statut -> POST
  apiPost({adminKey:S.adm, setStatus:true, id, status: act})
    .then(r=>{
      if(!r.ok) throw new Error(r.error||'setStatus fail');
      tr.querySelector('.tag').textContent = act;
    })
    .catch(err=>showErr(String(err)));
}

/* ===== Polling ===== */
let timer=null;
function startPolling(){ stopPolling(); timer=setInterval(refreshNow, 5000);}
function stopPolling(){ if(timer) clearInterval(timer); }

/* ===== UI wiring ===== */
document.getElementById('save').onclick=()=>{
  S.api = document.getElementById('api').value.trim();
  S.adm = document.getElementById('adm').value.trim()||'PIZZAMIGO-ADMIN-123';
  localStorage.setItem('pizz_api', S.api);
  localStorage.setItem('pizz_adm', S.adm);
  document.getElementById('status').textContent='ParamÃ¨tres enregistrÃ©s';
};
document.getElementById('refresh').onclick=refreshNow;
document.getElementById('demo').onclick=sendDemo;
document.getElementById('tbl').addEventListener('click', tableClick);
document.getElementById('vol').oninput=()=>{}; // volume lu Ã  la volÃ©e
document.getElementById('soundBtn').onclick=async ()=>{
  try{ await S.bell.ctx.resume(); S.audioReady=true; document.getElementById('soundBtn').disabled=true; document.getElementById('soundBtn').textContent='ðŸ”” Son activÃ©'; }
  catch(e){ showErr(String(e)); }
};

/* ===== Boot ===== */
refreshNow(); startPolling();
</script>
</body>
</html>
