<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Dashboard â€” PIZZâ€™AMIGO</title>
<style>
  :root{
    --bg:#0b0f14; --panel:#101722; --line:#283149; --muted:#b8c2d6;
    --green:#1fcf7c; --red:#e55252; --white:#fff; --accent:#ffb54c;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:#fff;font-family:system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:1040px;margin:18px auto;padding:0 14px}

  h1{margin:0 0 12px;font-size:24px}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:12px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  input[type="text"]{flex:1 1 520px;border:1px solid var(--line);background:#0e1420;color:#fff;border-radius:10px;padding:10px;min-width:260px}
  .btn{border:1px solid rgba(255,255,255,.25);background:transparent;color:#fff;border-radius:999px;padding:8px 12px;cursor:pointer}
  .btn.red{border-color:#ff8b8b;color:#ffb4b4}
  .muted{color:var(--muted)}
  .ok{color:var(--green)}
  .err{color:#ff9a9a}

  .vol-wrap{display:flex;align-items:center;gap:10px;margin-left:auto}
  input[type="range"]{width:180px}

  table{width:100%;border-collapse:separate;border-spacing:0 8px}
  thead th{padding:6px 10px;color:#dfe8ff;font-weight:700;text-align:left}
  tbody tr{background:var(--panel);border:1px solid var(--line);border-radius:12px;overflow:hidden}
  tbody td{padding:10px;border-right:1px solid rgba(255,255,255,.04)}
  tbody td:last-child{border-right:none}
  .actions{display:flex;gap:8px;justify-content:flex-end}
  .chip{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:#0f1623}
  .col-n{width:56px;text-align:right;opacity:.9}
  .col-total{width:96px;text-align:right;white-space:nowrap}
  .x{padding:6px 10px;border:1px solid #ff8b8b;color:#ffb4b4;border-radius:999px;background:transparent;cursor:pointer}

  /* cartes sur mobile */
  @media (max-width: 760px){
    table, thead, tbody, th, td, tr{display:block}
    thead{display:none}
    tbody{display:block}
    tbody tr{margin:10px 0;padding:10px}
    tbody td{border:none;padding:6px 0}
    tbody td::before{content:attr(data-label);display:block;font-size:.85rem;color:var(--muted);margin-bottom:2px}
    .actions{justify-content:flex-start}
  }

  /* panneau erreurs */
  #err{position:fixed;right:8px;bottom:8px;max-width:92vw;background:#2a1b1b;border:1px solid #5d2f2f;border-radius:10px;padding:10px 12px;display:none;z-index:999}
  #err pre{white-space:pre-wrap;margin:6px 0 0 0;color:#ffd1d1}
</style>
</head>
<body>
<div class="wrap">
  <h1>Dashboard â€” PIZZâ€™AMIGO</h1>

  <div class="panel">
    <div class="row">
      <input id="api" type="text" placeholder="URL de lâ€™API (â€¦/exec)" value="https://script.google.com/macros/s/AKfycbyePXcqPFPs0uhNOcVM5J5Nq3LCgsrB9UKVOmit1HVoTBzCdZRDCxEntrydbXSyQMXu/exec">
      <button id="save" class="btn">Enregistrer</button>
      <button id="refresh" class="btn">Actualiser</button>

      <div class="vol-wrap">
        <button id="enableAudio" class="btn">ðŸ”” Activer le son</button>
        <label class="muted" for="vol">Volume :</label>
        <input id="vol" type="range" min="0" max="1" step="0.01" value="0.8">
      </div>
    </div>
    <div id="status" class="muted" style="margin-top:8px">â€”</div>
  </div>

  <div class="panel" style="margin-top:12px">
    <table>
      <thead>
        <tr>
          <th class="col-n">#</th>
          <th>Client</th>
          <th>TÃ©lÃ©phone</th>
          <th>HDC</th>
          <th>Horaire</th>
          <th>Pizzas</th>
          <th class="col-total">Total</th>
          <th style="width:80px;text-align:right">Action</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </div>

  <!-- Panneau erreurs -->
  <div id="err"><b>Erreur JavaScript</b><pre id="err-msg"></pre></div>
</div>

<!-- cloche courte -->
<audio id="bell" preload="auto" crossorigin="anonymous">
  <source src="https://cdn.jsdelivr.net/gh/naptha/tinyfiles@master/chime.mp3" type="audio/mpeg">
</audio>

<script>
/* ==== anti page blanche ==== */
function showErr(msg){const p=document.getElementById('err');p.style.display='block';document.getElementById('err-msg').textContent=msg;}
window.addEventListener('error', e=>showErr(e.message+'\\n'+(e.error&&e.error.stack||'')));
window.addEventListener('unhandledrejection', e=>showErr('Promise rejetÃ©e: '+(e.reason&&e.reason.message||e.reason)));

/* ==== Ã©lÃ©ments ==== */
const elApi   = document.getElementById('api');
const elRows  = document.getElementById('rows');
const elStat  = document.getElementById('status');
const elVol   = document.getElementById('vol');
const btnEA   = document.getElementById('enableAudio');
const bellEl  = document.getElementById('bell');

/* ==== Ã©tat ==== */
let SOUND_OK = false;
let LAST_IDS = new Set();     // pour dÃ©tecter les nouvelles commandes
let seq = 0;                  // compteur visible dans la colonne #

/* ==== helpers ==== */
const euro = v => (Number(v)||0).toFixed(2).replace('.', ',') + ' â‚¬';
const nowStr = () => new Date().toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
const api = () => (elApi.value||'').trim();
const ok  = (m) => elStat.innerHTML = `${nowStr()} â€” <span class="ok">${m||'OK'}</span>`;
const err = (m) => elStat.innerHTML = `${nowStr()} â€” <span class="err">${m||'Erreur'}</span>`;

function slotStr(v){
  if(typeof v==='string' && /^\d{2}:\d{2}$/.test(v)) return v.replace(':','h');
  const d = new Date(v); if(!isNaN(d)) return `${String(d.getHours()).padStart(2,'0')}h${String(d.getMinutes()).padStart(2,'0')}`;
  return String(v||'');
}
function orderTs(o){
  return Number(o.ts)|| Date.parse(o.date||o.when||'') || (Date.now());
}
function pizzasStr(o){
  if(Array.isArray(o.items)) {
    return o.items.map(it=>{
      const sup = (it.supplPrice>0) ? ` (+${Number(it.supplPrice).toFixed(0)}â‚¬ ${it.supplType||'suppl.'})` : '';
      return `${it.name} Ã— ${it.qty||1}${sup}`;
    }).join('<br>');
  }
  if(Array.isArray(o.basket)){
    return o.basket.map(it=>{
      const sup = (it.suppl && Number(it.suppl)>0) ? ` (+1â‚¬ ${it.supplType||'suppl.'})` : '';
      return `${it.name} Ã— ${it.qty||1}${sup}`;
    }).join('<br>');
  }
  return o.pizzas||'';
}

/* ==== audio ==== */
function loadPrefs(){
  const u = localStorage.getItem('pza_api'); if(u) elApi.value=u;
  const v = localStorage.getItem('pza_vol'); if(v) elVol.value=v;
  if(localStorage.getItem('pza_sound')==='1'){ SOUND_OK=true; btnEA.style.display='none'; }
  bellEl.volume = Number(elVol.value||0.8);
}
async function enableSound(){
  try{
    await bellEl.play().then(()=>bellEl.pause()).catch(()=>{});
    SOUND_OK = true;
    localStorage.setItem('pza_sound','1');
    btnEA.style.display='none';
    bellEl.currentTime = 0; // prÃªt
  }catch(e){
    alert("Clique encore pour autoriser le son (bloquÃ© par le navigateur).");
  }
}
btnEA.addEventListener('click', enableSound);
elVol.addEventListener('input', ()=>{ bellEl.volume = Number(elVol.value||0.8); localStorage.setItem('pza_vol', elVol.value); });

async function ring(){
  if(!SOUND_OK) return;
  try{
    bellEl.currentTime = 0;
    await bellEl.play();
  }catch(e){
    // si bloquÃ©, on rÃ©affiche le bouton dâ€™activation
    btnEA.style.display='';
    SOUND_OK = false;
  }
}

/* ==== rendu ==== */
function td(label, html){
  const c=document.createElement('td');
  c.setAttribute('data-label', label);
  c.innerHTML = html;
  return c;
}
function render(list){
  // tri: plus rÃ©cente en haut
  list.sort((a,b)=>orderTs(b)-orderTs(a));
  elRows.innerHTML='';
  seq = 0;
  const seenNow = new Set();

  for(const o of list){
    const id = o.id || o.ID || o.code || String(orderTs(o));
    seenNow.add(id);

    const tr = document.createElement('tr');

    tr.appendChild(td('#', String(++seq)));
    tr.appendChild(td('Client', o.name||''));
    tr.appendChild(td('TÃ©lÃ©phone', o.phone||''));
    // HDC = heure dâ€™envoi de la commande (JJ/MM HH:MM)
    const d = new Date(orderTs(o));
    const hdc = d.toLocaleDateString('fr-FR',{day:'2-digit',month:'2-digit'})+' '+d.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'});
    tr.appendChild(td('HDC', hdc));
    // Horaire simple
    tr.appendChild(td('Horaire', slotStr(o.slot||o.horaire||'')));
    tr.appendChild(td('Pizzas', pizzasStr(o)));
    tr.appendChild(td('Total', `<b>${euro(o.total||o.amount||0)}</b>`).classList = 'col-total');

    const act = document.createElement('td'); act.className='actions'; act.setAttribute('data-label','Action');
    const del = document.createElement('button'); del.className='x'; del.textContent='âœ–'; del.title='Retirer de la liste';
    del.onclick = ()=> tr.remove();
    act.appendChild(del);
    tr.appendChild(act);

    elRows.appendChild(tr);
  }

  // son si nouvelles commandes dÃ©tectÃ©es
  let hasNew = false;
  for(const id of seenNow){ if(!LAST_IDS.has(id)) { hasNew=true; break; } }
  LAST_IDS = seenNow;
  if(hasNew) ring();

  ok('OK');
}

/* ==== rÃ©seau ==== */
async function getList(){
  try{
    const url = api(); if(!url) return err('Renseigne lâ€™URL de lâ€™API');
    const r = await fetch(url+'?list=1',{cache:'no-store'});
    const data = await r.json();
    if(!data || data.ok===false) throw new Error(data && data.error || 'RÃ©ponse invalide');
    render(Array.isArray(data.orders)?data.orders:data.data||[]);
  }catch(e){ console.error(e); err('Erreur rÃ©seau'); }
}

/* ==== hooks ==== */
document.getElementById('refresh').onclick = getList;
document.getElementById('save').onclick = ()=>{ localStorage.setItem('pza_api', api()); ok('ParamÃ¨tres enregistrÃ©s'); };

/* ==== init ==== */
loadPrefs();
getList();
setInterval(getList, 10000);
</script>
</body>
</html>
