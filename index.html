<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Dashboard — PIZZ’AMIGO</title>
<style>
  :root{
    --bg:#0b0f14;--panel:#101722;--line:#273144;--muted:#b8c2d6;
    --green:#1fcf7c;--red:#e55252;--amber:#ffb54c;--white:#fff;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:#fff;font-family:system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:1050px;margin:18px auto;padding:0 14px}
  h1{margin:0 0 12px;font-size:26px;letter-spacing:.2px}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:12px}

  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .toolbar input[type=text]{flex:1 1 380px;min-width:260px;border:1px solid var(--line);background:#0d1421;color:#fff;border-radius:10px;padding:9px 10px}
  .btn{border:1px solid rgba(255,255,255,.25);background:transparent;color:#fff;border-radius:999px;padding:8px 12px;cursor:pointer}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .btn.primary{background:var(--green);color:#002015;border-color:transparent}
  .btn.ghost{opacity:.9}
  .status{font:600 12px/1 system-ui;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.04)}
  .status.new{border-color:#3a4156}
  .status.ready{border-color:#7bdcae;background:rgba(31,207,124,.08);color:#aef2d3}
  .status.done{border-color:#7ea5ff;background:rgba(158,199,255,.08);color:#cfe2ff}
  .status.canceled{border-color:#ff9c9c;background:rgba(229,82,82,.10);color:#ffc8c8}

  .muted{color:var(--muted)}
  .note{font-size:.92rem}

  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border-top:1px solid var(--line);padding:10px 8px;vertical-align:middle}
  th{font-weight:700;text-align:left;color:#dfe7fb}
  td.actions{white-space:nowrap}
  .pill{border:1px solid var(--line);border-radius:999px;padding:6px 10px;margin:2px;display:inline-block;cursor:pointer}
  .pill.red{border-color:#ff8f8f;color:#ffb3b3}
  .pill.primary{background:var(--green);border-color:transparent;color:#002015}
  .time{white-space:nowrap}

  /* mobile */
  @media (max-width:720px){
    th:nth-child(3),td:nth-child(3){display:none;} /* client */
    th:nth-child(4),td:nth-child(4){display:none;} /* phone */
    th:nth-child(8),td:nth-child(8){display:none;} /* total */
  }

  /* panneau erreur */
  #err{position:fixed;right:8px;bottom:8px;max-width:92vw;background:#2a1b1b;border:1px solid #5d2f2f;border-radius:10px;padding:10px 12px;display:none;z-index:999}
  #err pre{white-space:pre-wrap;margin:6px 0 0 0;color:#ffd1d1}
</style>
</head>
<body>
<div class="wrap">
  <h1>Dashboard — PIZZ’AMIGO</h1>

  <div class="card">
    <div class="toolbar">
      <input id="api" type="text" placeholder="URL de l’API Apps Script (…/exec)" />
      <input id="adm" type="text" placeholder="Clé admin (facultatif)" style="max-width:260px">
      <button id="save" class="btn">Enregistrer</button>
      <button id="refresh" class="btn">Actualiser</button>
      <button id="demo" class="btn">Démo</button>
      <span id="status" class="note muted">—</span>
    </div>
  </div>

  <div class="card" style="margin-top:10px">
    <table id="tab">
      <thead>
        <tr>
          <th>Heure</th>
          <th>ID</th>
          <th>Client</th>
          <th>Téléphone</th>
          <th>Horaire</th>
          <th>Pizzas</th>
          <th>Total</th>
          <th>Statut</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="rows">
        <tr><td colspan="9" class="muted">Aucune commande pour le moment.</td></tr>
      </tbody>
    </table>
  </div>
</div>

<!-- cloche courte (base64) -->
<audio id="bell" preload="auto">
  <source src="data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAA... (cloche courte encodée) ..." type="audio/mp3">
</audio>

<!-- panneau erreur -->
<div id="err"><b>Erreur JavaScript</b><pre id="err-msg"></pre></div>

<script>
/* ===== util — panneau erreur ===== */
function showErr(msg){const b=document.getElementById('err');b.style.display='block';document.getElementById('err-msg').textContent=msg;}
window.addEventListener('error', e=>showErr(e.message+'\n'+(e.error&&e.error.stack||'')));
window.addEventListener('unhandledrejection', e=>showErr('Promise rejetée: '+(e.reason&&e.reason.message||e.reason)));

/* ===== CONFIG / ÉTAT ===== */
const API_DEFAULT = ""; // <-- vide par défaut : tu colles ton /exec dans le champ (stocké après)
const POLL_MS = 6000;

const st = {
  api: localStorage.getItem('pizz_api') || API_DEFAULT,
  adm: localStorage.getItem('pizz_adm') || "",
  seen: new Map(),        // id -> rowElement (pour ne pas dupliquer)
  lastPing: 0,
  timer: null
};

const $ = s => document.querySelector(s);
const rows = $('#rows');
$('#api').value = st.api;
$('#adm').value = st.adm;
$('#status').textContent = '—';

/* ===== helpers ===== */
function euro(v){ return (Number(v)||0).toFixed(2).replace('.', ',')+' €'; }
function hhmm(x){
  if(!x) return '';
  if(typeof x === 'string'){
    // "19:30" -> tel quel
    const m = x.match(/^(\d{1,2}):(\d{2})/);
    if(m) return (m[1].padStart(2,'0')+':'+m[2]);
  }
  try{
    const d = new Date(x);
    const h = d.getHours().toString().padStart(2,'0');
    const m = d.getMinutes().toString().padStart(2,'0');
    return `${h}:${m}`;
  }catch{ return String(x); }
}
function parseJSONorText(txt){
  try{ return JSON.parse(txt); }catch{ return { ok:/^(ok|true)$/i.test(txt.trim()) }; }
}

/* ===== rendu d’une ligne ===== */
function makeRow(o){
  // o: {id, when, name, phone, slot, basket(JSON), total, status}
  const tr = document.createElement('tr');
  const items = (()=>{ try{ return JSON.parse(o.basket||o.items||'[]'); }catch{ return []; }})();
  const pizzas = items.map(it=>{
    const sup = it.supplType || it.suppl || '';
    const supTxt = sup ? ` (+1€ ${sup})` : '';
    return `${it.name||it.n||'—'} × ${it.qty||1}${supTxt}`;
  }).join('<br>');

  tr.innerHTML = `
    <td class="time">${hhmm(o.when||o.date||o.createdAt)}</td>
    <td>${o.id||''}</td>
    <td>${o.name||''}</td>
    <td>${o.phone||''}</td>
    <td class="time">${hhmm(o.slot||o.pickup||o.time)}</td>
    <td>${pizzas||'—'}</td>
    <td>${euro(o.total)}</td>
    <td class="statCell"></td>
    <td class="actions">
      <button class="pill" data-act="ready">Prête</button>
      <button class="pill" data-act="done">Terminée</button>
      <button class="pill" data-act="canceled">Annuler</button>
      <button class="pill red" data-act="remove">×</button>
    </td>
  `;
  setStatus(tr, (o.status||'new'));
  tr.dataset.id = o.id||'';
  tr.querySelectorAll('button[data-act]').forEach(b=>{
    b.addEventListener('click', ()=>onAction(tr, b.dataset.act));
  });
  return tr;
}
function setStatus(tr, s){
  const c = tr.querySelector('.statCell');
  c.innerHTML = '';
  const b = document.createElement('span');
  b.className = `status ${s}`;
  b.textContent = (s==='ready'?'prête':s==='done'?'terminée':s==='canceled'?'annulée':'nouvelle');
  c.appendChild(b);
}

/* ===== lecture des commandes =====
   GET  API?list=1&admin=XYZ  -> {ok:true, orders:[...]}
*/
async function load(){
  if(!st.api){ $('#status').textContent = 'Renseigne l’URL de l’API'; return; }
  try{
    $('#status').textContent = 'Chargement…';
    const url = new URL(st.api);
    url.searchParams.set('list', '1');
    if(st.adm) url.searchParams.set('admin', st.adm);

    const res = await fetch(url.toString(), {cache:'no-store'});
    const txt = await res.text();
    const data = parseJSONorText(txt);

    if(!res.ok || !data.ok || !Array.isArray(data.orders)){
      $('#status').textContent = 'Erreur réseau';
      console.error('GET list fail', res.status, txt);
      return;
    }

    const orders = data.orders;
    let added = 0;

    // vide le placeholder si on a la première vraie ligne
    if(rows.children.length===1 && rows.firstElementChild?.children?.length===1){
      rows.innerHTML = '';
    }

    for(const o of orders){
      const id = String(o.id||'').trim();
      if(id && !st.seen.has(id)){
        const tr = makeRow(o);
        st.seen.set(id, tr);
        rows.insertBefore(tr, rows.firstChild); // en haut
        added++;
        // son à chaque vraie nouvelle commande (hors refresh)
        try{ document.getElementById('bell').currentTime=0; document.getElementById('bell').play(); }catch{}
      }
    }

    const ts = new Date();
    $('#status').textContent = `${ts.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'})} — OK${added?` (${added} ajoutée${added>1?'s':''})`:''}`;
  }catch(err){
    $('#status').textContent = 'Erreur réseau';
    console.error(err);
  }
}

/* ===== actions =====
   POST API  text/plain(JSON) :
   - démo: {demo:true}
   - maj statut: {id:"...", status:"ready|done|canceled"}
*/
async function onAction(tr, act){
  if(act==='remove'){ tr.remove(); st.seen.delete(tr.dataset.id); return; }

  const id = tr.dataset.id;
  if(!id) return;

  try{
    const payload = { id, status: act, admin: st.adm||undefined };
    const res = await fetch(st.api, { method:'POST', headers:{'Content-Type':'text/plain;charset=utf-8'}, body: JSON.stringify(payload) });
    const ok = parseJSONorText(await res.text()).ok && res.ok;
    if(!ok) throw new Error('POST status non ok');
    setStatus(tr, act);
  }catch(err){
    console.error(err);
    alert("Échec de mise à jour du statut.");
  }
}

/* ===== démo ===== */
async function sendDemo(){
  if(!st.api){ alert("Renseigne l’URL de l’API."); return; }
  try{
    const demo = {
      demo:true,
      admin: st.adm||undefined,
      // valeurs de test côté serveur si besoin
      name:"Test JSONP", phone:"06 00 00 00 00",
      slot:"19:00",
      items:[{name:"Margharita",qty:1,price:7.5}],
      total:7.5, source:"site"
    };

    // essai 1 : text/plain
    let r = await fetch(st.api, {method:'POST', headers:{'Content-Type':'text/plain;charset=utf-8'}, body:JSON.stringify(demo)});
    let ok = parseJSONorText(await r.text()).ok && r.ok;

    // essai 2 : sans header strict
    if(!ok){
      r = await fetch(st.api, {method:'POST', body:JSON.stringify(demo)});
      ok = parseJSONorText(await r.text()).ok && r.ok;
    }

    if(!ok) throw new Error('échec démo');

    // note d’état + son
    $('#status').textContent = 'Démo envoyée — en attente d’affichage…';
  }catch(err){
    console.error(err);
    alert("Échec d’envoi de la démo.");
  }
}

/* ===== wiring ===== */
$('#save').addEventListener('click', ()=>{
  st.api = $('#api').value.trim();
  st.adm = $('#adm').value.trim();
  localStorage.setItem('pizz_api', st.api);
  localStorage.setItem('pizz_adm', st.adm);
  $('#status').textContent = 'Sauvé localement.';
});
$('#refresh').addEventListener('click', load);
$('#demo').addEventListener('click', sendDemo);

/* ===== boucle de poll ===== */
clearInterval(st.timer);
st.timer = setInterval(load, POLL_MS);
load(); // premier chargement
</script>
</body>
</html>
