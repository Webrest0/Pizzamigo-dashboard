<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dashboard â€” PIZZâ€™AMIGO</title>
<style>
  :root{
    --bg:#0b0f14;--panel:#101722;--line:#283149;--muted:#b8c2d6;
    --green:#1fcf7c;--red:#e55252;--white:#ffffff;--accent:#ffb54c;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:#fff;font-family:system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:980px;margin:20px auto;padding:0 14px}

  h1{margin:0 0 14px;font-size:34px;font-weight:900;letter-spacing:.5px}

  .panel{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:12px}
  .cfg{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  input[type="text"]{width:100%;border:1px solid var(--line);background:#0e1420;color:#fff;border-radius:10px;padding:10px}
  .btn{border:1px solid rgba(255,255,255,.25);background:transparent;color:#fff;border-radius:999px;padding:8px 12px;cursor:pointer}
  .btn.primary{background:var(--green);color:#001b10;border-color:transparent}
  .btn.red{border-color:#ff8b8b;color:#ffb4b4}
  .btn.small{padding:6px 10px;font-size:.95rem}

  .state{color:#9fb3d7;font-size:.95rem;text-align:right}
  .bell{display:inline-flex;gap:6px;align-items:center;border:1px solid rgba(255,255,255,.25);border-radius:999px;padding:8px 12px;cursor:pointer}
  .bell.warn{border-color:#e0b84a;color:#ffd07a}
  .vol{flex:1;min-width:120px}

  table{width:100%;border-collapse:collapse;margin-top:14px}
  th,td{border-bottom:1px solid rgba(255,255,255,.1);padding:10px 8px;vertical-align:top}
  th{color:#cfd6e7;text-align:left;font-weight:700}
  td .tag{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--line);background:#0e1420}
  .actions{display:flex;gap:6px;flex-wrap:wrap}
  .muted{color:var(--muted)}
  #err{position:fixed;right:8px;bottom:8px;max-width:92vw;background:#2a1b1b;border:1px solid #5d2f2f;border-radius:10px;padding:10px 12px;display:none;z-index:999}
  #err pre{white-space:pre-wrap;margin:6px 0 0 0;color:#ffd1d1}
  @media (max-width:740px){
    .cfg{grid-template-columns:1fr}
    .state{text-align:left}
    th:nth-child(3), td:nth-child(3){display:none} /* cache colonne Client sur mobile pour respirer */
  }
</style>
</head>
<body>
<div class="wrap">
  <h1>Dashboard â€” PIZZâ€™AMIGO</h1>

  <div class="panel">
    <div class="cfg">
      <div class="row" style="width:100%">
        <input id="api" type="text" placeholder="https://script.google.com/macros/.../exec" />
        <input id="adm" type="text" placeholder="PIZZAMIGO-ADMIN-123" style="max-width:260px" />
        <button id="save" class="btn">Enregistrer</button>
        <button id="refresh" class="btn">Actualiser</button>
      </div>
      <div class="state"><span id="net">â€”</span></div>
    </div>

    <div class="row" style="margin-top:10px">
      <button id="snd" class="bell warn">ðŸ”” Activer le son</button>
      <label class="muted">Son :</label>
      <input id="vol" type="range" class="vol" min="0" max="1" step="0.01" value="0.70" />
    </div>
  </div>

  <div class="panel" style="margin-top:14px">
    <table>
      <thead>
        <tr>
          <th>Heure</th>
          <th>ID</th>
          <th>Client</th>
          <th>TÃ©lÃ©phone</th>
          <th>Horaire</th>
          <th>Pizzas</th>
          <th>Total</th>
          <th>Statut</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="tb"></tbody>
    </table>
  </div>

  <div id="err"><b>Erreur JavaScript</b><pre id="err-msg"></pre></div>
</div>

<script>
  /* ---- Panneau erreur discret ---- */
  function showErr(msg){const b=document.getElementById('err');b.style.display='block';document.getElementById('err-msg').textContent=msg;}
  window.addEventListener('error', e=>showErr(e.message+'\n'+(e.error&&e.error.stack||'')));
  window.addEventListener('unhandledrejection', e=>showErr('Promise rejetÃ©e: '+(e.reason&&e.reason.message||e.reason)));

  /* ---- Helper: force JSON + message clair si HTML ---- */
  async function getJSON(url, opts={}){
    const res = await fetch(url, {cache:'no-store', redirect:'follow', ...opts});
    try { return await res.json(); }
    catch(_) {
      const txt = await res.text();
      throw new Error('RÃ©ponse non JSON: ' + txt.slice(0,200));
    }
  }

  /* ---- State local ---- */
  const store = {
    read(){ try{return JSON.parse(localStorage.getItem('pzadm')||'{}')}catch{return{}} },
    write(v){ localStorage.setItem('pzadm', JSON.stringify(v||{})) }
  };

  let apiURL = '';
  let adminKey = '';
  let bell = null;
  let bellReady = false;
  let lastIds = new Set(); // pour ne sonner quâ€™aux nouvelles commandes

  /* ---- Audio ---- */
  function prepareBell(){
    if (!bell) bell = new Audio('https://cdn.jsdelivr.net/gh/maphdev/tinyfiles@master/chime.mp3');
    bell.volume = Number(document.getElementById('vol').value||'0.7');
    bell.play().then(()=>{ bell.pause(); bell.currentTime=0; bellReady=true; })
                .catch(()=>{ /* besoin dâ€™une interaction dâ€™abord */ });
  }

  /* ---- Rendu tableau ---- */
  function renderList(list){
    const tb = document.getElementById('tb'); tb.innerHTML='';
    const safe = x => (x==null?'':String(x));
    const fmtTime = t => {
      try{ const d=new Date(t); if(!isNaN(d)) return d.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'}); }catch{}
      // fallback si t est dÃ©jÃ  "19:30"
      return safe(t);
    };

    for (const o of list){
      const tr = document.createElement('tr');

      const items = (o.items || o.basket || []).map(it=>{
        const sup = it.supplType ? ` (+1â‚¬ ${it.supplType})` : (it.suppl?' (+1â‚¬)': '');
        return `${it.qty||it.q||1} Ã— ${it.name||it.n||''}${sup}`;
      }).join('<br>');

      tr.innerHTML = `
        <td class="muted">${fmtTime(o.when || o.date || '')}</td>
        <td class="muted">${safe(o.id||'')}</td>
        <td>${safe(o.name||'')}</td>
        <td>${safe(o.phone||'')}</td>
        <td>${fmtTime(o.slot||'')}</td>
        <td>${items||''}</td>
        <td>${(Number(o.total||0)).toFixed(2).replace('.',',')} â‚¬</td>
        <td><span class="tag">${safe(o.status||'new')}</span></td>
        <td class="actions"></td>
      `;

      const act = tr.querySelector('.actions');

      // Boutons statut
      [['ready','PrÃªte'],['done','TerminÃ©e'],['canceled','Annuler']].forEach(([st,label])=>{
        const b = document.createElement('button'); b.className='btn small'; b.textContent=label;
        b.onclick = ()=> updateStatus(o.id, st);
        act.appendChild(b);
      });

      // Supprimer
      const del = document.createElement('button'); del.className='btn small red'; del.textContent='Supprimer';
      del.onclick = ()=> deleteOrder(o.id);
      act.appendChild(del);

      tb.appendChild(tr);
    }
  }

  /* ---- API calls ---- */
  async function refreshNow(){
    if(!apiURL) return;
    document.getElementById('net').textContent='Chargementâ€¦';
    try{
      // ping (facultatif mais utile pour dÃ©tecter les erreurs dâ€™URL)
      await getJSON(apiURL+'?ping=1&ts='+Date.now());

      const data = await getJSON(apiURL+'?list=1&ts='+Date.now());
      const orders = Array.isArray(data.orders)?data.orders : data.data || [];
      renderList(orders);

      // Son sur nouvelles commandes
      const newOnes = orders.filter(o=>!lastIds.has(o.id));
      if(newOnes.length && document.getElementById('snd').dataset.on==='1'){
        if (!bellReady) prepareBell();
        try{ bell && bell.play().catch(()=>{}); }catch{}
      }
      lastIds = new Set(orders.map(o=>o.id));

      document.getElementById('net').textContent = new Date().toLocaleTimeString('fr-FR')+' â€” OK';
    }catch(err){
      document.getElementById('net').textContent='Erreur rÃ©seau';
      showErr(String(err));
    }
  }

  async function updateStatus(id, status){
    if(!apiURL || !id) return;
    try{
      await getJSON(apiURL, {
        method:'POST',
        headers:{'Content-Type':'text/plain;charset=utf-8'},
        body: JSON.stringify({action:'status', id, status, adminKey})
      });
      refreshNow();
    }catch(err){ showErr('Mise Ã  jour statut: '+String(err)); }
  }

  async function deleteOrder(id){
    if(!apiURL || !id) return;
    if(!confirm('Supprimer cette commande ?')) return;
    try{
      await getJSON(apiURL, {
        method:'POST',
        headers:{'Content-Type':'text/plain;charset=utf-8'},
        body: JSON.stringify({action:'delete', id, adminKey})
      });
      refreshNow();
    }catch(err){ showErr('Suppression impossible: '+String(err)); }
  }

  /* ---- Init ---- */
  function init(){
    // restaurer prÃ©fÃ©rences
    const pref = store.read();
    apiURL   = pref.api || '';
    adminKey = pref.adm || '';
    document.getElementById('api').value = apiURL;
    document.getElementById('adm').value = adminKey;
    document.getElementById('vol').value = pref.vol ?? 0.7;
    if (pref.snd){ document.getElementById('snd').dataset.on='1'; document.getElementById('snd').classList.remove('warn'); document.getElementById('snd').textContent='ðŸ”” Son actif'; }

    // listeners
    document.getElementById('save').onclick = ()=>{
      apiURL   = document.getElementById('api').value.trim();
      adminKey = document.getElementById('adm').value.trim();
      store.write({api:apiURL, adm:adminKey, snd:document.getElementById('snd').dataset.on==='1', vol:Number(document.getElementById('vol').value||'0.7')});
      document.getElementById('net').textContent='ParamÃ¨tres enregistrÃ©s';
      refreshNow();
    };
    document.getElementById('refresh').onclick = refreshNow;

    document.getElementById('snd').onclick = ()=>{
      const btn = document.getElementById('snd');
      const on = btn.dataset.on==='1';
      if(!on){ prepareBell(); btn.dataset.on='1'; btn.classList.remove('warn'); btn.textContent='ðŸ”” Son actif'; }
      else   { btn.dataset.on='0'; btn.classList.add('warn'); btn.textContent='ðŸ”” Activer le son'; }
      store.write({api:apiURL, adm:adminKey, snd:btn.dataset.on==='1', vol:Number(document.getElementById('vol').value||'0.7')});
    };
    document.getElementById('vol').oninput = e=>{ if(bell){ bell.volume=Number(e.target.value||'0.7'); } };

    // premier chargement + polling
    refreshNow();
    setInterval(refreshNow, 10000); // 10 s
  }

  window.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
