<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Dashboard â€” PIZZâ€™AMIGO</title>
<style>
  :root{
    --bg:#0b0f14;--panel:#101722;--line:#283149;--muted:#b8c2d6;
    --green:#1fcf7c;--red:#e55252;--white:#ffffff;--accent:#ffb54c;
  }
  *{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:#fff;font-family:system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:1100px;margin:16px auto;padding:0 12px}
  h1{margin:0 0 12px;font-size:32px;letter-spacing:.4px}
  .bar{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:10px 12px}
  .bar .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .inp, .btn, .pill{border-radius:12px;border:1px solid var(--line);background:#0e1420;color:#fff}
  .inp{padding:10px 12px;min-width:260px;flex:1}
  .btn{padding:8px 12px;background:#162033;border-color:#2a3655;cursor:pointer}
  .btn.primary{background:var(--green);color:#001b10;border-color:transparent}
  .btn.red{border-color:#ff8b8b;color:#ffb4b4}
  .btn.warn{border-color:#ffb54c;color:#ffb54c}
  .muted{color:var(--muted)}
  .t{width:100%;border-collapse:collapse;margin-top:12px}
  .t th,.t td{border-bottom:1px solid rgba(255,255,255,.08);padding:10px 8px;vertical-align:top}
  .t th{color:#cdd7ef;text-align:left;font-weight:700}
  .status{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:4px 8px;min-width:54px;text-align:center}
  .status[data-s="new"]{background:#18202e}
  .status[data-s="ready"]{background:#13281f;border-color:#1f824e}
  .status[data-s="done"]{background:#1f1f33;border-color:#5050b5}
  .pill{padding:6px 10px;background:#162033;border-color:#2a3655;cursor:pointer}
  .row-actions{display:flex;gap:6px;flex-wrap:wrap}
  #err{position:fixed;right:8px;bottom:8px;max-width:92vw;background:#2a1b1b;border:1px solid #5d2f2f;border-radius:10px;padding:10px 12px;display:none;z-index:999}
  #err pre{white-space:pre-wrap;margin:6px 0 0 0;color:#ffd1d1}
  @media (max-width:720px){
    .wrap{padding:0 8px}
    .inp{min-width:200px}
    .t th:nth-child(2), .t td:nth-child(2){display:none} /* cache l'ID sur mobile */
  }
</style>
</head>
<body>
<div class="wrap">
  <h1>Dashboard â€” PIZZâ€™AMIGO</h1>

  <div class="bar">
    <div class="row">
      <input id="api" class="inp" placeholder="URL de lâ€™API (Google Apps Script)">
      <input id="adm" class="inp" placeholder="ClÃ© admin (facultatif)">
    </div>
    <div class="row" style="margin-top:8px">
      <button id="save" class="btn">Enregistrer</button>
      <button id="refresh" class="btn">Actualiser</button>
      <!-- Demo supprimÃ©e -->
      <span id="net" class="muted" style="margin-left:auto">â€”</span>
    </div>
    <div class="row" style="margin-top:8px">
      <label class="pill" style="display:flex;align-items:center;gap:8px">
        <span>ðŸ”” Activer le son</span>
        <input id="snd" type="checkbox" style="accent-color:#1fcf7c">
      </label>
      <span>Son :</span>
      <input id="vol" type="range" min="0" max="1" step="0.01" style="flex:1">
    </div>
  </div>

  <table class="t" id="tab">
    <thead>
      <tr>
        <th>Heure</th>
        <th>ID</th>
        <th>Client</th>
        <th>TÃ©lÃ©phone</th>
        <th>Horaire</th>
        <th>Pizzas</th>
        <th>Total</th>
        <th>Statut</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="rows"></tbody>
  </table>
</div>

<!-- Panneau erreurs -->
<div id="err"><b>Erreur JavaScript</b><pre id="err-msg"></pre></div>

<script>
/* ===== mini panneau erreur ===== */
function showErr(e){
  const box=document.getElementById('err');
  const msg=(e && e.message)||String(e);
  box.style.display='block';
  document.getElementById('err-msg').textContent=msg;
}

/* ===== Ã©tat ===== */
const S = {
  list: [],
  lastIds: new Set(),
  bell: null,
  sizeLimit: 200,           // on garde visible 200 lignes max
  pollMs: 12_000            // auto-refresh
};

/* ===== stockage simple ===== */
const store = {
  get k(){return 'PZ_DASH_V3'},
  read(){ try{return JSON.parse(localStorage.getItem(this.k)||'{}')}catch{return{}} },
  write(obj){ localStorage.setItem(this.k, JSON.stringify(obj)) }
};

/* ===== helpers ===== */
const apiURL = () => (document.getElementById('api').value||'').trim();
const adminKey = () => (document.getElementById('adm').value||'').trim();
const euro = v => (Number(v)||0).toFixed(2).replace('.', ',')+' â‚¬';
const hhmm = s => {
  // s peut Ãªtre '19:30' ou une date, on normalise en HH:MM
  if (!s) return '';
  if (/^\d{1,2}:\d{2}$/.test(s)) return s;
  try{
    const d = new Date(s);
    const h = String(d.getHours()).padStart(2,'0');
    const m = String(d.getMinutes()).padStart(2,'0');
    return `${h}:${m}`;
  }catch{return String(s)}
};

async function getJSON(q){
  const url = apiURL() + (q||'');
  const r = await fetch(url + (url.includes('?') ? '&' : '?') + '_=' + Date.now(), {method:'GET'});
  const t = await r.text();
  try { return JSON.parse(t); } catch { return { ok:false, raw:t }; }
}
async function postJSON(bodyObj){
  const r = await fetch(apiURL(), {
    method: 'POST',
    headers: { 'Content-Type':'text/plain;charset=utf-8' },
    body: JSON.stringify(bodyObj)
  });
  const t = await r.text();
  try { return JSON.parse(t); } catch { return { ok:false, raw:t }; }
}

/* ===== rendu ===== */
function render(){
  const tb = document.getElementById('rows');
  tb.innerHTML = '';
  for(const o of S.list){
    const tr = document.createElement('tr');

    const pizzasTxt = (o.basket||o.items||[]).map(it=>{
      const sup = (it.supplPrice>0 ? ` (+${it.supplPrice.toFixed(1).replace('.',',')}â‚¬ ${it.supplType||''})` : '');
      return `${it.name} Ã— ${it.qty||1}${sup}`;
    }).join('<br>');

    tr.innerHTML = `
      <td>${o.when||o.date||''}</td>
      <td>${o.id||''}</td>
      <td>${o.name||o.client||''}</td>
      <td>${o.phone||''}</td>
      <td>${hhmm(o.slot||o.horaire)}</td>
      <td>${pizzasTxt||''}</td>
      <td>${euro(o.total)}</td>
      <td><span class="status" data-s="${o.status||'new'}">${o.status||'new'}</span></td>
      <td class="row-actions"></td>
    `;

    const act = tr.querySelector('.row-actions');
    // boutons statut (inchangÃ©s)
    [['ready','PrÃªte'],['done','TerminÃ©e'],['canceled','Annuler']].forEach(([s,label])=>{
      const b=document.createElement('button');
      b.className='btn'; b.textContent=label;
      b.onclick=()=>updateStatus(o.id, s);
      act.appendChild(b);
    });
    // nouveau : SUPPRIMER (efface la ligne du Sheet)
    const del = document.createElement('button');
    del.className='btn red';
    del.textContent='Supprimer';
    del.onclick=()=>deleteOrder(o.id);
    act.appendChild(del);

    tb.appendChild(tr);
  }
}

/* ===== actions API ===== */
async function refreshNow(){
  try{
    document.getElementById('net').textContent = 'Chargementâ€¦';
    const data = await getJSON('?list=1'); // doGet â†’ liste du jour
    if(!data || data.ok===false){ document.getElementById('net').textContent='Erreur rÃ©seau'; showErr(data && (data.error||data.raw||JSON.stringify(data))); return; }

    const arr = (data.orders||data||[]).slice(0,S.sizeLimit);
    // dÃ©tection des nouvelles pour la cloche
    const newOnes = arr.filter(o=>!S.lastIds.has(o.id));
    S.lastIds = new Set(arr.map(o=>o.id));

    S.list = arr;
    render();

    document.getElementById('net').textContent = new Date().toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit',second:'2-digit'})+' â€” OK';

    if(newOnes.length && document.getElementById('snd').checked){
      ring();
    }
  }catch(e){ document.getElementById('net').textContent='Erreur rÃ©seau'; showErr(e); }
}

async function updateStatus(id, status){
  try{
    const res = await postJSON({ action:'status', id, status, adminKey: adminKey() });
    if(!res || res.ok===false){ showErr(res && (res.error||res.raw||JSON.stringify(res))); return; }
    refreshNow();
  }catch(e){ showErr(e); }
}

/* >>> nouveau : suppression dÃ©finitive <<< */
async function deleteOrder(id){
  if(!confirm("Supprimer dÃ©finitivement cette commande ?")) return;
  try{
    const res = await postJSON({ action:'delete', id, adminKey: adminKey() });
    if(!res || res.ok===false){ showErr(res && (res.error||res.raw||JSON.stringify(res))); alert("Suppression impossible."); return; }
    // Retire localement sans attendre le prochain poll
    S.list = S.list.filter(o=>o.id!==id);
    S.lastIds.delete(id);
    render();
  }catch(e){ showErr(e); alert("Suppression impossible."); }
}

/* ===== sonnerie ===== */
function ring(){
  try{
    if(!S.bell){
      S.bell = new Audio('https://cdn.jsdelivr.net/gh/naptha/tinyfiles@master/chime.mp3'); // cloche courte, agrÃ©able
    }
    S.bell.volume = Number(document.getElementById('vol').value||'0.8');
    // Safari/iOS : il faut une interaction utilisateur prÃ©alable pour autoriser play()
    S.bell.play().catch(()=>{/* ignore */});
  }catch(e){ showErr(e); }
}

/* ===== init ===== */
function init(){
  // restaure prÃ©fÃ©rences
  const pref = store.read();
  document.getElementById('api').value = pref.api || '';
  document.getElementById('adm').value = pref.adm || '';
  document.getElementById('snd').checked = !!pref.snd;
  document.getElementById('vol').value = pref.vol ?? 0.85;

  document.getElementById('save').onclick = ()=>{
    store.write({
      api: apiURL(), adm: adminKey(),
      snd: document.getElementById('snd').checked,
      vol: document.getElementById('vol').value
    });
    document.getElementById('net').textContent = 'ParamÃ¨tres enregistrÃ©s';
  };
  document.getElementById('refresh').onclick = ()=>refreshNow();
  document.getElementById('snd').onchange = ()=>store.write({...store.read(), snd:document.getElementById('snd').checked});
  document.getElementById('vol').oninput = ()=>store.write({...store.read(), vol:document.getElementById('vol').value});

  refreshNow();
  setInterval(refreshNow, S.pollMs);
}
window.addEventListener('error', e=>showErr(e.message+'\n'+(e.error&&e.error.stack||'')));
window.addEventListener('unhandledrejection', e=>showErr('Promise rejetÃ©e: '+(e.reason&&e.reason.message||e.reason)));
init();
</script>
</body>
</html>
