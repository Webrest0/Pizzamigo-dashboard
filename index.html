<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Dashboard — PIZZ’AMIGO</title>
<style>
  body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:#0b0f14;color:#fff}
  .wrap{max-width:1100px;margin:auto;padding:14px}
  h1{margin:0 0 10px;font-size:24px}
  input,button{padding:8px;border-radius:6px;border:1px solid #283149;background:#101722;color:#fff}
  button{cursor:pointer}
  .row{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px}
  table{width:100%;border-collapse:collapse;font-size:.95rem}
  th,td{border:1px solid #283149;padding:6px 8px;text-align:left}
  th{background:#101722}
  tr:nth-child(even){background:#161d29}
  .btn{padding:4px 8px;border-radius:6px;border:1px solid #444;background:#222;color:#fff;cursor:pointer}
  .btn:hover{background:#333}
  .status{padding:2px 6px;border-radius:6px;font-size:.8rem}
  .new{background:#1fcf7c;color:#001b10}
  .ready{background:#ffb54c;color:#000}
  .done{background:#36a2ff;color:#000}
  .cancel{background:#e55252;color:#fff}
  @media(max-width:700px){
    table, thead, tbody, th, td, tr{display:block}
    th{display:none}
    td{border:none;border-bottom:1px solid #283149}
    tr{margin-bottom:10px}
  }
</style>
</head>
<body>
<div class="wrap">
  <h1>Dashboard — PIZZ’AMIGO</h1>

  <div class="row">
    <input id="api-url" placeholder="URL du script Google Apps" style="flex:1"/>
    <input id="admin-key" placeholder="Clé admin (facultatif)" style="flex:1"/>
    <button onclick="saveCfg()">Enregistrer</button>
    <button onclick="refresh()">Actualiser</button>
    <button onclick="sendDemo()">Démo</button>
  </div>

  <div id="status">Dernière mise à jour — en attente…</div>

  <table>
    <thead>
      <tr><th>Heure</th><th>ID</th><th>Client</th><th>Téléphone</th><th>Horaire</th><th>Pizzas</th><th>Total</th><th>Statut</th><th>Action</th></tr>
    </thead>
    <tbody id="orders"></tbody>
  </table>
</div>

<audio id="ding" src="https://actions.google.com/sounds/v1/alarms/digital_watch_alarm_long.ogg" preload="auto"></audio>

<script>
let CFG={};
function loadCfg(){
  try{CFG=JSON.parse(localStorage.pizzacfg||"{}");}catch{CFG={}}
  document.getElementById('api-url').value=CFG.api||"";
  document.getElementById('admin-key').value=CFG.key||"";
}
function saveCfg(){
  CFG.api=document.getElementById('api-url').value.trim();
  CFG.key=document.getElementById('admin-key').value.trim();
  localStorage.pizzacfg=JSON.stringify(CFG);
}
function getApi(){return document.getElementById('api-url').value.trim();}

/* === format horaire HH:MM === */
function fmtTime(v){
  if(Object.prototype.toString.call(v)==="[object Date]"&&!isNaN(v)){
    return v.toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"});
  }
  if(typeof v==="string"){
    const m=v.match(/(\d{1,2})[:h](\d{2})/i);
    if(m) return `${m[1].padStart(2,"0")}:${m[2]}`;
  }
  return v||"";
}

let lastIds=new Set();

/* === Rendu des commandes === */
function render(list){
  const tb=document.getElementById('orders'); tb.innerHTML="";
  list.forEach(o=>{
    const tr=document.createElement("tr");
    const id=o.id||"";
    const hor=fmtTime(o.slot||o.horaire);
    tr.innerHTML=`
      <td>${hor}</td>
      <td>${id}</td>
      <td>${o.name||""}</td>
      <td>${o.phone||""}</td>
      <td>${hor}</td>
      <td>${(o.items||[]).map(i=>i.name+" x"+i.qty).join(", ")}</td>
      <td>${o.total?o.total.toFixed(2)+" €":""}</td>
      <td><span class="status ${o.status}">${o.status||""}</span></td>
      <td>
        <button class="btn" onclick="setStatus('${id}','ready')">Prête</button>
        <button class="btn" onclick="setStatus('${id}','done')">Terminée</button>
        <button class="btn" onclick="setStatus('${id}','cancel')">Annuler</button>
        <button class="btn" onclick="del('${id}')">✖</button>
      </td>`;
    tb.appendChild(tr);
    if(!lastIds.has(id)){document.getElementById('ding').play();}
    lastIds.add(id);
  });
}

/* === Récupération commandes === */
async function refresh(){
  try{
    const res=await fetch(getApi()+"?mode=list");
    const txt=await res.text();
    const data=JSON.parse(txt);
    render(data||[]);
    document.getElementById('status').textContent="Dernière mise à jour — OK";
  }catch(e){
    document.getElementById('status').textContent="Erreur réseau";
    console.error(e);
  }
}

/* === Démo === */
async function sendDemo(){
  try{
    const url=getApi(); if(!url) throw new Error("Pas d’URL API");
    const res=await fetch(url,{method:"POST",headers:{"Content-Type":"text/plain;charset=utf-8"},body:JSON.stringify({demo:true})});
    const txt=await res.text(); let data;
    try{data=JSON.parse(txt);}catch{data={ok:false,raw:txt};}
    if(!res.ok||!data.ok) throw new Error("Réponse API invalide");
    await refresh();
  }catch(err){alert("Échec d’envoi de la démo.");console.error(err);}
}

/* === Changer statut === */
async function setStatus(id,status){
  try{
    const url=getApi(); if(!url) return;
    await fetch(url,{method:"POST",headers:{"Content-Type":"text/plain;charset=utf-8"},body:JSON.stringify({id,status,key:CFG.key})});
    refresh();
  }catch(e){console.error(e);}
}

/* === Supprimer === */
async function del(id){
  if(!confirm("Supprimer la commande "+id+" ?")) return;
  try{
    const url=getApi(); if(!url) return;
    await fetch(url,{method:"POST",headers:{"Content-Type":"text/plain;charset=utf-8"},body:JSON.stringify({id,delete:true,key:CFG.key})});
    refresh();
  }catch(e){console.error(e);}
}

loadCfg(); refresh(); setInterval(refresh,15000);
</script>
</body>
</html>
