<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Dashboard — PIZZ'AMIGO</title>
<style>
  :root{--bg:#0b0f14;--panel:#101722;--line:#283149;--muted:#b8c2d6;--green:#1fcf7c;--red:#e55252}
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:#fff;font-family:system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:1100px;margin:18px auto;padding:0 14px}
  h1{margin:6px 0 12px}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:12px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  input[type=text]{flex:1 1 260px;min-width:220px;border:1px solid var(--line);background:#0e1420;color:#fff;border-radius:10px;padding:10px}
  .btn{border:1px solid rgba(255,255,255,.25);background:#1a2333;color:#fff;border-radius:999px;padding:9px 14px;cursor:pointer}
  .btn.primary{background:var(--green);color:#001b10;border:none}
  .btn.red{border-color:#ff8b8b;color:#ffb4b4}
  .muted{color:var(--muted)}
  input[type=range]{width:120px}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border-top:1px solid rgba(255,255,255,.08);padding:8px 10px;vertical-align:middle;text-align:left}
  .tag{padding:3px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.25);background:#233048}
  .price{white-space:nowrap}
  .actions .btn{padding:6px 10px}
  @media (max-width:740px){ .hide-sm{display:none} table{font-size:14px} .actions .btn{padding:6px 8px} }
  #err{position:fixed;right:8px;bottom:8px;max-width:92vw;background:#2a1b1b;border:1px solid #5d2f2f;border-radius:10px;padding:10px 12px;display:none;z-index:9999}
  #err pre{white-space:pre-wrap;margin:6px 0 0 0;color:#ffd1d1}
</style>
</head>
<body>
<div class="wrap">
  <h1>Dashboard — PIZZ'AMIGO</h1>

  <div class="card">
    <div class="row">
      <input id="api" type="text" placeholder="URL de l'API Google Apps Script">
      <input id="adm" type="text" placeholder="Cle admin (facultatif)">
    </div>
    <div class="row" style="margin-top:8px">
      <button class="btn" id="save">Enregistrer</button>
      <button class="btn" id="refresh">Actualiser</button>
      <button class="btn" id="demo">Demo</button>
      <span id="status" class="muted">–</span>
      <span style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <button class="btn" id="soundBtn">Activer le son</button>
        <label class="muted" for="vol">Son :</label>
        <input type="range" min="0" max="1" step="0.05" id="vol" value="0.7">
      </span>
    </div>
  </div>

  <div class="card" style="margin-top:12px;overflow:auto">
    <table id="tbl">
      <thead>
        <tr>
          <th>Heure</th>
          <th class="hide-sm">ID</th>
          <th class="hide-sm">Client</th>
          <th class="hide-sm">Telephone</th>
          <th>Horaire</th>
          <th>Pizzas</th>
          <th>Total</th>
          <th>Statut</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </div>
</div>

<div id="err"><b>Erreur JavaScript</b><pre id="err-msg"></pre></div>

<script>
/* ==== anti page blanche ==== */
function showErr(msg){var b=document.getElementById('err');b.style.display='block';document.getElementById('err-msg').textContent=msg;}
window.addEventListener('error',function(e){showErr(e.message+"\n"+(e.error&&e.error.stack||""));});
window.addEventListener('unhandledrejection',function(e){showErr('Promise rejetee: '+(e.reason&&e.reason.message||e.reason));});

/* ==== etat ==== */
var S={api:localStorage.getItem('pizz_api')||'',adm:localStorage.getItem('pizz_adm')||'PIZZAMIGO-ADMIN-123',orders:new Map(),ctx:null,audioReady:false,timer:null};
document.getElementById('api').value=S.api;
document.getElementById('adm').value=S.adm;

/* ==== helpers ==== */
function euro(v){return Number(v||0).toFixed(2).replace('.',',')+' €';}
function hhmm(t){ if(/^\d{2}:\d{2}$/.test(t||'')) return t; var d=new Date(t||Date.now()); return String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0');}
function parseItems(v){
  try{
    if(Array.isArray(v)) return v;
    if(typeof v==='string'&&v.trim()){
      var j=JSON.parse(v);
      if(Array.isArray(j)) return j;
      if(j&&Array.isArray(j.items)) return j.items;
    }
    if(v&&typeof v==='object'&&Array.isArray(v.items)) return v.items;
  }catch(e){}
  return [];
}
function itemsText(o){
  var arr=parseItems(o.items||o.basket||o.panier||[]);
  return arr.map(function(it){
    var sup = (it.supplType||it.suppl||'') ? ' (+1€ '+(it.supplType||it.suppl)+')' : '';
    return (it.name||it.n||'')+' × '+(it.qty||it.q||1)+sup;
  }).join('<br>');
}
function rowHtml(o){
  var total = o.total!=null ? o.total : (o.total11!=null?o.total11:0);
  return '<tr data-id="'+(o.id||'')+'">'+
    '<td>'+(o.time||o.when||'')+'</td>'+
    '<td class="hide-sm">'+(o.id||'')+'</td>'+
    '<td class="hide-sm">'+(o.name||o.client||'')+'</td>'+
    '<td class="hide-sm">'+(o.phone||'')+'</td>'+
    '<td>'+hhmm(o.slot||o.horaire||o.when||'')+'</td>'+
    '<td>'+(itemsText(o)||'-')+'</td>'+
    '<td class="price">'+euro(total)+'</td>'+
    '<td><span class="tag">'+(o.status||'new')+'</span></td>'+
    '<td class="actions">'+
      '<button class="btn" onclick="setStatus(\''+(o.id||'')+'\',\'ready\')">Prete</button> '+
      '<button class="btn" onclick="setStatus(\''+(o.id||'')+'\',\'done\')">Terminee</button> '+
      '<button class="btn red" onclick="setStatus(\''+(o.id||'')+'\',\'cancel\')">Annuler</button> '+
      '<button class="btn" onclick="removeRow(\''+(o.id||'')+'\')">×</button>'+
    '</td>'+
  '</tr>';
}
function upsert(list){
  var body=document.getElementById('rows'), added=0;
  (Array.isArray(list)?list:[]).forEach(function(o){
    if(!o||!o.id) return;
    if(!S.orders.has(o.id)){
      S.orders.set(o.id,o);
      body.insertAdjacentHTML('afterbegin',rowHtml(o));
      added++;
    }
  });
  if(added>0) ring();
}
function ring(){
  if(!S.audioReady||!S.ctx) return;
  var g=S.ctx.createGain(), o=S.ctx.createOscillator();
  o.type='triangle'; o.frequency.value=880;
  g.gain.value=0.0001;
  g.gain.exponentialRampToValueAtTime(Math.max(0.02,+document.getElementById('vol').value), S.ctx.currentTime+0.02);
  g.gain.exponentialRampToValueAtTime(0.0001, S.ctx.currentTime+0.35);
  o.connect(g); g.connect(S.ctx.destination); o.start(); o.stop(S.ctx.currentTime+0.35);
