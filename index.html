<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Dashboard â€” PIZZâ€™AMIGO</title>
<style>
  :root{--bg:#0b0f14;--panel:#101722;--line:#283149;--muted:#b8c2d6;--green:#1fcf7c;--red:#e55252}
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:#fff;font-family:system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:1040px;margin:18px auto;padding:0 14px}
  h1{margin:0 0 14px;font-size:32px}

  .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:10px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  input,button{border-radius:10px;border:1px solid var(--line);background:#0e1420;color:#fff}
  input{padding:10px 12px;min-width:240px}
  button{padding:8px 12px;cursor:pointer}
  .btn{background:#0f1622}
  .btn.primary{background:var(--green);border-color:transparent;color:#001a12}
  .btn.red{color:#ffd0d0;border-color:#ff8b8b}
  .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#0e1420}
  .muted{color:var(--muted)}
  .ok{color:#a7ffcf}.err{color:#ff9d9d}

  .sound{display:flex;align-items:center;gap:10px}
  .sound input[type="checkbox"]{width:18px;height:18px}

  /* TABLE (desktop) */
  .tbl-wrap{margin-top:10px}
  table{width:100%;border-collapse:separate;border-spacing:0 10px;table-layout:fixed}
  th,td{padding:10px 12px;border-top:1px solid var(--line);border-bottom:1px solid var(--line);vertical-align:top;word-wrap:break-word}
  th{color:#dfe6fb;text-align:left}
  tr{background:#0f1622;border-radius:12px}
  td:first-child,th:first-child{border-left:1px solid var(--line);border-top-left-radius:12px;border-bottom-left-radius:12px}
  td:last-child,th:last-child{border-right:1px solid var(--line);border-top-right-radius:12px;border-bottom-right-radius:12px}
  .actions{display:flex;gap:6px;flex-wrap:wrap}
  .badge{display:inline-block;padding:4px 10px;border:1px solid var(--line);border-radius:999px}
  .status-new{border-color:#6e7eea;color:#b9c3ff}
  .status-ready{border-color:#ffcd5d;color:#ffe2a1}
  .status-done{border-color:#6be2ab;color:#c7ffe7}
  .status-canceled{border-color:#ff8b8b;color:#ffd2d2}

  /* CARTES (mobile) */
  @media (max-width:700px){
    .wrap{max-width:680px}
    .desktop{display:none}
    .mobile{display:grid;gap:12px;margin-top:12px}
    .mcard{background:#0f1622;border:1px solid var(--line);border-radius:12px;padding:10px}
    .mrow{display:flex;justify-content:space-between;gap:12px}
    .mttl{color:#cfd6e7}
    .mpizz{margin:6px 0;color:#dfe6fb}
    .mactions{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
  }
  @media (min-width:701px){ .mobile{display:none} }

  /* toast erreur */
  #err{position:fixed;right:10px;bottom:10px;max-width:92vw;background:#2a1b1b;border:1px solid #5d2f2f;border-radius:10px;padding:10px 12px;display:none;z-index:999}
  #err pre{white-space:pre-wrap;margin:6px 0 0;color:#ffd1d1}
</style>
</head>
<body>
<div class="wrap">
  <h1>Dashboard â€” PIZZâ€™AMIGO</h1>

  <div class="card">
    <div class="row">
      <input id="api" placeholder="URL de lâ€™API (Google Apps Script)">
      <input id="adm" placeholder="PIZZAMIGO-ADMIN-123 (facultatif)">
      <button class="btn" id="save">Enregistrer</button>
      <button class="btn" id="reload">Actualiser</button>
      <span class="muted" id="net">â€”</span>
    </div>
    <div class="row" style="margin-top:10px">
      <label class="sound pill">ðŸ”” <input id="snd" type="checkbox" style="margin-left:6px"><span>Activer le son</span></label>
      <div class="row"><span>Son :</span><input id="vol" type="range" min="0" max="1" step="0.01" value="0.8" style="width:220px"></div>
    </div>
  </div>

  <!-- TABLE DESKTOP -->
  <div class="tbl-wrap desktop">
    <table id="tbl">
      <thead>
        <tr>
          <!-- Heures supprimÃ©e -->
          <th>ID</th>
          <th>Client</th>
          <th>TÃ©lÃ©phone</th>
          <th>Horaire</th>
          <th>Pizzas</th>
          <th>Total</th>
          <th>Statut</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="tb"></tbody>
    </table>
  </div>

  <!-- CARTES MOBILE -->
  <div class="mobile" id="mobile"></div>
</div>

<div id="err"><b>Erreur JavaScript</b><pre id="err-msg"></pre></div>

<script>
/* ===== util ===== */
const $ = sel => document.querySelector(sel);
const euro = v => Number(v||0).toFixed(2).replace('.',',');
const fmtHHMM = (val) => {
  // accepte string "18:30" ou timestamp/ISO
  const s = (val||'').toString().trim();
  if (/^\d{1,2}:\d{2}$/.test(s)) return s;
  let d = null; try{ d = new Date(val); }catch{}
  if (d && !Number.isNaN(d.getTime())){
    return d.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit',hour12:false,timeZone:'Europe/Paris'});
  }
  return 'â€”';
};
const showErr = (msg)=>{ const b=$("#err"); $("#err-msg").textContent=msg; b.style.display='block'; };

/* ===== Ã©tat ===== */
let pref = (()=>{ try{return JSON.parse(localStorage.getItem('pzadm')||'{}')}catch{return{}} })();
pref.api ??=''; pref.adm ??=''; pref.snd=!!pref.snd; pref.vol = pref.vol ?? 0.85;

let bell=null, bellVol=pref.vol;
let lastIds = new Set();
let polling=false;
let timer=null;

/* ===== son ===== */
function initBell(){
  bell = new Audio("https://cdn.jsdelivr.net/gh/maph42/tinyfiles@master/chime.mp3");
  bell.volume = bellVol;
  document.body.addEventListener('click', ()=>{ bell.play().then(()=>bell.pause()).catch(()=>{}); }, {once:true});
}
function ring(){ if(pref.snd && bell){ bell.currentTime=0; bell.volume=bellVol; bell.play().catch(()=>{}); } }

/* ===== API ===== */
async function apiGet(url){
  const u = new URL(url); u.searchParams.set('t', Date.now());
  const r = await fetch(u,{method:'GET'});
  const txt = await r.text();
  let data; try{ data=JSON.parse(txt);}catch{ data={ok:false,raw:txt}; }
  if(!r.ok || data.ok===false) throw new Error(data.error||'RÃ©ponse non JSON');
  return data;
}
async function apiPost(url,payload){
  const r = await fetch(url,{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify(payload)});
  const txt = await r.text(); let data; try{data=JSON.parse(txt);}catch{data={ok:false,raw:txt};}
  if(!r.ok || data.ok===false) throw new Error(data.error||'Payload invalide');
  return data;
}

/* ===== rendu ===== */
function asPizzaLines(o){
  const arr = (o.basket?.items || o.items || []);
  if(!Array.isArray(arr) || !arr.length) return 'â€”';
  return arr.map(it=>{
    const n = it.name || '';
    const q = it.qty || it.quantity || 1;
    const sup = (it.supplType||it.sup||'') ? ` (+1â‚¬ ${it.supplType||it.sup})` : '';
    return `${n} Ã— ${q}${sup}`;
  }).join('<br>');
}
function renderDesktop(list){
  const tb=$("#tb"); tb.innerHTML='';
  for(const o of list){
    const st=(o.status||'new');
    const stClass=st==='ready'?'status-ready':st==='done'?'status-done':st==='canceled'?'status-canceled':'status-new';
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${o.id||'â€”'}</td>
      <td>${o.name||o.client||'â€”'}</td>
      <td>${o.phone||o.tel||'â€”'}</td>
      <td>${fmtHHMM(o.slot||o.when)}</td>
      <td>${asPizzaLines(o)}</td>
      <td>${euro(o.total||0)} â‚¬</td>
      <td><span class="badge ${stClass}">${st}</span></td>
      <td class="actions"></td>`;
    const actions=tr.querySelector('.actions');
    [['ready','PrÃªte'],['done','TerminÃ©e'],['canceled','Annuler']].forEach(([code,label])=>{
      const b=document.createElement('button'); b.className='btn'; b.textContent=label;
      b.onclick=()=>updateStatus(o.id, code);
      actions.appendChild(b);
    });
    const del=document.createElement('button'); del.className='btn red'; del.textContent='Supprimer';
    del.onclick=()=>deleteOrder(o.id);
    actions.appendChild(del);
    tb.appendChild(tr);
  }
}
function renderMobile(list){
  const root=$("#mobile"); root.innerHTML='';
  for(const o of list){
    const st=(o.status||'new');
    const stClass=st==='ready'?'status-ready':st==='done'?'status-done':st==='canceled'?'status-canceled':'status-new';
    const card=document.createElement('div'); card.className='mcard';
    card.innerHTML=`
      <div class="mrow"><div class="mttl">ID</div><div>${o.id||'â€”'}</div></div>
      <div class="mrow"><div class="mttl">Client</div><div>${o.name||o.client||'â€”'}</div></div>
      <div class="mrow"><div class="mttl">TÃ©l</div><div>${o.phone||o.tel||'â€”'}</div></div>
      <div class="mrow"><div class="mttl">Horaire</div><div>${fmtHHMM(o.slot||o.when)}</div></div>
      <div class="mttl" style="margin-top:6px">Pizzas</div>
      <div class="mpizz">${asPizzaLines(o)}</div>
      <div class="mrow"><div class="mttl">Total</div><div><b>${euro(o.total||0)} â‚¬</b></div></div>
      <div class="mrow" style="margin-top:6px"><div class="mttl">Statut</div><div><span class="badge ${stClass}">${st}</span></div></div>
      <div class="mactions"></div>`;
    const actions=card.querySelector('.mactions');
    [['ready','PrÃªte'],['done','TerminÃ©e'],['canceled','Annuler']].forEach(([code,label])=>{
      const b=document.createElement('button'); b.className='btn'; b.textContent=label; b.onclick=()=>updateStatus(o.id, code);
      actions.appendChild(b);
    });
    const del=document.createElement('button'); del.className='btn red'; del.textContent='Supprimer'; del.onclick=()=>deleteOrder(o.id);
    actions.appendChild(del);
    root.appendChild(card);
  }
}
function render(list){ renderDesktop(list); renderMobile(list); }

/* ===== polling ===== */
async function fetchOnce(){
  if(!pref.api){ $("#net").textContent='URL manquante'; $("#net").className='err'; return; }
  if(polling) return;
  polling=true;
  $("#net").textContent='Chargementâ€¦'; $("#net").className='muted';
  try{
    await apiGet(pref.api+'?ping=1');
    const res = await apiGet(pref.api+'?list=1');
    const orders = Array.isArray(res.orders)?res.orders:(Array.isArray(res.data)?res.data:[]);
    // nouvelles commandes => cloche
    const newOnes = orders.filter(o=>o && o.id && !lastIds.has(o.id));
    if(newOnes.length) ring();
    lastIds = new Set(orders.map(o=>o.id));
    render(orders);
    $("#net").textContent=new Date().toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit',second:'2-digit'})+' â€” OK';
    $("#net").className='ok';
  }catch(err){
    console.error(err);
    $("#net").textContent='Erreur rÃ©seau'; $("#net").className='err';
    showErr(String(err));
  }finally{
    polling=false;
  }
}
function startPolling(){ clearInterval(timer); timer=setInterval(fetchOnce, 5000); fetchOnce(); }

/* ===== actions ===== */
async function updateStatus(id,status){
  try{ await apiPost(pref.api,{action:'status',id,status,adminkey:pref.adm||''}); fetchOnce(); }
  catch(e){ showErr('Action Ã©chouÃ©e: '+String(e)); }
}
async function deleteOrder(id){
  if(!confirm('Supprimer cette commande ?')) return;
  try{ await apiPost(pref.api,{action:'delete',id,adminkey:pref.adm||''}); fetchOnce(); }
  catch(e){ showErr('Suppression impossible: '+String(e)); }
}

/* ===== init ===== */
function init(){
  $('#api').value=pref.api; $('#adm').value=pref.adm; $('#snd').checked=pref.snd; $('#vol').value=pref.vol; bellVol=Number(pref.vol||0.8);
  initBell();
  $('#save').onclick=()=>{ pref.api=$('#api').value.trim(); pref.adm=$('#adm').value.trim(); localStorage.setItem('pzadm',JSON.stringify(pref)); $('#net').textContent='ParamÃ¨tres enregistrÃ©s'; };
  $('#reload').onclick=fetchOnce;
  $('#snd').onchange=()=>{ pref.snd=$('#snd').checked; localStorage.setItem('pzadm',JSON.stringify(pref)); };
  $('#vol').oninput=()=>{ bellVol=Number($('#vol').value||0.8); pref.vol=bellVol; localStorage.setItem('pzadm',JSON.stringify(pref)); };
  startPolling();
}
window.addEventListener('error', e=>showErr(e.message+'\n'+(e.error&&e.error.stack||'')));
window.addEventListener('unhandledrejection', e=>showErr('Promise rejetÃ©e: '+(e.reason&&e.reason.message||e.reason)));
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
