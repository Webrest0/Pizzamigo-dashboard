<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Dashboard — PIZZ’AMIGO</title>
<style>
  :root{
    --bg:#0b0f14; --panel:#101722; --line:#283149; --muted:#b8c2d6;
    --green:#1fcf7c; --red:#e55252; --white:#fff; --accent:#ffb54c;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:#fff;font-family:system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:1024px;margin:18px auto;padding:0 14px}

  h1{margin:0 0 12px;font-size:24px}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:12px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  input[type="text"]{width:100%;max-width:680px;border:1px solid var(--line);background:#0e1420;color:#fff;border-radius:10px;padding:10px}
  .btn{border:1px solid rgba(255,255,255,.25);background:transparent;color:#fff;border-radius:999px;padding:8px 12px;cursor:pointer}
  .btn.red{border-color:#ff8b8b;color:#ffb4b4}
  .muted{color:var(--muted)}
  .ok{color:var(--green)}
  .err{color:#ff9a9a}

  table{width:100%;border-collapse:separate;border-spacing:0 10px}
  thead th{padding:10px;text-align:left;color:#dfe8ff}
  tbody td{background:#0f1623;border-top:1px solid var(--line);border-bottom:1px solid var(--line);padding:12px 14px;vertical-align:top}
  tbody td:first-child{border-left:1px solid var(--line);border-top-left-radius:12px;border-bottom-left-radius:12px}
  tbody td:last-child{border-right:1px solid var(--line);border-top-right-radius:12px;border-bottom-right-radius:12px}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  .pill{border:1px solid var(--line);border-radius:999px;padding:6px 10px;background:#0f1623}

  @media (max-width: 720px){
    table, thead, tbody, th, td, tr{display:block}
    thead{display:none}
    tbody tr{margin:12px 0}
    tbody td{border:1px solid var(--line);border-radius:12px;margin:6px 0;padding:10px 12px}
    tbody td::before{content:attr(data-label);display:block;font-size:.85rem;color:var(--muted);margin-bottom:2px}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
  }

  .vol{display:flex;align-items:center;gap:10px;margin-left:auto}
  .small{padding:6px 10px}
</style>
</head>
<body>
<div class="wrap">
  <h1>Dashboard — PIZZ’AMIGO</h1>

  <div class="panel">
    <div class="row">
      <input id="api" type="text" placeholder="URL de l’API" value="https://script.google.com/macros/s/AKfycbyePXcqPFPs0uhNOcVM5J5Nq3LCgsrB9UKVOmit1HVoTBzCdZRDCxEntrydbXSyQMXu/exec">
      <input id="adm" type="text" placeholder="Clé admin (facultatif)" style="max-width:260px">
      <button id="save" class="btn">Enregistrer</button>
      <button id="refresh" class="btn">Actualiser</button>
      <div class="vol">
        <button id="test" class="btn small">Test son</button>
        <label class="muted">Volume :</label>
        <input id="vol" type="range" min="0" max="1" step="0.01" value="0.85">
      </div>
    </div>
    <div id="status" class="muted" style="margin-top:8px">—</div>
  </div>

  <div class="panel" style="margin-top:12px">
    <table>
      <thead>
        <tr>
          <th style="width:70px">ID</th>
          <th>Client</th>
          <th>Téléphone</th>
          <th style="width:80px">HDC</th>
          <th style="width:90px">Horaire</th>
          <th>Pizzas</th>
          <th>Commentaire</th>
          <th style="width:90px">Total</th>
          <th style="width:80px">Action</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </div>

  <div id="err" class="panel" style="display:none;margin-top:12px;background:#2a1b1b;border-color:#5d2f2f">
    <b>Erreur JavaScript</b>
    <pre id="err-msg" style="white-space:pre-wrap;margin:8px 0 0;color:#ffd1d1"></pre>
  </div>
</div>

<script>
/* ==== anti page blanche ==== */
function showErr(msg){const p=document.getElementById('err');p.style.display='block';document.getElementById('err-msg').textContent=msg;}
window.addEventListener('error', e=>showErr(e.message+'\n'+(e.error&&e.error.stack||'')));
window.addEventListener('unhandledrejection', e=>showErr('Promise rejetée: '+(e.reason&&e.reason.message||e.reason)));

/* ==== state ==== */
const elApi=document.getElementById('api');
const elAdm=document.getElementById('adm');
const elRows=document.getElementById('rows');
const elStatus=document.getElementById('status');
const elVol=document.getElementById('vol');
const btnTest=document.getElementById('test');

let ORDERS=new Map();        // idMachine -> order (dernière version connue)
let HDC=new Map();            // idMachine -> HDC figée
let audioCtx=null, gainNode=null;

/* ==== audio (cloche douce) ==== */
function ensureAudio(){
  if(audioCtx) return;
  audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  gainNode = audioCtx.createGain();
  gainNode.gain.value = Number(elVol.value||0.85);
  gainNode.connect(audioCtx.destination);
}
function ring(){
  ensureAudio();
  const t=audioCtx.currentTime;
  const o=audioCtx.createOscillator();
  const g=audioCtx.createGain();
  o.type='triangle';
  o.frequency.setValueAtTime(1400,t);
  o.frequency.exponentialRampToValueAtTime(700,t+0.20);
  g.gain.setValueAtTime(0.0001,t);
  g.gain.exponentialRampToValueAtTime(0.7,t+0.01);
  g.gain.exponentialRampToValueAtTime(0.0001,t+0.45);
  o.connect(g).connect(gainNode);
  o.start(t); o.stop(t+0.46);
}
btnTest.onclick=async()=>{ try{ ensureAudio(); await audioCtx.resume(); ring(); }catch(e){ showErr(String(e)); } };
elVol.oninput=()=>{ ensureAudio(); gainNode.gain.value=Number(elVol.value||0.85); };

/* ==== helpers ==== */
const euro=v=>(Number(v)||0).toFixed(2).replace('.',',')+' €';
const ok=m=>elStatus.innerHTML=new Date().toLocaleTimeString('fr-FR')+' — <span class="ok">'+(m||'OK')+'</span>';
const err=m=>elStatus.innerHTML=new Date().toLocaleTimeString('fr-FR')+' — <span class="err">'+(m||'Erreur')+'</span>';
const api = ()=> (elApi.value||'').trim();
function shortSlot(v){
  if(!v) return '';
  if(/^\d{2}:\d{2}$/.test(v)) return v.replace(':','h');
  const d=new Date(v); const h=String(d.getHours()).padStart(2,'0'); const m=String(d.getMinutes()).padStart(2,'0');
  return `${h}h${m}`;
}
function parseBasket(o){
  let b = o.basket ?? o.items ?? [];
  if (typeof b==='string'){ try{ b=JSON.parse(b); }catch{ b=[]; } }
  return Array.isArray(b)?b:[];
}

/* ==== rendu ==== */
function renderTable(list){
  // on crée un id "machine" stable (l’API met souvent id genre PZ-…)
  const normalizeId = o => String(o.id||o.ID||o.Id||o.code||'').trim() || crypto.randomUUID();

  // tri: plus récent en haut (si l’API donne un "date" ou "ts", sinon par ordre reçu)
  list.sort((a,b)=>{
    const ta = +new Date(a.date||a.ts||a.when||0);
    const tb = +new Date(b.date||b.ts||b.when||0);
    return (tb||0)-(ta||0);
  });

  elRows.innerHTML='';
  const seen = new Set();
  let n=list.length;
  list.forEach(o=>{
    const mid = normalizeId(o);
    seen.add(mid);

    // fige HDC la 1ère fois (o.hdc / o.created / date / now)
    if(!HDC.has(mid)){
      const d = o.hdc || o.created || o.date || Date.now();
      const dt = new Date(d);
      HDC.set(mid, `${String(dt.getHours()).padStart(2,'0')}:${String(dt.getMinutes()).padStart(2,'0')}`);
    }
    ORDERS.set(mid,o);

    const tr=document.createElement('tr');
    const TD=(label,html)=>{const c=document.createElement('td');c.setAttribute('data-label',label);c.innerHTML=html;return c;};

    // ID humain décroissant
    tr.appendChild(TD('ID', String(n--)));

    tr.appendChild(TD('Client', o.name||o.client||'' ));
    tr.appendChild(TD('Téléphone', o.phone||'' ));
    tr.appendChild(TD('HDC', (HDC.get(mid)||'').replace(':','h') ));
    tr.appendChild(TD('Horaire', shortSlot(o.slot||o.horaire||'') ));

    const pizzas = (()=> {
      const b = parseBasket(o);
      if(b.length) return b.map(it=>{
        const sup = (it.supplPrice||it.suppl)?` (+${(it.supplPrice||it.suppl)}€ ${it.supplType||'suppl.'})`:'';
        return `${it.name} × ${it.qty||1}${sup}`;
      }).join('<br>');
      return o.pizzas||'';
    })();
    tr.appendChild(TD('Pizzas', pizzas ));

    const comment = o.comment || o.note || o.msg || o.commentaire || '';
    tr.appendChild(TD('Commentaire', comment));

    tr.appendChild(TD('Total', euro(o.total||0)));

    const act=document.createElement('td'); act.className='actions'; act.setAttribute('data-label','Action');
    const x=document.createElement('button'); x.className='btn red small'; x.textContent='✖';
    x.title='Retirer de la vue';
    x.onclick=()=>{ tr.remove(); ORDERS.delete(mid); HDC.delete(mid); };
    act.appendChild(x);
    tr.appendChild(act);

    elRows.appendChild(tr);
  });

  // Détecte nouvelles commandes (id qu’on n’avait pas avant) → son
  const newOnes = list.filter(o=>{
    const mid = String(o.id||o.ID||o.Id||o.code||'').trim();
    return mid && !ORDERS.has(mid);
  });
  if(newOnes.length>0){ try{ ring(); }catch{} }

  ok('OK');
}

/* ==== API ==== */
async function fetchOrders(){
  const url = api();
  const r = await fetch(url+'?list=1',{cache:'no-store'});
  const data = await r.json();
  if(data && data.ok===false) throw new Error(data.error||'réponse invalide');
  return Array.isArray(data?.orders) ? data.orders : (Array.isArray(data?.data) ? data.data : []);
}
async function refresh(){
  try{
    const list = await fetchOrders();
    renderTable(list);
  }catch(e){ console.error(e); err('Erreur réseau'); }
}

/* ==== hooks ==== */
document.getElementById('save').onclick=()=>{
  localStorage.setItem('pizzamigo_api', elApi.value.trim());
  localStorage.setItem('pizzamigo_adm', elAdm.value.trim());
  ok('Paramètres enregistrés');
};
document.getElementById('refresh').onclick=refresh;

/* ==== init ==== */
(function boot(){
  elApi.value = localStorage.getItem('pizzamigo_api') || elApi.value;
  elAdm.value = localStorage.getItem('pizzamigo_adm') || '';
  refresh();
  setInterval(refresh, 10_000);
})();
</script>
</body>
</html>
