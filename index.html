<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Dashboard — PIZZ’AMIGO</title>
<style>
  :root{--bg:#0b0f14;--panel:#101722;--line:#283149;--muted:#b8c2d6;--green:#1fcf7c;--red:#e55252;--accent:#ffb54c}
  *{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:#fff;font-family:system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:1100px;margin:18px auto;padding:0 14px}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:12px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  input,button{border-radius:10px;border:1px solid var(--line);background:#0e1420;color:#fff}
  input{padding:10px;min-width:260px;flex:1}
  .btn{padding:8px 12px;cursor:pointer}
  .btn.primary{background:var(--green);border-color:transparent;color:#001b10}
  .btn.ghost{background:transparent}
  .btn.danger{border-color:#ff8b8b;color:#ffb4b4}
  .status-ok{color:#7dffa9}
  .status-err{color:#ff9b9b}
  table{width:100%;border-collapse:separate;border-spacing:0;margin-top:12px}
  th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.06);vertical-align:top}
  th{color:#cfd6e7;text-align:left;font-weight:600}
  td .chip{border:1px solid var(--line);border-radius:999px;padding:3px 8px;font-size:.9rem}
  td .chip.new{background:rgba(255,181,76,.08);border-color:#b07a2f}
  td .chip.ready{background:rgba(46,204,113,.12);border-color:#2ecc71}
  td .chip.done{opacity:.8}
  .actions{display:flex;gap:6px;flex-wrap:wrap}
  .actions .btn{padding:6px 10px;font-size:.95rem}
  .muted{color:var(--muted)}
  .topbar small{margin-left:8px}
  /* mobile */
  @media (max-width:720px){
    .wrap{padding:0 10px}
    .topbar .row{gap:8px}
    table{font-size:.95rem}
    th:nth-child(3),td:nth-child(3), /* client */
    th:nth-child(4),td:nth-child(4)  /* téléphone */ {display:none}
  }
</style>
</head>
<body>
<div class="wrap">

  <h1 style="margin:6px 0 12px">Dashboard — <b>PIZZ’AMIGO</b></h1>

  <section class="card topbar">
    <div class="row">
      <input id="api" placeholder="https://script.google.com/macros/s/…/exec"/>
      <input id="adm" placeholder="Clé admin (facultatif)" />
      <button id="save" class="btn">Enregistrer</button>
      <button id="refresh" class="btn">Actualiser</button>
      <button id="demo" class="btn">Démo</button>
      <small id="last" class="muted">Dernière mise à jour — <span id="last-txt">—</span></small>
      <small id="net" class="muted"></small>
    </div>
  </section>

  <section class="card">
    <table id="tbl">
      <thead>
        <tr>
          <th>Heure</th>
          <th>ID</th>
          <th>Client</th>
          <th>Téléphone</th>
          <th>Horaire</th>
          <th>Pizzas</th>
          <th>Total</th>
          <th>Statut</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="body">
        <tr><td colspan="9" class="muted">Aucune commande pour le moment.</td></tr>
      </tbody>
    </table>
  </section>

  <!-- sonnerie -->
  <audio id="bell" preload="auto">
    <source src="https://upload.wikimedia.org/wikipedia/commons/3/3f/Service_Bell.help.ogg" type="audio/ogg"/>
  </audio>

</div>

<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PIZZ’AMIGO — Montmerle-sur-Saône</title>
<style>
  :root{
    --bg:#0b0f14;--panel:#101722;--line:#283149;--muted:#b8c2d6;
    --green:#1fcf7c;--red:#e55252;--white:#ffffff;--accent:#ffb54c;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:#fff;font-family:system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:980px;margin:18px auto;padding:0 14px}

  /* entête */
  .brand{display:flex;align-items:center;gap:10px;margin:6px 0 12px}
  .brand .dot{width:10px;height:10px;border-radius:50%;background:#37d36a;box-shadow:0 0 8px #37d36a}
  .brand .name{font-weight:800;letter-spacing:.5px}

  /* bandeau horaires compact */
  .status{display:flex;align-items:center;gap:10px;max-width:max-content;
    border:1px solid rgba(255,255,255,.18);border-radius:999px;padding:8px 12px;background:rgba(0,0,0,.28);backdrop-filter:blur(4px)}
  .status .led{width:10px;height:10px;border-radius:50%}
  .led.closed{background:#ff5c5c;box-shadow:0 0 10px #ff5c5c}
  .led.soon{background:#ffb54c;box-shadow:0 0 10px #ffb54c}
  .led.open{background:#37d36a;box-shadow:0 0 10px #37d36a}

  /* hero */
  .hero{border-radius:18px;overflow:hidden;position:relative;border:1px solid rgba(255,255,255,.08);margin-top:10px}
  .hero img{display:block;width:100%;height:260px;object-fit:cover;filter:contrast(1.05) saturate(1.05)}
  .hero .scrim{position:absolute;inset:0;background:linear-gradient(180deg,rgba(0,0,0,0) 35%,rgba(0,0,0,.75))}
  .hero .txt{position:absolute;left:16px;right:16px;bottom:14px}
  h1{margin:0 0 6px 0;font-size:28px}

  h2{margin:18px 0 8px;font-size:28px}
  p{color:var(--muted);margin:8px 0 16px}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:14px;margin:12px 0}
  .row{display:flex;justify-content:space-between;align-items:center;gap:12px}
  .price{color:var(--green);font-weight:800;white-space:nowrap;min-width:70px;text-align:right}
  .btn{border:1px solid rgba(255,255,255,.25);background:transparent;color:#fff;border-radius:999px;padding:8px 12px;cursor:pointer}
  .btn.ghost{opacity:.85}
  .btn.primary{background:var(--green);color:#001b10;border-color:transparent}
  .btn.red{border-color:#ff8b8b;color:#ffb4b4}

  .item-name{font-size:20px;font-weight:800}
  .item-desc{color:var(--muted)}
  .menu .card{transition:transform .06s ease}
  .menu .card:active{transform:scale(.995)}

  /* barre panier */
  #cart-bar{position:sticky;bottom:0;left:0;right:0;background:rgba(0,0,0,.55);
    backdrop-filter:blur(6px);padding:12px;display:flex;gap:12px;justify-content:center;z-index:50}
  #cart-bar.hidden{display:none}

  /* modal checkout */
  dialog{border:1px solid var(--line);background:var(--panel);color:#fff;border-radius:18px;max-width:760px;width:calc(100% - 24px)}
  dialog::backdrop{background:rgba(0,0,0,.6)}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .slots{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
  .pill{border:1px solid var(--line);border-radius:12px;padding:10px;text-align:center;cursor:pointer}
  .pill.active{outline:2px solid var(--accent);background:rgba(255,181,76,.08)}
  input,textarea{width:100%;border:1px solid var(--line);background:#0e1420;color:#fff;border-radius:10px;padding:10px}
  label{color:#cfd6e7;font-size:.95rem}

  /* infos pratiques */
  .infos{background:linear-gradient(135deg, rgba(32,148,93,.12), rgba(229,82,82,.10));
    border:1px solid var(--line);border-radius:18px;padding:14px}
  .infos h3{margin:6px 0 10px 0}
  .infos a{color:#9ec7ff}

  /* panneau erreur JS (anti page blanche) */
  #err{position:fixed;right:8px;bottom:8px;max-width:92vw;background:#2a1b1b;border:1px solid #5d2f2f;border-radius:10px;padding:10px 12px;display:none;z-index:999}
  #err pre{white-space:pre-wrap;margin:6px 0 0 0;color:#ffd1d1}
  footer{opacity:.75;margin:22px 0 10px;font-size:.95rem}

  /* mobile affiné */
  @media (max-width:560px){
    .hero img{height:220px}
    .item-name{font-size:18px}
    .price{min-width:auto}
    .grid2{grid-template-columns:1fr}
  }
</style>
</head>
<body>
<div class="wrap">

  <!-- entête -->
  <div class="brand">
    <span class="dot"></span>
    <div class="name">PIZZ’AMIGO</div>
  </div>

  <!-- bandeau horaires compact -->
  <div class="status" id="status">
    <span class="led closed" id="led"></span>
    <b id="status-text">Fermé pour le moment — retrouvez-nous ce week-end !</b>
  </div>

  <!-- HERO -->
  <section class="hero">
    <img src="./images/oven.jpg" alt="Four à pizza traditionnel" />
    <div class="scrim"></div>
    <div class="txt">
      <h1>PIZZ’AMIGO — Montmerle-sur-Saône</h1>
      <div style="color:#e8eefc">Le goût authentique de l’Italie près de chez vous.</div>
    </div>
  </section>

  <h2>Notre carte</h2>
  <section id="menu" class="menu"></section>

  <!-- Note boissons déplacée sous la carte -->
  <p class="card" style="margin-top:6px">
    <b>Boissons :</b> réglez en ligne, <b>saveur choisie sur place</b>. Supplément (viande / poisson / œuf / fromage) : <b>+1 €</b> par ajout.
  </p>

  <!-- Barre panier -->
  <div id="cart-bar" class="hidden">
    <span>Panier • <b><span id="cart-total">0,00</span> €</b></span>
    <button class="btn ghost" id="btn-view">Voir panier</button>
    <button class="btn primary" id="btn-checkout">Passer commande</button>
  </div>

  <!-- Modal checkout -->
  <dialog id="checkout">
    <form method="dialog" style="padding:16px">
      <h2 style="margin:4px 0 10px">Finaliser la commande</h2>
      <div id="ck-items" class="card" style="min-height:40px"></div>

      <div class="grid2" style="margin-top:8px">
        <label>Nom*<br><input id="ck-name" placeholder="Votre nom"></label>
        <label>Téléphone*<br><input id="ck-phone" placeholder="06…"></label>
        <label>Heure de retrait*<br><input id="ck-slot" value="19:00"></label>
        <label>Commentaire (optionnel)<br><textarea id="ck-note" placeholder="Sans olives, etc."></textarea></label>
      </div>

      <div class="slots" style="margin:12px 0">
        <div class="pill">18:00</div><div class="pill">18:30</div><div class="pill">19:00</div><div class="pill">19:30</div>
        <div class="pill">20:00</div><div class="pill">20:30</div>
      </div>

      <div style="display:flex;gap:10px;justify-content:flex-end">
        <button class="btn" id="btn-close">Fermer</button>
        <button class="btn primary" id="btn-send">Envoyer la commande</button>
      </div>
    </form>
  </dialog>

  <!-- Infos pratiques -->
  <section class="infos" style="margin-top:18px">
    <h3>Infos pratiques</h3>
    <p><b>Nous trouver :</b></p>
    <ul>
      <li><b>Vendredi soir</b> — Saint-Georges-de-Reneins (Parking Caisse d’épargne) • 18:00–21:00 — <a href="https://maps.apple.com/?q=Saint-Georges-de-Reneins" target="_blank" rel="noopener">Itinéraire</a></li>
      <li><b>Samedi soir</b> — Amareins (carrefour des feux) • 18:00–21:00 — <a href="https://maps.apple.com/?q=Amareins" target="_blank" rel="noopener">Itinéraire</a></li>
      <li><b>Dimanche soir</b> — Amareins (carrefour des feux) • 18:00–21:00 — <a href="https://maps.apple.com/?q=Amareins" target="_blank" rel="noopener">Itinéraire</a></li>
    </ul>
    <p><b>Téléphone :</b> <a href="tel:+33680480456">06 80 48 04 56</a> · <a href="https://facebook.com" target="_blank" rel="noopener">Facebook</a></p>
  </section>

  <footer>© PIZZ’AMIGO — Montmerle-sur-Saône</footer>

  <!-- Panneau erreurs JS (anti page blanche) -->
  <div id="err"><b>Erreur JavaScript</b><pre id="err-msg"></pre></div>
</div>

<script>
  /* ==== Panneau erreur pour éviter les pages blanches ==== */
  function showErr(msg){const b=document.getElementById('err');b.style.display='block';document.getElementById('err-msg').textContent=msg;}
  window.addEventListener('error', e=>showErr(e.message+'\\n'+(e.error&&e.error.stack||'')));
  window.addEventListener('unhandledrejection', e=>showErr('Promise rejetée: '+(e.reason&&e.reason.message||e.reason)));

  /* ==== CONFIG ==== */
  const API_URL = "https://script.google.com/macros/s/AKfycbyePXcqPFPs0uhNOcVM5J5Nq3LCgsrB9UKVOmit1HVoTBzCdZRDCxEntrydbXSyQMXu/exec";
  const SUPPL_PRICE = 1.00;
  const SUPPL_CHOICES = ["viande","poisson","œuf","fromage"];

  /* ==== CARTE COMPLÈTE ==== */
  const MENU = [
    {n:"Margharita", p:7.50, d:"tomate, emmental"},
    {n:"Chasseur", p:8.50, d:"tomate, emmental, champignons"},
    {n:"Sicilienne", p:8.50, d:"tomate, emmental, anchois"},
    {n:"Napolitaine", p:9.00, d:"tomate, emmental, jambon"},
    {n:"Paysanne", p:9.50, d:"tomate, emmental, jambon, œuf"},
    {n:"Capri", p:9.50, d:"tomate, emmental, jambon, champignons"},
    {n:"Mozzarella", p:9.50, d:"tomate, emmental, mozzarella"},
    {n:"Quatre saisons", p:9.50, d:"tomate, emmental, oignons, champignons, poivrons, mozzarella"},
    {n:"Vénitienne", p:9.50, d:"tomate, emmental, roquefort, oignons, crème"},
    {n:"Oslo", p:10.00, d:"tomate, emmental, thon, champignons, crème"},
    {n:"Orientale", p:10.00, d:"tomate, emmental, merguez, poivrons"},
    {n:"Bolognaise", p:10.00, d:"tomate, emmental, viande hachée, crème, mozzarella"},
    {n:"Fermière", p:10.00, d:"tomate, emmental, œuf, lardons, champignons"},
    {n:"Miel", p:10.50, d:"crème, emmental, chèvre frais, miel"},
    {n:"Forestière", p:10.50, d:"tomate, emmental, poulet, champignons, crème"},
    {n:"Lyonnaise", p:11.00, d:"tomate, emmental, saint-marcellin, poulet, crème"},
    {n:"Quatre fromages", p:11.00, d:"tomate, emmental, chèvre, roquefort, mozzarella"},
    {n:"Paradoxe", p:11.00, d:"tomate, emmental, œuf, jambon, chorizo, mozzarella"},
    {n:"Boisée", p:11.00, d:"crème, emmental, pomme de terre, poulet, poivrons, sauce gruyère"},
    {n:"Savoyarde", p:11.00, d:"emmental, lardons, reblochon, pomme de terre, crème"},
    {n:"Carnivore", p:11.50, d:"tomate, emmental, viande hachée, merguez, œuf, mozzarella"},
    {n:"Norvégienne", p:11.50, d:"emmental, saumon fumé, mozzarella, crème"},
    {n:"Burger", p:12.00, d:"tomate, emmental, viande hachée, oignons, cheddar, tomate cerise, sauce burger"},
    {n:"Canette 33cl (choisie sur place)", p:1.50, d:"boisson — saveur choisie sur place", drink:true},
    {n:"Bouteille 50cl (choisie sur place)", p:3.00, d:"boisson — saveur choisie sur place", drink:true},
  ];

  /* ==== PANIER ==== */
  const cart = {
    items: [], // {name,qty,price,suppl:{type?,price}}
    get total(){return this.items.reduce((s,i)=>s + (i.price + (i.suppl?.price||0))*i.qty, 0)},
    add(prod, withSuppl=false, supplType=null){
      const key = prod.n + '|' + (withSuppl?supplType:'');
      const it = this.items.find(i=>i._k===key);
      if(it) it.qty++;
      else this.items.push({_k:key,name:prod.n,qty:1,price:prod.p,suppl: withSuppl?{type:supplType,price:SUPPL_PRICE}:null});
      renderCartBar();
    },
    remove(idx){ this.items.splice(idx,1); renderCartBar(); },
    clear(){ this.items.length=0; renderCartBar(); }
  };

  const euro = v => v.toFixed(2).replace('.', ',');

  /* ==== RENDU CARTE ==== */
  function renderMenu(){
    const root=document.getElementById('menu'); root.innerHTML='';
    MENU.forEach(p=>{
      const el=document.createElement('div'); el.className='card';
      el.innerHTML=`
        <div class="row">
          <div>
            <div class="item-name">${p.n}</div>
            <div class="item-desc">${p.d||''}</div>
          </div>
          <div class="row" style="gap:10px">
            <div class="price">${euro(p.p)} €</div>
            <button class="btn add">Ajouter</button>
          </div>
        </div>`;
      el.querySelector('.add').onclick = ()=>{
        if(p.drink){ // pas de supplément pour boisson
          cart.add(p,false,null); return;
        }
        // libellé "Non / Oui" (OK = Oui, Annuler = Non)
        const yes = confirm("Supplément +1 € ?\nNon / Oui");
        if(!yes){ cart.add(p,false,null); return; }
        const t = prompt("Choisis le type de supplément :\nviande / poisson / œuf / fromage","viande");
        const choice = (t||'').toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'');
        const valid = SUPPL_CHOICES.find(c=>c===choice);
        cart.add(p,true, valid||"viande");
      };
      root.appendChild(el);
    });
  }

  /* ==== BARRE PANIER ==== */
  function renderCartBar(){
    const bar=document.getElementById('cart-bar');
    document.getElementById('cart-total').textContent=euro(cart.total);
    bar.classList.toggle('hidden', cart.items.length===0);
  }

  /* ==== MODAL PANIER ==== */
  function openModal(){
    const m=document.getElementById('checkout'); const list=document.getElementById('ck-items');
    list.innerHTML='';
    cart.items.forEach((it,idx)=>{
      const sup = it.suppl?` (+${euro(it.suppl.price)} € • ${it.suppl.type})`:'';
      const line=document.createElement('div'); line.className='row'; line.style.margin='10px 0'; line.style.borderBottom='1px solid rgba(255,255,255,.08)';
      line.innerHTML=`
        <div><b>${it.name}</b>${sup}</div>
        <div class="row" style="gap:6px">
          <button class="btn" aria-label="moins">−</button>
          <div style="min-width:24px;text-align:center">${it.qty}</div>
          <button class="btn" aria-label="plus">+</button>
          <button class="btn red" aria-label="sup">🗑️</button>
          <div class="price">${euro((it.price+(it.suppl?.price||0))*it.qty)} €</div>
        </div>`;
      line.querySelector('[aria-label="moins"]').onclick=()=>{ if(it.qty>1) it.qty--; else cart.remove(idx); openModal(); renderCartBar(); };
      line.querySelector('[aria-label="plus"]').onclick =()=>{ it.qty++; openModal(); renderCartBar(); };
      line.querySelector('[aria-label="sup"]').onclick  =()=>{ cart.remove(idx); openModal(); };
      list.appendChild(line);
    });
    document.querySelectorAll('.pill').forEach(p=>{
      p.onclick=()=>{ document.querySelectorAll('.pill').forEach(x=>x.classList.remove('active'));
        p.classList.add('active'); document.getElementById('ck-slot').value=p.textContent.trim(); };
    });
    m.showModal();
  }
  function closeModal(){ document.getElementById('checkout').close(); }

  /* ==== ENVOI API (text/plain pour éviter CORS) ==== */
  async function sendOrder(){
    try{
      const name=document.getElementById('ck-name').value.trim();
      const phone=document.getElementById('ck-phone').value.trim();
      const slot=document.getElementById('ck-slot').value.trim();
      const note=document.getElementById('ck-note').value.trim();
      if(!name||!phone||!slot||cart.items.length===0){ alert("Merci de compléter nom, téléphone, horaire et panier."); return; }

      const payload={
        name, phone, slot, note,
        items: cart.items.map(i=>({name:i.name, qty:i.qty, price:i.price, supplType:i.suppl?.type||null, supplPrice:i.suppl?.price||0})),
        total: Number(cart.total.toFixed(2)),
        source: "site"
      };

      const res=await fetch(API_URL,{method:"POST",headers:{"Content-Type":"text/plain;charset=utf-8"},body:JSON.stringify(payload)});
      const txt=await res.text(); let data; try{data=JSON.parse(txt);}catch{data={ok:false,raw:txt};}
      if(!res.ok||!data.ok){ console.error('API fail',res.status,data); alert("Impossible d'envoyer la commande. Merci de réessayer."); return; }

      cart.clear(); closeModal(); alert("Commande enregistrée. Merci !");
    }catch(err){ showErr(String(err)); alert("Impossible d'envoyer la commande. Merci de réessayer."); }
  }

  /* ==== Bandeau horaires (Europe/Paris) ==== */
  function updateStatus(){
    const tz = 'Europe/Paris';
    const now = new Date();
    const fmt = new Intl.DateTimeFormat('fr-FR',{hour:'2-digit',minute:'2-digit',timeZone:tz,hour12:false});
    const h = Number(fmt.format(now).slice(0,2));
    const m = Number(fmt.format(now).slice(3,5));
    const toMin = (H,M)=>H*60+M;
    const cur = toMin(h,m);
    const soonOpen = toMin(17,30);
    const open = toMin(18,0);
    const closeSoon = toMin(20,30);
    const close = toMin(21,0);

    const led = document.getElementById('led');
    const txt = document.getElementById('status-text');

    if (cur < soonOpen){ led.className='led closed'; txt.textContent='Fermé pour le moment — retrouvez-nous ce week-end !'; return; }
    if (cur >= soonOpen && cur < open){ led.className='led soon'; txt.textContent='Ouvre bientôt (dès 17:30)'; return; }
    if (cur >= open && cur < closeSoon){ led.className='led open'; txt.textContent='Ouvert (18:00–21:00)'; return; }
    if (cur >= closeSoon && cur < close){ led.className='led soon'; txt.textContent='Ferme bientôt (20:30)'; return; }
    led.className='led closed'; txt.textContent='Fermé pour le moment — retrouvez-nous ce week-end !';
  }
  setInterval(updateStatus, 60_000);

  /* ==== HOOKS ==== */
  document.getElementById('btn-view').onclick=openModal;
  document.getElementById('btn-checkout').onclick=openModal;
  document.getElementById('btn-close').onclick=(e)=>{e.preventDefault();closeModal();};
  document.getElementById('btn-send').onclick=(e)=>{e.preventDefault();sendOrder();};

  // init
  renderMenu(); renderCartBar(); updateStatus();
</script>
</body>
</html>
/* ===== rendu tableau ===== */
function pizzasLabel(basket){
  // basket: tableau d'items {name, qty, price, supplType?, supplPrice?}
  try{
    const arr = Array.isArray(basket) ? basket
              : (typeof basket==='string' ? JSON.parse(basket) : []);
    if(!arr.length) return '—';
    return arr.map(it=>{
      const sup = (it.supplPrice && it.supplType)
        ? ` (+${String(it.supplPrice).replace('.',',')} € ${it.supplType})` : '';
      return `${it.name} × ${it.qty}${sup}`;
    }).join(', ');
  }catch{
    return '—';
  }
}

function render(rows){
  const tb = $('#body');
  tb.innerHTML = '';
  if(!rows || !rows.length){
    tb.innerHTML = `<tr><td colspan="9" class="muted">Aucune commande pour le moment.</td></tr>`;
    return;
  }
  rows.forEach(o=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${hhmm(o.when)}</td>
      <td>${o.id||'—'}</td>
      <td>${o.name||'—'}</td>
      <td>${o.phone||'—'}</td>
      <td>${hhmm(o.slot)||'—'}</td>
      <td>${pizzasLabel(o.basket||o.items||[])}</td>
      <td>${formatMoney(o.total)}</td>
      <td><span class="chip ${o.status==='ready'?'ready':o.status==='done'?'done':'new'}">${o.status||'new'}</span></td>
      <td class="actions">
        <button class="btn" data-act="ready">Prête</button>
        <button class="btn" data-act="done">Terminée</button>
        <button class="btn" data-act="cancel">Annuler</button>
        <button class="btn danger" title="Retirer de l’affichage" data-act="hide">❌</button>
      </td>`;
    tr.querySelectorAll('button[data-act]').forEach(b=>{
      b.addEventListener('click', async (e)=>{
        const act = e.currentTarget.getAttribute('data-act');
        if(act==='hide'){ tr.remove(); return; } // suppression manuelle de l’affichage uniquement
        await updateStatus(o.id, act);
        // maj visuelle simple
        if(act==='ready') tr.querySelector('.chip').textContent='ready', tr.querySelector('.chip').className='chip ready';
        if(act==='done') tr.querySelector('.chip').textContent='done',  tr.querySelector('.chip').className='chip done';
        if(act==='cancel') tr.querySelector('.chip').textContent='canceled';
      });
    });
    tb.appendChild(tr);
  });
}

/* ===== appels API ===== */
async function apiGetToday(){
  if(!API){ $('#net').textContent='Renseigne l’URL de l’API'; return []; }
  $('#net').textContent = 'Chargement…';
  try{
    const r = await fetch(`${API}?list=1`, {cache:'no-store'});
    const js = await r.json(); // {ok:true, orders:[...]}
    if(!r.ok || !js.ok) throw new Error(js.error||('HTTP '+r.status));
    $('#net').textContent = 'OK';
    $('#last-txt').textContent = `${nowStr()} — OK`;
    return js.orders||[];
  }catch(err){
    console.error(err);
    $('#net').textContent = 'Erreur réseau';
    $('#last-txt').textContent = `${nowStr()} — Erreur`;
    return [];
  }
}

async function sendDemo(){
  if(!API){ alert("Renseigne l’URL de l’API d’abord."); return; }
  try{
    const payload = {
      name:"Test JSONP",
      phone:"0600000000",
      slot:"19:30",
      items:[{name:"Margharita", qty:1, price:7.5, supplType:null, supplPrice:0}],
      total:7.5,
      source:"demo"
    };
    const r = await fetch(API, {
      method:'POST',
      headers:{'Content-Type':'text/plain;charset=utf-8'},
      body: JSON.stringify(payload)
    });
    const txt = await r.text(); let js;
    try{ js = JSON.parse(txt); }catch{ js = {ok:false, raw:txt}; }
    if(!r.ok || !js.ok) throw new Error(js.error||('HTTP '+r.status));
    // rafraîchit + son
    try{ bell.currentTime = 0; bell.play().catch(()=>{}); }catch{}
    await refresh();
  }catch(err){
    console.error(err);
    alert("Échec d’envoi de la démo.");
  }
}

async function updateStatus(id, next){
  if(!API || !id) return;
  try{
    await fetch(API, {
      method:'POST',
      headers:{'Content-Type':'text/plain;charset=utf-8'},
      body: JSON.stringify({admin: ADMIN||'', action:'status', id, to: next})
    });
  }catch(e){ console.warn(e); }
}

/* ===== actions UI ===== */
async function refresh(){
  const rows = await apiGetToday();
  render(rows);
}

$('#save').addEventListener('click', ()=>{
  API = $('#api').value.trim();
  ADMIN = $('#adm').value.trim();
  localStorage.setItem('pizz_api', API);
  localStorage.setItem('pizz_admin', ADMIN);
  refresh();
});
$('#refresh').addEventListener('click', refresh);
$('#demo').addEventListener('click', sendDemo);

// auto-ping (ne supprime rien, juste charge les nouveautés)
setInterval(refresh, 15_000);

// init
refresh();
</script>
</body>
</html>
