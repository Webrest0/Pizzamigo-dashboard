<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Dashboard â€” PIZZâ€™AMIGO</title>
<style>
  :root{
    --bg:#0b0f14;--panel:#101722;--line:#283149;--muted:#b8c2d6;
    --green:#1fcf7c;--red:#e55252;--white:#ffffff;--accent:#ffb54c;
  }
  *{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:#fff;font-family:system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:1100px;margin:16px auto;padding:0 12px}
  h1{margin:0 0 12px;font-size:32px;letter-spacing:.4px}
  .bar{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:10px 12px}
  .bar .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .inp, .btn, .pill{border-radius:12px;border:1px solid var(--line);background:#0e1420;color:#fff}
  .inp{padding:10px 12px;min-width:260px;flex:1}
  .btn{padding:8px 12px;background:#162033;border-color:#2a3655;cursor:pointer}
  .btn.primary{background:var(--green);color:#001b10;border-color:transparent}
  .btn.red{border-color:#ff8b8b;color:#ffb4b4}
  .muted{color:var(--muted)}
  .t{width:100%;border-collapse:collapse;margin-top:12px}
  .t th,.t td{border-bottom:1px solid rgba(255,255,255,.08);padding:10px 8px;vertical-align:top}
  .t th{color:#cdd7ef;text-align:left;font-weight:700}
  .status{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:4px 8px;min-width:54px;text-align:center}
  .status[data-s="new"]{background:#18202e}
  .status[data-s="ready"]{background:#13281f;border-color:#1f824e}
  .status[data-s="done"]{background:#1f1f33;border-color:#5050b5}
  .row-actions{display:flex;gap:6px;flex-wrap:wrap}
  #err{position:fixed;right:8px;bottom:8px;max-width:92vw;background:#2a1b1b;border:1px solid #5d2f2f;border-radius:10px;padding:10px 12px;display:none;z-index:999}
  #err pre{white-space:pre-wrap;margin:6px 0 0 0;color:#ffd1d1}
  @media (max-width:720px){
    .wrap{padding:0 8px}
    .inp{min-width:200px}
    .t th:nth-child(2), .t td:nth-child(2){display:none} /* cache l'ID sur mobile */
  }
</style>
</head>
<body>
<div class="wrap">
  <h1>Dashboard â€” PIZZâ€™AMIGO</h1>

  <div class="bar">
    <div class="row">
      <input id="api" class="inp" placeholder="URL de lâ€™API (Google Apps Script)">
      <input id="adm" class="inp" placeholder="ClÃ© admin (facultatif)">
    </div>
    <div class="row" style="margin-top:8px">
      <button id="save" class="btn">Enregistrer</button>
      <button id="refresh" class="btn">Actualiser</button>
      <span id="net" class="muted" style="margin-left:auto">â€”</span>
    </div>
    <div class="row" style="margin-top:8px">
      <label class="pill" style="display:flex;align-items:center;gap:8px">
        <span>ðŸ”” Activer le son</span>
        <input id="snd" type="checkbox" style="accent-color:#1fcf7c">
      </label>
      <span>Son :</span>
      <input id="vol" type="range" min="0" max="1" step="0.01" style="flex:1">
    </div>
  </div>

  <table class="t" id="tab">
    <thead>
      <tr>
        <th>Heure</th>
        <th>ID</th>
        <th>Client</th>
        <th>TÃ©lÃ©phone</th>
        <th>Horaire</th>
        <th>Pizzas</th>
        <th>Total</th>
        <th>Statut</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="rows"></tbody>
  </table>
</div>

<div id="err"><b>Erreur JavaScript</b><pre id="err-msg"></pre></div>

<script>
function showErr(e){
  const box=document.getElementById('err');
  const msg=(e && e.message)||String(e);
  box.style.display='block';
  document.getElementById('err-msg').textContent=msg;
}

const S = {
  list: [], lastIds: new Set(), bell:null, pollMs: 12_000
};
const store = {
  k:'PZ_DASH_V4',
  read(){ try{return JSON.parse(localStorage.getItem(this.k)||'{}')}catch{return{}} },
  write(o){ localStorage.setItem(this.k, JSON.stringify(o)) }
};
const apiURL=()=>document.getElementById('api').value.trim();
const adminKey=()=>document.getElementById('adm').value.trim();
const euro=v=>(Number(v)||0).toFixed(2).replace('.',',')+' â‚¬';
const hhmm=s=>/^\d{1,2}:\d{2}$/.test(s)?s:new Date(s).toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'});
async function getJSON(q){const r=await fetch(apiURL()+(q||'')+'&_='+Date.now());return r.json();}
async function postJSON(obj){const r=await fetch(apiURL(),{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify(obj)});return r.json();}

function render(){
  const tb=document.getElementById('rows');tb.innerHTML='';
  for(const o of S.list){
    const tr=document.createElement('tr');
    const pizzas=(o.basket||o.items||[]).map(it=>`${it.name} Ã— ${it.qty||1}`).join('<br>');
    tr.innerHTML=`
      <td>${o.when||''}</td>
      <td>${o.id||''}</td>
      <td>${o.name||''}</td>
      <td>${o.phone||''}</td>
      <td>${hhmm(o.slot||'')}</td>
      <td>${pizzas}</td>
      <td>${euro(o.total)}</td>
      <td><span class="status" data-s="${o.status||'new'}">${o.status||'new'}</span></td>
      <td class="row-actions"></td>`;
    const act=tr.querySelector('.row-actions');
    [['ready','PrÃªte'],['done','TerminÃ©e'],['canceled','Annuler']].forEach(([s,l])=>{
      const b=document.createElement('button');b.className='btn';b.textContent=l;
      b.onclick=()=>updateStatus(o.id,s);act.appendChild(b);
    });
    const del=document.createElement('button');del.className='btn red';del.textContent='Supprimer';
    del.onclick=()=>deleteOrder(o.id);act.appendChild(del);
    tb.appendChild(tr);
  }
}
async function refreshNow(){
  try{
    document.getElementById('net').textContent='Chargementâ€¦';
    const d=await getJSON('?list=1');
    S.list=d.orders||[];
    render();
    document.getElementById('net').textContent=new Date().toLocaleTimeString('fr-FR')+' â€” OK';
  }catch(e){showErr(e);document.getElementById('net').textContent='Erreur';}
}
async function updateStatus(id,status){await postJSON({action:'status',id,status,adminKey:adminKey()});refreshNow();}
async function deleteOrder(id){if(!confirm("Supprimer cette commande ?"))return;await postJSON({action:'delete',id,adminKey:adminKey()});refreshNow();}
function ring(){if(!S.bell){S.bell=new Audio('https://cdn.jsdelivr.net/gh/naptha/tinyfiles@master/chime.mp3');}S.bell.volume=+document.getElementById('vol').value;S.bell.play().catch(()=>{});}
function init(){
  const p=store.read();document.getElementById('api').value=p.api||'';document.getElementById('adm').value=p.adm||'';
  document.getElementById('snd').checked=!!p.snd;document.getElementById('vol').value=p.vol||0.8;
  document.getElementById('save').onclick=()=>store.write({api:apiURL(),adm:adminKey(),snd:document.getElementById('snd').checked,vol:document.getElementById('vol').value});
  document.getElementById('refresh').onclick=refreshNow;
  setInterval(refreshNow,S.pollMs);refreshNow();
}
window.addEventListener('error',e=>showErr(e));init();
</script>
</body>
</html>
