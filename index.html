<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Dashboard — PIZZ’AMIGO</title>
<style>
  :root{--bg:#0b0f14;--panel:#111827;--line:#26334d;--green:#19c37d;--text:#e6edf3;--muted:#aab6c8}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:15px/1.45 system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:1100px;margin:18px auto;padding:0 12px}
  h1{margin:6px 0 12px}
  .bar{display:flex;gap:10px;align-items:center;background:var(--panel);border:1px solid var(--line);border-radius:10px;padding:10px}
  .bar input{flex:1;min-width:420px;background:#0c1424;border:1px solid var(--line);border-radius:8px;color:var(--text);padding:8px}
  .btn{border:0;border-radius:8px;padding:8px 12px;cursor:pointer}
  .btn.primary{background:var(--green);color:#062012}
  .btn.blue{background:#2d6cdf;color:#fff}
  .meta{color:var(--muted);margin:8px 0}
  table{width:100%;border-collapse:collapse;background:var(--panel);border:1px solid var(--line);border-radius:10px;overflow:hidden}
  th,td{border-bottom:1px solid var(--line);padding:8px;vertical-align:top}
  .status{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--line);font-size:12px}
  .status.new{background:#0e3a23;color:#99ffd0}
  .err{color:#ff9b9b}
</style>
</head>
<body>
<div class="wrap">
  <h1>Dashboard — PIZZ’AMIGO</h1>

  <div class="bar">
    <span>API :</span>
    <input id="api" value="https://script.google.com/macros/s/AKfycbwx0-kGoDni0BwmZm7tRWbWOUBeM3uvVYeUoxqXqCRsL0aIT8PwzUJ9myIJT-IJJ1ldrg/exec">
    <span>Clé admin (facultatif) :</span>
    <input id="key" placeholder="ex: PIZZAMIGO-ADMIN-123">
    <button class="btn" id="save">Enregistrer</button>
    <button class="btn blue" id="refresh">Actualiser</button>
    <button class="btn primary" id="demo">Demo</button>
  </div>

  <div class="meta">Dernière mise à jour — <span id="ts">—</span> <span id="err" class="err"></span></div>

  <table>
    <thead><tr>
      <th>Heure</th><th>ID</th><th>Client</th><th>Téléphone</th>
      <th>Horaire</th><th>Pizzas</th><th>Total</th><th>Statut</th>
    </tr></thead>
    <tbody id="rows"><tr><td colspan="8">Aucune commande pour le moment.</td></tr></tbody>
  </table>
</div>

<script>
  const $ = s=>document.querySelector(s);
  const apiIn = $('#api'), keyIn = $('#key'), ts = $('#ts'), err = $('#err'), rows = $('#rows');

  // pré-rempli + charge depuis localStorage si déjà enregistré
  apiIn.value = localStorage.getItem('dz_api') || apiIn.value;
  keyIn.value = localStorage.getItem('dz_key') || '';

  $('#save').onclick = ()=>{
    localStorage.setItem('dz_api', apiIn.value.trim());
    localStorage.setItem('dz_key', keyIn.value.trim());
    err.textContent = ''; ts.textContent = '—';
    alert('Réglages enregistrés.');
  };

  // ===== JSONP (pas de CORS) =====
  function loadOrders(){
    err.textContent = '';
    rows.innerHTML = '<tr><td colspan="8">Chargement…</td></tr>';

    const API = apiIn.value.trim();
    if(!API){ err.textContent = 'Renseigne l’URL de l’API.'; return; }

    const cb = 'onOrders_' + Math.random().toString(36).slice(2);
    window[cb] = (data)=>{
      cleanup();
      if(!data || data.ok!==true){ err.textContent = 'Réponse invalide.'; return; }
      render(data.orders||[]);
    };

    const t = setTimeout(()=>{ cleanup(); err.textContent = 'Erreur réseau (timeout)'; }, 8000);

    const src = API + '?list=1&jsonp=' + cb + (keyIn.value.trim()?('&key='+encodeURIComponent(keyIn.value.trim())):'');
    const s = document.createElement('script');
    s.src = src; s.id = 'jsonp';
    document.body.appendChild(s);

    function cleanup(){
      clearTimeout(t);
      const el = document.getElementById('jsonp'); if(el) el.remove();
      delete window[cb];
    }
  }

  function render(orders){
    ts.textContent = new Date().toLocaleTimeString('fr-FR');
    if(!orders.length){ rows.innerHTML = '<tr><td colspan="8">Aucune commande pour le moment.</td></tr>'; return; }
    rows.innerHTML = '';
    orders.forEach(o=>{
      const tr = document.createElement('tr');
      const pizzas = (o.items||[]).map(i=> `${i.name} × ${i.qty}`).join('<br>');
      tr.innerHTML = `
        <td>${o.when?.slice(11,16) || '-'}</td>
        <td>${o.id||'-'}</td>
        <td>${o.name||'-'}</td>
        <td>${o.phone||'-'}</td>
        <td>${o.slot||'-'}</td>
        <td>${pizzas||'-'}</td>
        <td>${(o.total??0).toFixed(2).replace('.',',')} €</td>
        <td><span class="status new">${o.status||'new'}</span></td>`;
      rows.appendChild(tr);
    });
  }

  $('#refresh').onclick = loadOrders;

  // DEMO → ajoute une commande via ?demo=1 (côté Apps Script) puis recharge
  $('#demo').onclick = ()=>{
    const API = apiIn.value.trim(); if(!API){ alert('Renseigne l’URL API d’abord.'); return; }
    const url = API + '?demo=1' + (keyIn.value.trim()?('&key='+encodeURIComponent(keyIn.value.trim())):'');
    fetch(url, {mode:'no-cors'}).catch(()=>{}).finally(()=> setTimeout(loadOrders, 700));
  };

  // auto-refresh toutes les 5 s
  setInterval(()=>{ if(apiIn.value.trim()) loadOrders(); }, 5000);
  if(apiIn.value.trim()) loadOrders();
</script>
</body>
</html>
