<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Dashboard â€” PIZZâ€™AMIGO</title>
<style>
  :root{
    --bg:#0b0f14; --panel:#101722; --line:#283149; --muted:#b8c2d6; --red:#e55252;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:#fff;font-family:system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:1024px;margin:18px auto;padding:0 14px}

  h1{margin:0 0 12px;font-size:24px}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:12px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  input[type="text"]{width:100%;max-width:680px;border:1px solid var(--line);background:#0e1420;color:#fff;border-radius:10px;padding:10px}
  .btn{border:1px solid rgba(255,255,255,.25);background:transparent;color:#fff;border-radius:999px;padding:8px 12px;cursor:pointer}
  .btn.red{border-color:#ff8b8b;color:#ffb4b4}
  .muted{color:var(--muted)}
  .ok{color:#1fcf7c}
  .err{color:#ff9a9a}

  table{width:100%;border-collapse:separate;border-spacing:0 10px}
  thead th{padding:10px;text-align:left;color:#dfe8ff}
  tbody td{background:#0f1623;border-top:1px solid var(--line);border-bottom:1px solid var(--line);padding:12px 14px;vertical-align:top}
  tbody td:first-child{border-left:1px solid var(--line);border-top-left-radius:12px;border-bottom-left-radius:12px}
  tbody td:last-child{border-right:1px solid var(--line);border-top-right-radius:12px;border-bottom-right-radius:12px}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  .actions .btn{padding:6px 10px}

  /* Mobile : table -> cartes + interlignes pour bien sÃ©parer */
  @media (max-width: 720px){
    table, thead, tbody, th, td, tr{display:block}
    thead{display:none}
    tbody tr{margin:14px 0}
    tbody td{border:1px solid var(--line);border-radius:12px;margin:8px 0;padding:12px}
    tbody td::before{content:attr(data-label);display:block;font-size:.9rem;color:var(--muted);margin-bottom:4px}
    .actions{display:flex;gap:10px;flex-wrap:wrap}
  }

  .vol{display:flex;align-items:center;gap:8px;margin-left:auto}
  .vol input[type=range]{width:180px}
</style>
</head>
<body>
<div class="wrap">
  <h1>Dashboard â€” PIZZâ€™AMIGO</h1>

  <div class="panel">
    <div class="row">
      <input id="api" type="text" placeholder="URL de lâ€™API"
        value="https://script.google.com/macros/s/AKfycbyePXcqPFPs0uhNOcVM5J5Nq3LCgsrB9UKVOmit1HVoTBzCdZRDCxEntrydbXSyQMXu/exec">
      <button id="save" class="btn">Enregistrer</button>
      <button id="refresh" class="btn">Actualiser</button>

      <!-- Son : activer + volume -->
      <button id="enableSound" class="btn">ðŸ”” Activer le son</button>
      <div class="vol">
        <span class="muted">Volume :</span>
        <input id="volume" type="range" min="0" max="100" step="1">
      </div>

      <!-- cloche -->
      <audio id="bell" preload="auto">
        <!-- petite cloche douce -->
        <source src="https://cdn.freesound.org/previews/341/341695_5260877-lq.mp3" type="audio/mpeg">
      </audio>
    </div>
    <div id="status" class="muted" style="margin-top:8px">â€”</div>
  </div>

  <div class="panel" style="margin-top:12px">
    <table>
      <thead>
        <tr>
          <th style="width:50px">#</th>
          <th>Client</th>
          <th>TÃ©lÃ©phone</th>
          <th>Horaire</th>
          <th>Pizzas</th>
          <th style="width:90px">Total</th>
          <th style="width:80px">Action</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </div>

  <!-- Panneau erreurs -->
  <div id="err" class="panel" style="display:none;margin-top:12px;background:#2a1b1b;border-color:#5d2f2f">
    <b>Erreur JavaScript</b>
    <pre id="err-msg" style="white-space:pre-wrap;margin:8px 0 0;color:#ffd1d1"></pre>
  </div>
</div>

<script>
/* Anti page blanche */
function showErr(msg){const p=document.getElementById('err');p.style.display='block';document.getElementById('err-msg').textContent=msg;}
window.addEventListener('error', e=>showErr(e.message+'\n'+(e.error&&e.error.stack||'')));
window.addEventListener('unhandledrejection', e=>showErr('Promise rejetÃ©e: '+(e.reason&&e.reason.message||e.reason)));

/* Elts & state */
const elApi = document.getElementById('api');
const elRows = document.getElementById('rows');
const elStatus = document.getElementById('status');
const elBell = document.getElementById('bell');
const elEnable = document.getElementById('enableSound');
const elVol = document.getElementById('volume');

let COUNTER = 0;                   // compteur dâ€™affichage (#)
let KNOWN = new Set();             // ids dÃ©jÃ  connus (pour dÃ©clencher le son uniquement sur nouvelles)
let soundReady = false;

/* Helpers */
const euro = v => (Number(v)||0).toFixed(2).replace('.',',');
const nowStr = () => new Date().toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
const api = () => (elApi.value||'').trim();
const ok  = m => elStatus.innerHTML = `${nowStr()} â€” <span class="ok">${m||'OK'}</span>`;
const err = m => elStatus.innerHTML = `${nowStr()} â€” <span class="err">${m||'Erreur'}</span>`;

function getStamp(o){
  // ordre : o.ts (num), Date.parse(o.date), timestamp prÃ©sent dans lâ€™ID ex: PZ-1759013405323
  if(typeof o.ts === 'number') return o.ts;
  const d = Date.parse(o.date||o.when||'');
  if(!isNaN(d)) return d;
  const m = String(o.id||'').match(/\d{10,}/);
  return m ? Number(m[0]) : 0;
}
function shortSlot(v){
  if(!v) return '';
  if(/^\d{2}:\d{2}$/.test(v)) return v.replace(':','h');
  const t = Date.parse(v);
  if(!isNaN(t)){ const d=new Date(t); return `${String(d.getHours()).padStart(2,'0')}h${String(d.getMinutes()).padStart(2,'0')}`; }
  return String(v).replace(':','h');
}
function parseBasket(o){
  let b = o.basket ?? o.items ?? [];
  if (typeof b === 'string'){ try{ b = JSON.parse(b); }catch{ b = []; } }
  return Array.isArray(b) ? b : [];
}

/* ===== Son : activation persistante + volume ===== */
function setVolumeFromLS(){
  const v = Number(localStorage.getItem('pizzamigo_vol') ?? 70);
  elVol.value = isNaN(v) ? 70 : v;
  elBell.volume = Math.max(0, Math.min(1, (elVol.value|0)/100));
}
elVol.addEventListener('input', ()=>{
  elBell.volume = Math.max(0, Math.min(1, (elVol.value|0)/100));
  localStorage.setItem('pizzamigo_vol', elVol.value);
});

async function enableSound(){
  try{
    // Un petit play/pause pour "dÃ©bloquer" l'audio dans le navigateur
    await elBell.play();
    elBell.pause(); elBell.currentTime = 0;
    soundReady = true;
    localStorage.setItem('pizzamigo_sound','1');
    elEnable.style.display='none';
  }catch(e){ console.warn("Audio bloquÃ© par le navigateur (besoin d'un clic)", e); }
}
elEnable.addEventListener('click', enableSound);

function pingBell(){
  if(!soundReady) return;        // besoin dâ€™une activation utilisateur au moins une fois
  try{
    elBell.currentTime = 0;
    elBell.play().catch(()=>{});
  }catch(e){}
}

/* Rendu */
function renderTable(list){
  // tri : plus rÃ©centes en haut
  list.sort((a,b)=>getStamp(b)-getStamp(a));

  // dÃ©tecte les nouvelles AVANT de mettre Ã  jour KNOWN
  const newOnes = list.filter(o => !KNOWN.has(String(o.id||'')));

  // (rÃ©)affiche
  elRows.innerHTML = '';
  COUNTER = 0;
  list.forEach(o=>{
    COUNTER++;
    const id = String(o.id||COUNTER);

    const tr = document.createElement('tr');
    const td = (label, html)=>{const c=document.createElement('td'); c.setAttribute('data-label',label); c.innerHTML=html; return c;};

    tr.appendChild(td('#', COUNTER));
    tr.appendChild(td('Client', o.name||o.client||''));
    tr.appendChild(td('TÃ©lÃ©phone', o.phone||''));
    tr.appendChild(td('Horaire', shortSlot(o.slot||o.horaire||'')));

    const basket = parseBasket(o);
    const pizzas = basket.length
      ? basket.map(it=>{
          const sup = (it.supplPrice||it.suppl) ? ` (+${(it.supplPrice||it.suppl)}â‚¬ ${it.supplType||'suppl.'})` : '';
          return `${it.name} Ã— ${it.qty||1}${sup}`;
        }).join('<br>')
      : (o.pizzas||'');
    tr.appendChild(td('Pizzas', pizzas));
    tr.appendChild(td('Total', `${euro(o.total||0)} â‚¬`));

    const act = document.createElement('td'); act.className='actions';
    const x=document.createElement('button'); x.className='btn red'; x.textContent='âœ–'; x.title='Retirer';
    x.onclick=()=>{ tr.remove(); /* local seulement */ };
    act.appendChild(x);
    tr.appendChild(act);

    elRows.appendChild(tr);
  });

  // met Ã  jour les IDs connus & joue la cloche si nouvelles commandes
  if(newOnes.length>0) pingBell();
  KNOWN = new Set(list.map(o=>String(o.id||'')));
}

/* API */
async function getList(){
  try{
    const url = api();
    if(!url) return err('Renseigne lâ€™URL de lâ€™API');
    const r = await fetch(url+'?list=1',{cache:'no-store'});
    const data = await r.json();
    const orders = Array.isArray(data?.orders) ? data.orders
                  : Array.isArray(data?.data)   ? data.data
                  : [];
    renderTable(orders);
    ok('OK');
  }catch(e){ console.error(e); err('Erreur rÃ©seau'); }
}

/* Hooks & init */
document.getElementById('save').onclick = ()=>{
  localStorage.setItem('pizzamigo_api', elApi.value.trim());
  ok('ParamÃ¨tres enregistrÃ©s');
};
document.getElementById('refresh').onclick = getList;

(function boot(){
  elApi.value = localStorage.getItem('pizzamigo_api') || elApi.value;
  setVolumeFromLS();

  // Si l'utilisateur a dÃ©jÃ  activÃ© le son auparavant, on le prÃ©pare automatiquement
  if(localStorage.getItem('pizzamigo_sound') === '1'){
    soundReady = true;
    elEnable.style.display='none';
  }

  getList();
  setInterval(getList, 10000);
})();
</script>
</body>
</html>
