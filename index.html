/***** PIZZ'AMIGO API — v2 *****/

// Nom de l'onglet
const SHEET_NAME = 'Commandes';

// Colonnes attendues (en-têtes en ligne 1 du Sheet)
const HEADERS = [
  'date',      // A
  'id',        // B
  'name',      // C
  'phone',     // D
  'slot',      // E
  'panier',    // F (JSON string)
  'total',     // G (nombre)
  'status',    // H (new, ready, done, canceled)
  'source'     // I (site, demo, etc.)
];

/* ------------ utils ------------- */
function _sheet() {
  const sh = SpreadsheetApp.getActive().getSheetByName(SHEET_NAME);
  if (!sh) throw new Error(`Feuille "${SHEET_NAME}" introuvable.`);
  return sh;
}

function _respond(obj, eParam) {
  const out = ContentService
    .createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
  return out;
}

function _todayYYYYMMDD() {
  const tz = Session.getScriptTimeZone() || 'Europe/Paris';
  const d = Utilities.formatDate(new Date(), tz, 'yyyy-MM-dd');
  return d; // ex: 2025-09-27
}

/* ----------- GET : liste commandes du jour ----------- */
function doGet(e) {
  try {
    const p = e && e.parameter ? e.parameter : {};
    if (p.ping) return _respond({ ok: true, status: 'up' });

    const sh = _sheet();
    const lastRow = sh.getLastRow();
    const lastCol = sh.getLastColumn();
    if (lastRow < 2) return _respond({ ok: true, orders: [] });

    // lecture rapide sans la ligne d'en-têtes
    const values = sh.getRange(2, 1, lastRow - 1, lastCol).getValues();
    const idx = {}; HEADERS.forEach((h, i) => idx[h] = i); // A->0, B->1, ...

    const today = _todayYYYYMMDD();

    // Ne filtre QUE sur la date du jour (pas de filtre "source" ni "status")
    const orders = values
      .filter(r => String(r[idx['date']]).startsWith(today))
      .map(r => {
        let basket = [];
        try { basket = JSON.parse(String(r[idx['panier']]) || '[]'); } catch(_){}
        return {
          id:      String(r[idx['id']] || ''),
          when:    String(r[idx['date']] || ''),   // date/heure brute
          name:    String(r[idx['name']] || ''),
          phone:   String(r[idx['phone']] || ''),
          slot:    String(r[idx['slot']] || ''),   // 18:00, 18:30, ...
          basket,                                 // tableau [{label, qty, price, ...}]
          total:   Number(r[idx['total']] || 0),
          status:  String(r[idx['status']] || 'new'),
          source:  String(r[idx['source']] || '')
        };
      });

    return _respond({ ok: true, orders });

  } catch (err) {
    return _respond({ ok: false, error: String(err) });
  }
}

/* ----------- POST : ajout d’une commande ----------- */
function doPost(e) {
  try {
    const body = e && e.postData && e.postData.contents ? e.postData.contents : '{}';
    const data = JSON.parse(body);

    // champs attendus côté site :
    // name, phone, slot, panier (array), total, source ('site')
    const now = new Date();
    const tz = Session.getScriptTimeZone() || 'Europe/Paris';
    const when = Utilities.formatDate(now, tz, 'yyyy-MM-dd HH:mm:ss'); // pour la colonne A
    const id   = 'PZ-' + Utilities.getUuid().slice(0,8).toUpperCase(); // colonne B

    const sh = _sheet();
    sh.appendRow([
      when,                // date
      id,                  // id
      data.name || '',     // name
      data.phone || '',    // phone
      data.slot || '',     // slot
      JSON.stringify(data.panier || []), // panier (JSON)
      Number(data.total || 0),           // total
      'new',               // status par défaut
      String(data.source || 'site')      // source
    ]);

    return _respond({ ok: true, id });

  } catch (err) {
    return _respond({ ok: false, error: String(err) });
  }
}
