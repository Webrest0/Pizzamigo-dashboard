<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Dashboard â€” PIZZâ€™AMIGO</title>
<style>
  :root{--bg:#0b0f14;--panel:#101722;--line:#283149;--muted:#b8c2d6;--green:#1fcf7c;--red:#e55252;--accent:#ffb54c}
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:#fff;font-family:system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:1100px;margin:18px auto;padding:0 14px}
  h1{margin:0 0 10px 0;font-size:26px}
  .panel{border:1px solid var(--line);border-radius:14px;padding:12px;background:#0f1622}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  input[type=text]{width:100%;max-width:560px;border:1px solid var(--line);background:#0f1622;color:#fff;border-radius:10px;padding:8px}
  button{border:1px solid rgba(255,255,255,.25);background:transparent;color:#fff;border-radius:10px;padding:8px 10px;cursor:pointer}
  button.primary{background:var(--green);color:#001b10;border-color:transparent}
  button.warn{background:#2a1b1b;border-color:#6c3b3b}
  .muted{color:var(--muted)}
  table{width:100%;border-collapse:separate;border-spacing:0}
  th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.08);vertical-align:top}
  th{color:#cdd7ee;text-align:left;font-weight:600}
  .tag{border:1px solid var(--line);padding:4px 8px;border-radius:999px;display:inline-block}
  .tag.new{border-color:#6c7cff}
  .tag.ready{border-color:#ffb54c;color:#ffb54c}
  .tag.done{border-color:#6cffb0;color:#6cffb0}
  .tag.cancel{border-color:#ff8b8b;color:#ffb4b4}
  .actions button{margin-right:6px}
  .pill{border:1px solid var(--line);border-radius:999px;padding:6px 10px}
  #err{position:fixed;right:10px;bottom:10px;display:none;max-width:92vw;background:#2a1b1b;border:1px solid #5d2f2f;border-radius:10px;padding:10px 12px}
  #err pre{white-space:pre-wrap;margin:6px 0 0 0;color:#ffd1d1}
  @media (max-width: 680px){
    th:nth-child(3), td:nth-child(3){display:none} /* tÃ©lÃ©phone masquÃ© sur mobile */
    th:nth-child(6), td:nth-child(6){display:none} /* total masquÃ© si petit Ã©cran */
  }
</style>
</head>
<body>
<div class="wrap">

  <h1>Dashboard â€” PIZZâ€™AMIGO</h1>

  <div class="panel" style="margin-bottom:12px">
    <div class="row">
      <input id="api" type="text" placeholder="URL de lâ€™API Apps Script"
             value="https://script.google.com/macros/s/AKfycbyePXcqPFPs0uhNOcVM5J5Nq3LCgsrB9UKVOmit1HVoTBzCdZRDCxEntrydbXSyQMXu/exec">
      <input id="adm" type="text" placeholder="ClÃ© admin (facultatif)" value="PIZZAMIGO-ADMIN-123" style="max-width:240px">
      <button id="save">Enregistrer</button>
      <button id="refresh">Actualiser</button>
      <button id="demo">DÃ©mo</button>
      <span class="muted" id="status">â€’</span>
      <span class="pill" id="sound-pill">ðŸ”Š Activer le son</span>
    </div>
  </div>

  <div class="panel">
    <table id="tbl">
      <thead>
        <tr>
          <th>Heure</th>
          <th>ID</th>
          <th>Client</th>
          <th>TÃ©lÃ©phone</th>
          <th>Horaire</th>
          <th>Total</th>
          <th>Statut</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="body">
        <tr><td colspan="8" class="muted">Aucune commande sur les derniÃ¨res 24 h.</td></tr>
      </tbody>
    </table>
  </div>

  <div id="err"><b>Erreur JavaScript</b><pre id="err-msg"></pre></div>
</div>

<!-- petit ding intÃ©grÃ© (1s) -->
<audio id="ding" preload="auto">
  <source src="data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAA... (son court coupÃ© pour la lisibilitÃ©) ..." type="audio/mpeg">
</audio>

<script>
/* ========== Anti page blanche ========== */
function showErr(msg){const b=document.getElementById('err');b.style.display='block';document.getElementById('err-msg').textContent=msg;}
window.addEventListener('error', e=>showErr(e.message+'\\n'+(e.error&&e.error.stack||'')));
window.addEventListener('unhandledrejection', e=>showErr('Promise rejetÃ©e: '+(e.reason&&e.reason.message||e.reason)));

/* ========== CONFIG ========== */
const S = {
  API_URL: localStorage.getItem('pizz_api') || document.getElementById('api').value,
  ADMIN:   localStorage.getItem('pizz_admin') || document.getElementById('adm').value,
  known:   new Map(),   // id -> rowElement
  audioArmed: false
};
document.getElementById('api').value = S.API_URL;
document.getElementById('adm').value = S.ADMIN;

/* ========== Utilitaires ========== */
const euro = v => (Number(v)||0).toFixed(2).replace('.', ',')+' â‚¬';
const hhmm = t => {
  // accepte "19:30" OU timestamp/ISO
  if (typeof t === 'string' && /^\d{1,2}:\d{2}$/.test(t)) return t;
  const d = new Date(t);
  if (isNaN(d)) return String(t||'');
  return String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0');
};
async function parseResp(res){
  const raw = await res.text();
  let data; try{ data = JSON.parse(raw); } catch{ data = {ok:/^(ok|true)$/i.test(raw.trim())}; }
  return {ok:!!data.ok, data, raw, status:res.status};
}
async function postFlexible(url, bodyObj){
  // essai 1 : text/plain
  let res = await fetch(url,{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify(bodyObj)});
  let pr = await parseResp(res);
  if (!res.ok || !pr.ok){
    // essai 2 : sans header strict
    res = await fetch(url,{method:'POST',body:JSON.stringify(bodyObj)});
    pr = await parseResp(res);
  }
  return pr;
}

/* ========== Audio : dÃ©verrouillage par clic ========== */
const ding = document.getElementById('ding');
const soundPill = document.getElementById('sound-pill');
soundPill.addEventListener('click', async ()=>{
  try{
    await ding.play(); ding.pause(); ding.currentTime=0;
    S.audioArmed = true;
    soundPill.textContent = 'âœ… Son prÃªt';
  }catch(e){
    alert("Clique encore pour activer le son (bloquÃ© par le navigateur).");
  }
});
function ring(){ if(S.audioArmed){ ding.currentTime=0; ding.play().catch(()=>{}); }}

/* ========== Rendu ligne ========== */
function renderRow(o){
  const id = o.id || o.ID || o.Id || o.i || '';
  const pizzas = (()=>{ // texte pizzas + supplÃ©ments
    if (Array.isArray(o.items)) {
      return o.items.map(it=>{
        const sup = (it.supplType||it.suppl)?.type || it.supplType;
        return `${it.name} Ã— ${it.qty||1}${sup?` (+1â‚¬ ${sup})`:''}`;
      }).join('<br>');
    }
    if (o.basket) { // texte brut du site
      try{
        const b = (typeof o.basket==='string')? JSON.parse(o.basket): o.basket;
        return b.map(it=>`${it.name} Ã— ${it.qty||1}${it.supplType?` (+1â‚¬ ${it.supplType})`:''}`).join('<br>');
      }catch{ return String(o.basket); }
    }
    return String(o.pizzas||o.pizza||'');
  })();

  const tr = document.createElement('tr');
  tr.dataset.id = id;
  tr.innerHTML = `
    <td>${hhmm(o.time || o.when || o.date || '')}</td>
    <td>${id||''}</td>
    <td>${o.name||o.client||''}</td>
    <td>${o.phone||o.tel||''}</td>
    <td>${hhmm(o.slot||o.horaire||'')}</td>
    <td>${euro(o.total||o.Total||0)}</td>
    <td><span class="tag ${o.status==='ready'?'ready':o.status==='done'?'done':o.status==='canceled'?'cancel':'new'}">${o.status||'nouvelle'}</span></td>
    <td class="actions">
      <button data-act="ready">PrÃªte</button>
      <button data-act="done">TerminÃ©e</button>
      <button data-act="cancel">Annuler</button>
      <button class="warn" data-act="del">X</button>
      <div class="muted" style="margin-top:6px">${pizzas||'-'} </div>
    </td>
  `;
  tr.querySelectorAll('button[data-act]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const act = btn.dataset.act;
      if (act==='del'){ tr.remove(); S.known.delete(id); return; } // suppression locale seulement
      await setStatus(id, act);
    });
  });
  return tr;
}

/* ========== RÃ©cup + affichage ========== */
async function fetchOrders(){
  const API = S.API_URL || document.getElementById('api').value;
  const status = document.getElementById('status');
  try{
    const url = API + (API.includes('?')?'&':'?') + 'list=1';
    const res = await fetch(url, {cache:'no-store'});
    const {data, ok} = await parseResp(res);
    if (!res.ok){ status.textContent='Erreur rÃ©seau'; return; }

    // data.orders attendu. Si le script renvoie directement un tableau, on sâ€™adapte.
    const list = (data && (data.orders||data.data||data)) || [];
    const tbody = document.getElementById('body');
    if (tbody.firstElementChild) tbody.innerHTML='';

    // append sans Ã©craser ce quâ€™on connaÃ®t dÃ©jÃ 
    for (const o of list){
      const id = o.id || o.ID || o.i;
      if (S.known.has(id)) continue;
      const tr = renderRow(o);
      tbody.appendChild(tr);
      S.known.set(id, tr);
      // son pour les arrivÃ©es pendant la session
      ring();
    }
    status.textContent = new Date().toLocaleTimeString('fr-FR') + ' â€” OK';
  }catch(e){
    console.error(e);
    status.textContent='Erreur rÃ©seau';
  }
}

/* ========== Actions ========== */
async function setStatus(id, statusKey){
  const API = S.API_URL;
  const body = {action:'status', id, status:statusKey, admin:S.ADMIN};
  const r = await postFlexible(API, body);
  if (!r.ok){ alert("Ã‰chec de mise Ã  jour du statut."); return; }
  // mettre Ã  jour visuel localement
  const tr = S.known.get(id);
  if (tr){
    const span = tr.querySelector('.tag');
    span.className = 'tag ' + (statusKey==='ready'?'ready':statusKey==='done'?'done':statusKey==='cancel'?'cancel':'new');
    span.textContent = statusKey==='ready'?'ready':statusKey==='done'?'done':statusKey==='cancel'?'canceled':'nouvelle';
  }
}

async function sendDemo(){
  const API = S.API_URL;
  const sample = {
    id: 'DEMO-' + Math.random().toString(36).slice(2,6).toUpperCase(),
    name: 'Test JSONP',
    phone: '06 00 00 00 00',
    slot: '19:30',
    items: [{name:'Margharita', qty:1, price:7.5, supplType:'viande'}],
    total: 8.5,
    source: 'demo'
  };
  const r = await postFlexible(API, {action:'demo', admin:S.ADMIN, order:sample});
  if (!r.ok){ alert("Ã‰chec dâ€™envoi de la dÃ©mo."); return; }
  // lâ€™API ajoute en gÃ©nÃ©ral lâ€™ordre : on force un refresh immÃ©diat
  fetchOrders();
}

/* ========== Boutons ========== */
document.getElementById('save').onclick = ()=>{
  S.API_URL = document.getElementById('api').value.trim();
  S.ADMIN   = document.getElementById('adm').value.trim();
  localStorage.setItem('pizz_api', S.API_URL);
  localStorage.setItem('pizz_admin', S.ADMIN);
};
document.getElementById('refresh').onclick = fetchOrders;
document.getElementById('demo').onclick = sendDemo;

/* ========== Auto-refresh (nâ€™efface rien) ========== */
setInterval(fetchOrders, 12_000);

/* init */
fetchOrders();
</script>
</body>
</html>
