<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Dashboard â€” PIZZâ€™AMIGO</title>
<style>
  :root{
    --bg:#0b0f14; --panel:#101722; --line:#283149; --muted:#b8c2d6;
    --green:#1fcf7c; --red:#e55252; --white:#fff; --accent:#ffb54c;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:#fff;font-family:system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:1024px;margin:18px auto;padding:0 14px}

  h1{margin:0 0 12px;font-size:24px}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:12px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  input[type="text"]{width:100%;max-width:680px;border:1px solid var(--line);background:#0e1420;color:#fff;border-radius:10px;padding:10px}
  .btn{border:1px solid rgba(255,255,255,.25);background:transparent;color:#fff;border-radius:999px;padding:8px 12px;cursor:pointer}
  .btn.primary{background:var(--green);color:#001b10;border-color:transparent}
  .btn.red{border-color:#ff8b8b;color:#ffb4b4}
  .muted{color:var(--muted)}
  .ok{color:var(--green)}
  .err{color:#ff9a9a}

  table{width:100%;border-collapse:collapse}
  th,td{border-top:1px solid var(--line);padding:10px;vertical-align:top}
  th{font-weight:700;text-align:left;color:#dfe8ff}
  td .chip{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:#0f1623}
  .actions .btn{padding:6px 10px}

  /* ====== Responsive : table -> cartes ====== */
  @media (max-width: 720px){
    table, thead, tbody, th, td, tr{display:block}
    thead{display:none}
    tbody tr{border:1px solid var(--line);border-radius:12px;padding:10px;margin:10px 0;background:var(--panel)}
    tbody td{border:none;padding:6px 0}
    tbody td::before{content:attr(data-label);display:block;font-size:.85rem;color:var(--muted);margin-bottom:2px}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
  }

  /* Bouton son */
  .sound-toggle{margin-left:auto;display:flex;align-items:center;gap:6px}
  .pill{border:1px solid var(--line);border-radius:999px;padding:6px 10px;background:#0f1623}
</style>
</head>
<body>
<div class="wrap">
  <h1>Dashboard â€” PIZZâ€™AMIGO</h1>

  <div class="panel">
    <div class="row">
      <input id="api" type="text" placeholder="URL de lâ€™API" value="https://script.google.com/macros/s/AKfycbyePXcqPFPs0uhNOcVM5J5Nq3LCgsrB9UKVOmit1HVoTBzCdZRDCxEntrydbXSyQMXu/exec">
      <input id="adm" type="text" placeholder="ClÃ© admin (facultatif)" style="max-width:260px">
      <button id="save" class="btn">Enregistrer</button>
      <button id="refresh" class="btn">Actualiser</button>
      <button id="demo" class="btn">DÃ©mo</button>
      <div class="sound-toggle">
        <span class="muted">Son :</span>
        <button id="enable-audio" class="pill">ðŸ”” Activer le son</button>
      </div>
    </div>
    <div id="status" class="muted" style="margin-top:8px">â€”</div>
  </div>

  <div class="panel" style="margin-top:12px">
    <table>
      <thead>
        <tr>
          <th style="width:110px">Heure</th>
          <th>ID</th>
          <th>Client</th>
          <th>TÃ©lÃ©phone</th>
          <th>Horaire</th>
          <th>Pizzas</th>
          <th style="width:90px">Total</th>
          <th style="width:80px">Statut</th>
          <th style="width:220px">Action</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </div>

  <!-- Panneau erreurs (anti page blanche) -->
  <div id="err" class="panel" style="display:none;margin-top:12px;background:#2a1b1b;border-color:#5d2f2f">
    <b>Erreur JavaScript</b>
    <pre id="err-msg" style="white-space:pre-wrap;margin:8px 0 0;color:#ffd1d1"></pre>
  </div>
</div>

<script>
/* ====== Anti page blanche ====== */
function showErr(msg){const p=document.getElementById('err');p.style.display='block';document.getElementById('err-msg').textContent=msg;}
window.addEventListener('error', e=>showErr(e.message+'\n'+(e.error&&e.error.stack||'')));
window.addEventListener('unhandledrejection', e=>showErr('Promise rejetÃ©e: '+(e.reason&&e.reason.message||e.reason)));

/* ====== State ====== */
const elApi = document.getElementById('api');
const elAdm = document.getElementById('adm');
const elRows = document.getElementById('rows');
const elStatus = document.getElementById('status');
const btnEnableAudio = document.getElementById('enable-audio');

let ORDERS = new Map(); // id -> order
let audioCtx = null;
let soundEnabled = false;

/* ====== Audio (petite cloche) ====== */
function initAudio(){
  if (soundEnabled) return;
  try{
    audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)();
    // Sur mobile il faut un geste utilisateur pour resume()
    audioCtx.resume();
    soundEnabled = true;
    localStorage.setItem('pizzamigo_sound','1');
    btnEnableAudio.style.display='none';
  }catch(e){ console.debug('Audio init error', e); }
}
btnEnableAudio.addEventListener('click', initAudio);
if(localStorage.getItem('pizzamigo_sound')==='1'){ setTimeout(initAudio,0); }

function bell(){
  if(!soundEnabled || !audioCtx) return;
  const t0 = audioCtx.currentTime;
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.type = 'triangle';
  osc.frequency.setValueAtTime(880, t0);        // A5
  osc.frequency.exponentialRampToValueAtTime(660, t0+0.12);
  gain.gain.setValueAtTime(0.0001, t0);
  gain.gain.exponentialRampToValueAtTime(0.5, t0+0.01);
  gain.gain.exponentialRampToValueAtTime(0.0001, t0+0.5);
  osc.connect(gain).connect(audioCtx.destination);
  osc.start(t0); osc.stop(t0+0.52);
}

/* ====== Helpers ====== */
const euro = v => (Number(v)||0).toFixed(2).replace('.',',');
function nowStr(){ const d=new Date(); return d.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit',second:'2-digit'}); }
function api()  { return (elApi.value||'').trim(); }
function ok(msg){ elStatus.innerHTML = `${nowStr()} â€” <span class="ok">${msg||'OK'}</span>`; }
function err(msg){ elStatus.innerHTML = `${nowStr()} â€” <span class="err">${msg||'Erreur'}</span>`; }

/* ====== Render ====== */
function renderTable(list){
  const prevIds = new Set(ORDERS.keys());
  elRows.innerHTML = '';

  list.forEach(o=>{
    ORDERS.set(o.id, o);

    const tr = document.createElement('tr');

    const td = (label, html) => {
      const c = document.createElement('td');
      c.setAttribute('data-label', label);
      c.innerHTML = html;
      return c;
    };

    tr.appendChild(td('Heure', new Date(o.date||Date.now()).toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'})));
    tr.appendChild(td('ID', o.id||''));
    tr.appendChild(td('Client', o.name||''));
    tr.appendChild(td('TÃ©lÃ©phone', o.phone||''));
    tr.appendChild(td('Horaire', (o.slot||'').replace(':','h')));
    // pizzas : affiche supplÃ©ments si prÃ©sents
    const pizzas = Array.isArray(o.basket)? o.basket.map(it=>{
      const sup = it.suppl && Number(it.suppl)>0 ? ` (+1â‚¬ ${it.supplType||'suppl.'})` : '';
      return `${it.name} Ã— ${it.qty||1}${sup}`;
    }).join('<br>') : (o.pizzas||o.items||'');
    tr.appendChild(td('Pizzas', pizzas || ''));
    tr.appendChild(td('Total', `${euro(o.total||0)} â‚¬`));
    tr.appendChild(td('Statut', `<span class="chip">${o.status||'new'}</span>`));

    // actions
    const act = document.createElement('td'); act.className='actions'; act.setAttribute('data-label','Action');
    ['PrÃªte','TerminÃ©e','Annuler'].forEach(lbl=>{
      const b=document.createElement('button'); b.className='btn';
      b.textContent=lbl;
      b.onclick=()=>updateStatus(o.id, lbl==='PrÃªte'?'ready':lbl==='TerminÃ©e'?'done':'canceled');
      act.appendChild(b);
    });
    const x=document.createElement('button'); x.className='btn red'; x.textContent='âœ–'; x.title='Retirer';
    x.onclick=()=>{ tr.remove(); ORDERS.delete(o.id); };
    act.appendChild(x);
    tr.appendChild(act);

    elRows.appendChild(tr);
  });

  // DÃ©tection de nouvelles commandes => son
  const newOnes = list.filter(o=>!prevIds.has(o.id));
  if(newOnes.length>0) bell();
}

/* ====== API calls ====== */
async function getList(){
  try{
    const url = api();
    if(!url) return err('Renseigne lâ€™URL de lâ€™API');
    const r = await fetch(url+'?list=1',{cache:'no-store'});
    const data = await r.json();
    if(!data.ok) throw new Error(data.error||'RÃ©ponse invalide');
    renderTable(data.orders||[]);
    ok('OK');
  }catch(e){ console.error(e); err('Erreur rÃ©seau'); }
}

async function sendDemo(){
  try{
    const url = api();
    const r = await fetch(url, {
      method:'POST',
      headers:{'Content-Type':'text/plain;charset=utf-8'},
      body: JSON.stringify({demo:1})
    });
    const data = await r.json().catch(()=>({ok:false}));
    if(!r.ok || !data.ok) throw new Error('Echec envoi');
    ok('DÃ©mo ajoutÃ©e'); // la cloche sonnera au prochain refresh si nouvelle ligne
    // on force un refresh aprÃ¨s 1s
    setTimeout(getList, 1000);
  }catch(e){ console.error(e); alert("Ã‰chec dâ€™envoi de la dÃ©mo."); err('Ã‰chec dÃ©mo'); }
}

async function updateStatus(id, status){
  try{
    const url = api();
    const body = { id, status, admin: (elAdm.value||'').trim() || undefined };
    const r = await fetch(url, {
      method:'POST',
      headers:{'Content-Type':'text/plain;charset=utf-8'},
      body: JSON.stringify(body)
    });
    const data = await r.json().catch(()=>({ok:false}));
    if(!r.ok || !data.ok) throw new Error('Echec statut');
    ok('Statut mis Ã  jour');
    setTimeout(getList, 600);
  }catch(e){ console.error(e); alert("Ã‰chec de mise Ã  jour du statut."); err('Ã‰chec statut'); }
}

/* ====== Hooks & init ====== */
document.getElementById('save').onclick = ()=>{
  localStorage.setItem('pizzamigo_api', elApi.value.trim());
  localStorage.setItem('pizzamigo_adm', elAdm.value.trim());
  ok('ParamÃ¨tres enregistrÃ©s');
};
document.getElementById('refresh').onclick = getList;
document.getElementById('demo').onclick = sendDemo;

(function boot(){
  elApi.value = localStorage.getItem('pizzamigo_api') || elApi.value;
  elAdm.value = localStorage.getItem('pizzamigo_adm') || '';
  // si lâ€™utilisateur a dÃ©jÃ  activÃ© le son, cache le bouton
  if(localStorage.getItem('pizzamigo_sound')==='1'){ btnEnableAudio.style.display='none'; }
  // premier chargement
  getList();
  // poll toutes les 10s pour rÃ©cupÃ©rer les nouvelles commandes sans jamais effacer celles affichÃ©es Ã  la main
  setInterval(getList, 10000);
})();
</script>
</body>
</html>
