<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Dashboard — PIZZ’AMIGO</title>
<style>
  :root{--bg:#0b0f14;--panel:#101722;--line:#283149;--muted:#b8c2d6;--green:#1fcf7c;--red:#e55252;--accent:#ffb54c}
  *{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:#fff;font-family:system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:1100px;margin:18px auto;padding:0 14px}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:12px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  input,button{border-radius:10px;border:1px solid var(--line);background:#0e1420;color:#fff}
  input{padding:10px;min-width:260px;flex:1}
  .btn{padding:8px 12px;cursor:pointer}
  .btn.primary{background:var(--green);border-color:transparent;color:#001b10}
  .btn.ghost{background:transparent}
  .btn.danger{border-color:#ff8b8b;color:#ffb4b4}
  .status-ok{color:#7dffa9}
  .status-err{color:#ff9b9b}
  table{width:100%;border-collapse:separate;border-spacing:0;margin-top:12px}
  th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.06);vertical-align:top}
  th{color:#cfd6e7;text-align:left;font-weight:600}
  td .chip{border:1px solid var(--line);border-radius:999px;padding:3px 8px;font-size:.9rem}
  td .chip.new{background:rgba(255,181,76,.08);border-color:#b07a2f}
  td .chip.ready{background:rgba(46,204,113,.12);border-color:#2ecc71}
  td .chip.done{opacity:.8}
  .actions{display:flex;gap:6px;flex-wrap:wrap}
  .actions .btn{padding:6px 10px;font-size:.95rem}
  .muted{color:var(--muted)}
  .topbar small{margin-left:8px}
  /* mobile */
  @media (max-width:720px){
    .wrap{padding:0 10px}
    .topbar .row{gap:8px}
    table{font-size:.95rem}
    th:nth-child(3),td:nth-child(3), /* client */
    th:nth-child(4),td:nth-child(4)  /* téléphone */ {display:none}
  }
</style>
</head>
<body>
<div class="wrap">

  <h1 style="margin:6px 0 12px">Dashboard — <b>PIZZ’AMIGO</b></h1>

  <section class="card topbar">
    <div class="row">
      <input id="api" placeholder="https://script.google.com/macros/s/…/exec"/>
      <input id="adm" placeholder="Clé admin (facultatif)" />
      <button id="save" class="btn">Enregistrer</button>
      <button id="refresh" class="btn">Actualiser</button>
      <button id="demo" class="btn">Démo</button>
      <small id="last" class="muted">Dernière mise à jour — <span id="last-txt">—</span></small>
      <small id="net" class="muted"></small>
    </div>
  </section>

  <section class="card">
    <table id="tbl">
      <thead>
        <tr>
          <th>Heure</th>
          <th>ID</th>
          <th>Client</th>
          <th>Téléphone</th>
          <th>Horaire</th>
          <th>Pizzas</th>
          <th>Total</th>
          <th>Statut</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="body">
        <tr><td colspan="9" class="muted">Aucune commande pour le moment.</td></tr>
      </tbody>
    </table>
  </section>

  <!-- sonnerie -->
  <audio id="bell" preload="auto">
    <source src="https://upload.wikimedia.org/wikipedia/commons/3/3f/Service_Bell.help.ogg" type="audio/ogg"/>
  </audio>

</div>

<script>
/* ===== util ===== */
const $ = s => document.querySelector(s);
const formatMoney = n => (Number(n)||0).toFixed(2).replace('.',',')+' €';
const hhmm = (t) => {
  try{
    if(!t) return '';
    // accepte "19:30" ou ISO/date lisible
    if (/^\d{1,2}:\d{2}$/.test(t)) return t;
    const d = new Date(t);
    const h = d.getHours().toString().padStart(2,'0');
    const m = d.getMinutes().toString().padStart(2,'0');
    return `${h}:${m}`;
  }catch{ return String(t); }
};
const nowStr = () => {
  const d=new Date(); const h=d.getHours().toString().padStart(2,'0'); const m=d.getMinutes().toString().padStart(2,'0');
  return `${h}:${m}:${d.getSeconds().toString().padStart(2,'0')}`;
}

/* ===== state ===== */
let API = localStorage.getItem('pizz_api') || '';
let ADMIN = localStorage.getItem('pizz_admin') || '';
$('#api').value = API; $('#adm').value = ADMIN;

const bell = $('#bell');

/* ===== rendu tableau ===== */
function pizzasLabel(basket){
  // basket: tableau d'items {name, qty, price, supplType?, supplPrice?}
  try{
    const arr = Array.isArray(basket) ? basket
              : (typeof basket==='string' ? JSON.parse(basket) : []);
    if(!arr.length) return '—';
    return arr.map(it=>{
      const sup = (it.supplPrice && it.supplType)
        ? ` (+${String(it.supplPrice).replace('.',',')} € ${it.supplType})` : '';
      return `${it.name} × ${it.qty}${sup}`;
    }).join(', ');
  }catch{
    return '—';
  }
}

function render(rows){
  const tb = $('#body');
  tb.innerHTML = '';
  if(!rows || !rows.length){
    tb.innerHTML = `<tr><td colspan="9" class="muted">Aucune commande pour le moment.</td></tr>`;
    return;
  }
  rows.forEach(o=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${hhmm(o.when)}</td>
      <td>${o.id||'—'}</td>
      <td>${o.name||'—'}</td>
      <td>${o.phone||'—'}</td>
      <td>${hhmm(o.slot)||'—'}</td>
      <td>${pizzasLabel(o.basket||o.items||[])}</td>
      <td>${formatMoney(o.total)}</td>
      <td><span class="chip ${o.status==='ready'?'ready':o.status==='done'?'done':'new'}">${o.status||'new'}</span></td>
      <td class="actions">
        <button class="btn" data-act="ready">Prête</button>
        <button class="btn" data-act="done">Terminée</button>
        <button class="btn" data-act="cancel">Annuler</button>
        <button class="btn danger" title="Retirer de l’affichage" data-act="hide">❌</button>
      </td>`;
    tr.querySelectorAll('button[data-act]').forEach(b=>{
      b.addEventListener('click', async (e)=>{
        const act = e.currentTarget.getAttribute('data-act');
        if(act==='hide'){ tr.remove(); return; } // suppression manuelle de l’affichage uniquement
        await updateStatus(o.id, act);
        // maj visuelle simple
        if(act==='ready') tr.querySelector('.chip').textContent='ready', tr.querySelector('.chip').className='chip ready';
        if(act==='done') tr.querySelector('.chip').textContent='done',  tr.querySelector('.chip').className='chip done';
        if(act==='cancel') tr.querySelector('.chip').textContent='canceled';
      });
    });
    tb.appendChild(tr);
  });
}

/* ===== appels API ===== */
async function apiGetToday(){
  if(!API){ $('#net').textContent='Renseigne l’URL de l’API'; return []; }
  $('#net').textContent = 'Chargement…';
  try{
    const r = await fetch(`${API}?list=1`, {cache:'no-store'});
    const js = await r.json(); // {ok:true, orders:[...]}
    if(!r.ok || !js.ok) throw new Error(js.error||('HTTP '+r.status));
    $('#net').textContent = 'OK';
    $('#last-txt').textContent = `${nowStr()} — OK`;
    return js.orders||[];
  }catch(err){
    console.error(err);
    $('#net').textContent = 'Erreur réseau';
    $('#last-txt').textContent = `${nowStr()} — Erreur`;
    return [];
  }
}

async function sendDemo(){
  if(!API){ alert("Renseigne l’URL de l’API d’abord."); return; }
  try{
    const payload = {
      name:"Test JSONP",
      phone:"0600000000",
      slot:"19:30",
      items:[{name:"Margharita", qty:1, price:7.5, supplType:null, supplPrice:0}],
      total:7.5,
      source:"demo"
    };
    const r = await fetch(API, {
      method:'POST',
      headers:{'Content-Type':'text/plain;charset=utf-8'},
      body: JSON.stringify(payload)
    });
    const txt = await r.text(); let js;
    try{ js = JSON.parse(txt); }catch{ js = {ok:false, raw:txt}; }
    if(!r.ok || !js.ok) throw new Error(js.error||('HTTP '+r.status));
    // rafraîchit + son
    try{ bell.currentTime = 0; bell.play().catch(()=>{}); }catch{}
    await refresh();
  }catch(err){
    console.error(err);
    alert("Échec d’envoi de la démo.");
  }
}

async function updateStatus(id, next){
  if(!API || !id) return;
  try{
    await fetch(API, {
      method:'POST',
      headers:{'Content-Type':'text/plain;charset=utf-8'},
      body: JSON.stringify({admin: ADMIN||'', action:'status', id, to: next})
    });
  }catch(e){ console.warn(e); }
}

/* ===== actions UI ===== */
async function refresh(){
  const rows = await apiGetToday();
  render(rows);
}

$('#save').addEventListener('click', ()=>{
  API = $('#api').value.trim();
  ADMIN = $('#adm').value.trim();
  localStorage.setItem('pizz_api', API);
  localStorage.setItem('pizz_admin', ADMIN);
  refresh();
});
$('#refresh').addEventListener('click', refresh);
$('#demo').addEventListener('click', sendDemo);

// auto-ping (ne supprime rien, juste charge les nouveautés)
setInterval(refresh, 15_000);

// init
refresh();
</script>
</body>
</html>
