<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dashboard — PIZZ’AMIGO</title>
<style>
  :root{
    --bg:#0f1115; --panel:#161a22; --muted:#8fa1b3; --text:#e6eef8;
    --line:#2a3040; --accent:#47d16c; --accent-2:#ff6363; --accent-3:#ffbf47;
    --chip:#1f2532;
  }
  html,body{margin:0;background:var(--bg);color:var(--text);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
  .wrap{max-width:1000px;margin:24px auto;padding:0 16px}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:14px 16px;box-shadow:0 6px 20px rgba(0,0,0,.25)}
  h1{font-size:22px;margin:0 0 12px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  input[type=text]{flex:1;min-width:260px;background:#0c0f14;border:1px solid var(--line);border-radius:8px;color:var(--text);padding:10px 12px}
  .btn{background:#1f2633;border:1px solid var(--line);color:var(--text);padding:9px 12px;border-radius:10px;cursor:pointer}
  .btn:hover{filter:brightness(1.1)}
  .btn.ok{background:#0f291a;border-color:#1d6e42;color:#adf5c5}
  .btn.warn{background:#2a1b00;border-color:#6a5300;color:#ffd57a}
  .btn.danger{background:#2b0f12;border-color:#7d2831;color:#ff8f9a}
  small.muted{color:var(--muted)}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:10px 12px;border-bottom:1px dashed var(--line);vertical-align:top}
  th{color:#9fb3c8;font-weight:600;text-align:left}
  td .chips{display:flex;gap:6px;flex-wrap:wrap}
  .chip{background:var(--chip);border:1px solid var(--line);padding:3px 8px;border-radius:999px;font-size:12px}
  .status{font-weight:700}
  .status.nouvelle{color:#8affb3}
  .status.prete{color:#ffd784}
  .status.annulee{color:#ff9aa6}
  .status.terminee{color:#9bb6ff}
  .actions{display:flex;gap:6px;flex-wrap:wrap}
  .right{margin-left:auto}
  .pill{display:inline-block;border:1px solid var(--line);background:#0c0f14;border-radius:999px;padding:6px 10px}
  .sep{height:8px}
</style>
</head>
<body>
<div class="wrap">
  <h1>Dashboard — PIZZ’AMIGO</h1>

  <div class="card">
    <div class="row" style="gap:10px">
      <input id="apiUrl" type="text" placeholder="URL de l’API (…/exec)" />
      <input id="adminKey" type="text" placeholder="Clé admin (facultatif)" />
      <button class="btn" id="saveBtn">Enregistrer</button>
      <button class="btn ok" id="refreshBtn">Actualiser</button>
      <button class="btn warn" id="demoBtn">Démo</button>
      <span class="right pill" id="status">Dernière mise à jour — —</span>
    </div>
  </div>

  <div class="sep"></div>

  <div class="card">
    <table>
      <thead>
        <tr>
          <th>Heure</th>
          <th>ID</th>
          <th>Client</th>
          <th>Téléphone</th>
          <th>Horaire</th>
          <th>Pizzas</th>
          <th>Total</th>
          <th>Statut</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="tbody"><tr><td colspan="9"><small class="muted">Aucune commande pour le moment.</small></td></tr></tbody>
    </table>
  </div>
</div>

<!-- beep sonore (petit wav en base64) -->
<audio id="beep">
  <source src="data:audio/wav;base64,UklGRkQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYAZGF0YQAAABAAAAAAgACAgICAQEBARERERUVFVVVVVdXV1dZWVlZWVlXV1dVVVVFRUVEQ0NDRERERERBQUE/Pz8+Pj4+Pj4+" type="audio/wav">
</audio>

<script>
(() => {
  const el = id => document.getElementById(id);
  const apiInput = el('apiUrl');
  const keyInput = el('adminKey');
  const statusEl = el('status');
  const tbody = el('tbody');
  const beep = el('beep');

  const SKEY = 'pizzamigo_dash_v3';
  const state = JSON.parse(localStorage.getItem(SKEY) || '{}');
  let orders = [];            // commandes affichées
  let lastIds = new Set(state.lastIds || []); // pour détecter les nouvelles
  let localStatus = state.localStatus || {};  // statuts changés côté dash
  let hiddenIds = new Set(state.hiddenIds || []); // masquages manuels

  // init champs
  apiInput.value = state.apiUrl || '';
  keyInput.value = state.adminKey || '';

  const saveState = () => {
    localStorage.setItem(SKEY, JSON.stringify({
      apiUrl: apiInput.value.trim(),
      adminKey: keyInput.value.trim(),
      lastIds: Array.from(lastIds),
      localStatus,
      hiddenIds: Array.from(hiddenIds)
    }));
  };

  el('saveBtn').onclick = () => { saveState(); ping(); };

  function setStatus(msg, ok=false){
    statusEl.textContent = `Dernière mise à jour — ${new Date().toTimeString().slice(0,8)} — ${msg}`;
    statusEl.style.color = ok ? '#9fffcf' : '#ffd7a0';
  }

  // ---- JSONP fallback
  function fetchJSONP(url, params, timeout=6000){
    return new Promise((resolve, reject)=>{
      const cb = '__pjsonp_cb_' + Math.random().toString(36).slice(2);
      const q = new URL(url);
      Object.entries(params||{}).forEach(([k,v])=> q.searchParams.set(k, v));
      q.searchParams.set('callback', cb);
      const s = document.createElement('script');
      let done=false, t;
      window[cb] = (data)=>{ done=true; clearTimeout(t); s.remove(); delete window[cb]; resolve({ ok:true, json:()=>Promise.resolve(data) }); };
      s.src = q.toString();
      s.onerror = ()=>{ if(done) return; clearTimeout(t); s.remove(); delete window[cb]; reject(new Error('JSONP error')); };
      t = setTimeout(()=>{ if(done) return; s.remove(); delete window[cb]; reject(new Error('JSONP timeout')); }, timeout);
      document.head.appendChild(s);
    });
  }

  async function apiGet(params){
    const base = apiInput.value.trim();
    if(!base){ setStatus('Renseigne l’URL de l’API', false); throw new Error('no_api'); }
    // Essai 1: fetch JSON direct
    try{
      const u = new URL(base);
      Object.entries(params||{}).forEach(([k,v])=> u.searchParams.set(k,v));
      const r = await fetch(u.toString(), { mode:'cors' });
      if(!r.ok) throw new Error('http '+r.status);
      return await r.json();
    }catch(e){
      // Essai 2: JSONP
      const r2 = await fetchJSONP(base, params);
      return await r2.json();
    }
  }

  // ping
  async function ping(){
    try{
      const data = await apiGet({ ping: 1 });
      if(data && data.ok){ setStatus('OK', true); }
      else setStatus('API répond mais pas OK', false);
    }catch(e){
      setStatus('Erreur réseau (ping)', false);
      console.warn(e);
    }
  }

  function euro(v){ return Number(v).toFixed(2).replace('.', ',') + ' €'; }

  function rowHTML(o){
    const pizzas = Array.isArray(o.items) ? o.items.map(it=>{
      const sup = it.suppl && it.suppl>0 ? ` (+${it.suppl})` : '';
      const qty = it.qty? ` × ${it.qty}`:'';
      return `<span class="chip">${escapeHTML(it.name)}${sup}${qty}</span>`;
    }).join(' ') : escapeHTML(o.items || '');
    const status = (localStatus[o.id] || o.status || 'nouvelle');
    return `
      <tr data-id="${o.id}">
        <td>${escapeHTML(o.when || '')}</td>
        <td><small class="muted">${escapeHTML(o.id)}</small></td>
        <td>${escapeHTML(o.name||'')}</td>
        <td>${escapeHTML(o.phone||'')}</td>
        <td>${escapeHTML(o.slot||'')}</td>
        <td><div class="chips">${pizzas}</div></td>
        <td>${euro(o.total || 0)}</td>
        <td class="status ${status}">${status}</td>
        <td class="actions">
          <button class="btn ok btn-prete">Prête</button>
          <button class="btn warn btn-terminee">Terminée</button>
          <button class="btn danger btn-annulee">Annuler</button>
          <button class="btn danger btn-hide" title="Masquer">✕</button>
        </td>
      </tr>`;
  }

  function render(list){
    if(!list || !list.length){
      tbody.innerHTML = `<tr><td colspan="9"><small class="muted">Aucune commande pour le moment.</small></td></tr>`;
      return;
    }
    tbody.innerHTML = list.map(rowHTML).join('');
    // binder actions locales (pas d’appel API comme demandé)
    tbody.querySelectorAll('tr').forEach(tr=>{
      const id = tr.dataset.id;
      tr.querySelector('.btn-prete').onclick = ()=> setLocalStatus(id,'prete',tr);
      tr.querySelector('.btn-terminee').onclick = ()=> setLocalStatus(id,'terminee',tr);
      tr.querySelector('.btn-annulee').onclick = ()=> setLocalStatus(id,'annulee',tr);
      tr.querySelector('.btn-hide').onclick = ()=> { hiddenIds.add(id); saveState(); tr.remove(); if(!tbody.children.length) render([]); };
    });
  }

  function setLocalStatus(id, status, tr){
    localStatus[id] = status;
    saveState();
    const td = tr.querySelector('.status');
    td.className = 'status '+status;
    td.textContent = status;
  }

  function escapeHTML(s){ return (s==null?'':String(s)).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

  function normalizeIncoming(arr){
    // On accepte deux formats:
    // 1) API “v2”: { ok:true, orders:[{id, when, name, phone, slot, items:[{name,qty,suppl}], total, status}] }
    // 2) API “simple”: tableau de lignes
    if(Array.isArray(arr)) return arr;
    if(arr && arr.orders) return arr.orders;
    return [];
  }

  async function refresh(){
    setStatus('Chargement…', true);
    try{
      const data = await apiGet({ list: 1 });
      const raw = normalizeIncoming(data);
      // filtre 24h & masques
      const now = Date.now();
      const dayago = now - 24*3600*1000;
      const list = raw.filter(o=>{
        if(hiddenIds.has(o.id)) return false;
        // si l’API renvoie une date complète: o.ts (ms) ou o.date ISO
        if(o.ts) return o.ts >= dayago;
        return true; // sinon on laisse
      });
      // tri par heure puis id
      list.sort((a,b)=> String(a.when).localeCompare(String(b.when)) || String(a.id).localeCompare(String(b.id)));

      // bip si nouvelles
      const incomingIds = new Set(list.map(o=>o.id));
      let hasNew=false;
      incomingIds.forEach(id=>{
        if(!lastIds.has(id)){ hasNew=true; }
      });
      if(hasNew){
        try{ beep.currentTime = 0; beep.play().catch(()=>{}); }catch(_){}
      }
      lastIds = incomingIds;
      saveState();

      orders = list;
      render(orders);
      setStatus('OK', true);
    }catch(e){
      console.warn(e);
      setStatus('Erreur réseau', false);
    }
  }

  // Démo (reste à l’écran tant que tu ne masques pas)
  el('demoBtn').onclick = ()=>{
    const id = 'DEMO-' + Math.random().toString(36).slice(2,7).toUpperCase();
    const demo = {
      id, when: new Date().toTimeString().slice(0,5), name:'Test JSONP',
      phone:'06 00 00 00 00', slot:'19:00',
      items:[{name:'Margharita', qty:1, suppl:0}],
      total:7.5, status:'nouvelle', source:'demo'
    };
    // ajout en tête
    orders = [demo, ...orders];
    lastIds.add(id);
    try{ beep.currentTime=0; beep.play().catch(()=>{}); }catch(_){}
    render(orders);
    saveState();
    setStatus('Démo ajoutée', true);
  };

  el('refreshBtn').onclick = refresh;

  // auto-init léger (sans auto-refresh permanent)
  if(apiInput.value) ping();
  refresh();
})();
</script>
</body>
</html>
