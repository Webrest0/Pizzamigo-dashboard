<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Dashboard ‚Äî PIZZ‚ÄôAMIGO</title>
<style>
  :root{
    --bg:#0b0f14; --panel:#101722; --line:#283149; --muted:#b8c2d6;
    --green:#1fcf7c; --red:#e55252; --accent:#ffb54c;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:#fff;font-family:system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:1024px;margin:18px auto;padding:0 14px}

  h1{margin:0 0 12px;font-size:24px}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:12px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  input[type="text"]{width:100%;max-width:680px;border:1px solid var(--line);background:#0e1420;color:#fff;border-radius:10px;padding:10px}
  .btn{border:1px solid rgba(255,255,255,.25);background:transparent;color:#fff;border-radius:999px;padding:8px 12px;cursor:pointer}
  .muted{color:var(--muted)}
  .ok{color:var(--green)} .err{color:#ff9a9a}

  table{width:100%;border-collapse:separate;border-spacing:0 10px}
  thead th{padding:10px;text-align:left;color:#dfe8ff}
  tbody td{background:#0f1623;border-top:1px solid var(--line);border-bottom:1px solid var(--line);padding:12px 14px;vertical-align:top}
  tbody td:first-child{border-left:1px solid var(--line);border-top-left-radius:12px;border-bottom-left-radius:12px}
  tbody td:last-child{border-right:1px solid var(--line);border-top-right-radius:12px;border-bottom-right-radius:12px}

  @media (max-width:720px){
    table, thead, tbody, th, td, tr{display:block}
    thead{display:none}
    tbody tr{margin:12px 0}
    tbody td{border:1px solid var(--line);border-radius:12px;margin:6px 0;padding:10px 12px}
    tbody td::before{content:attr(data-label);display:block;font-size:.85rem;color:var(--muted);margin-bottom:2px}
  }

  .sound-toggle{margin-left:auto;display:flex;align-items:center;gap:8px}
  .pill{border:1px solid var(--line);border-radius:999px;padding:6px 10px;background:#0f1623;cursor:pointer}
  .xbtn{border:1px solid #8b3941;color:#ffb4b4;background:#23141a;border-radius:999px;padding:6px 10px;cursor:pointer}
</style>
</head>
<body>
<div class="wrap">
  <h1>Dashboard ‚Äî PIZZ‚ÄôAMIGO</h1>

  <div class="panel">
    <div class="row">
      <input id="api" type="text" placeholder="URL de l‚ÄôAPI"
             value="https://script.google.com/macros/s/AKfycbyePXcqPFPs0uhNOcVM5J5Nq3LCgsrB9UKVOmit1HVoTBzCdZRDCxEntrydbXSyQMXu/exec">
      <button id="save" class="btn">Enregistrer</button>
      <button id="refresh" class="btn">Actualiser</button>
      <div class="sound-toggle">
        <span class="muted">Volume :</span>
        <input id="vol" type="range" min="0" max="1" step="0.01" value="0.9">
        <button id="enable-audio" class="pill">üîî Activer</button>
        <button id="test-audio" class="pill">‚ñ∂Ô∏è Test son</button>
      </div>
    </div>
    <div id="status" class="muted" style="margin-top:8px">‚Äî</div>
  </div>

  <div class="panel" style="margin-top:12px">
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Client</th>
          <th>T√©l√©phone</th>
          <th>HDC</th>
          <th>Horaire</th>
          <th>Pizzas</th>
          <th>Total</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </div>

  <div id="err" class="panel" style="display:none;margin-top:12px;background:#2a1b1b;border-color:#5d2f2f">
    <b>Erreur JavaScript</b>
    <pre id="err-msg" style="white-space:pre-wrap;margin:8px 0 0;color:#ffd1d1"></pre>
  </div>
</div>

<!-- cloche -->
<audio id="bell" preload="auto" crossorigin="anonymous">
  <source src="https://cdn.jsdelivr.net/gh/naptha/tinyfiles@master/chime.mp3" type="audio/mpeg">
</audio>

<script>
/* ===== Anti page blanche ===== */
function showErr(msg){const p=document.getElementById('err');p.style.display='block';document.getElementById('err-msg').textContent=msg;}
window.addEventListener('error', e=>showErr(e.message+'\n'+(e.error?.stack||'')));
window.addEventListener('unhandledrejection', e=>showErr('Promise rejet√©e: '+(e.reason?.message||e.reason)));

/* ===== State ===== */
const elApi   = document.getElementById('api');
const elRows  = document.getElementById('rows');
const elStatus= document.getElementById('status');
const bellEl  = document.getElementById('bell');
const volEl   = document.getElementById('vol');
const btnEnable = document.getElementById('enable-audio');
const btnTest   = document.getElementById('test-audio');

let seenIds = new Set();

/* ===== HDC persistant (par ID) ===== */
const HDC_KEY = 'pizzamigo_hdc_by_id';
function loadHDC(){ try{return JSON.parse(localStorage.getItem(HDC_KEY)||'{}');}catch{return{};} }
function saveHDC(map){ localStorage.setItem(HDC_KEY, JSON.stringify(map)); }
let HDC_BY_ID = loadHDC();

/* ===== Helpers ===== */
const euro=v=>(Number(v)||0).toFixed(2).replace('.',',')+' ‚Ç¨';
function ok(m){elStatus.innerHTML=new Date().toLocaleTimeString('fr-FR')+' ‚Äî <span class="ok">'+(m||'OK')+'</span>';}
function err(m){elStatus.innerHTML=new Date().toLocaleTimeString('fr-FR')+' ‚Äî <span class="err">'+(m||'Erreur')+'</span>';}
function api(){return (elApi.value||'').trim();}
function HHMM(d){const h=String(d.getHours()).padStart(2,'0');const m=String(d.getMinutes()).padStart(2,'0');return `${h}:${m}`;}
function toDate(v){ if(!v) return null; if(typeof v==='number') return new Date(v>1e12?v:v*1000); const d=new Date(v); return isNaN(d)?null:d; }
function pickTimestamp(o){ return o.created ?? o.date ?? o.when ?? o.ts ?? o.time ?? null; }
function fmtSlot(v){
  if(!v) return '';
  if(typeof v==='string'){
    const s=v.trim();
    if(/^\d{1,2}:\d{2}$/.test(s)) return s.replace(':','h');
    if(/^\d{1,2}h\d{2}$/.test(s)) return s;
  }
  const d=toDate(v); if(!d) return '';
  return HHMM(d).replace(':','h');
}

/* ===== Son : d√©verrouillage + test + fallback ===== */
let audioUnlocked=false;
function unlockAudio(){
  if(audioUnlocked) return;
  try{
    // D√©verrouille les moteurs audio des navigateurs mobiles
    const ctx=new (window.AudioContext||window.webkitAudioContext)();
    const buff=ctx.createBuffer(1,1,22050);
    const src=ctx.createBufferSource(); src.buffer=buff; src.connect(ctx.destination); src.start(0);
    ctx.resume && ctx.resume();
    audioUnlocked=true;
  }catch{}
}
function playBell(){
  unlockAudio();
  bellEl.volume=parseFloat(volEl.value||'0.9');
  bellEl.currentTime=0;
  return bellEl.play().catch(()=>{ // fallback WebAudio (ding court)
    try{
      const ctx=new (window.AudioContext||window.webkitAudioContext)();
      const o=ctx.createOscillator(), g=ctx.createGain();
      o.type='triangle';
      o.frequency.setValueAtTime(880, ctx.currentTime);
      o.frequency.exponentialRampToValueAtTime(660, ctx.currentTime+0.12);
      g.gain.setValueAtTime(0.0001, ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(parseFloat(volEl.value||'0.9'), ctx.currentTime+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.45);
      o.connect(g).connect(ctx.destination);
      o.start(); o.stop(ctx.currentTime+0.5);
    }catch{}
  });
}
btnEnable.onclick=()=>{ playBell(); localStorage.setItem('pizzamigo_sound','1'); btnEnable.style.display='none'; };
btnTest.onclick  =()=>{ playBell(); };
volEl.oninput    =()=>{ bellEl.volume=parseFloat(volEl.value||'0.9'); };
if(localStorage.getItem('pizzamigo_sound')==='1'){ setTimeout(()=>btnEnable.onclick(),0); }

/* ===== Pizzas: lecture tol√©rante ===== */
function parseMaybeJSON(x){
  if(!x) return null;
  if(Array.isArray(x)) return x;
  if(typeof x==='string'){
    try{ const j=JSON.parse(x); return j; }catch{return x;}
  }
  return x;
}
function pizzasFromOrder(o){
  let src = parseMaybeJSON(o.items) ?? parseMaybeJSON(o.basket) ?? parseMaybeJSON(o.pizzas);
  if(typeof src === 'string') return src;
  if(!Array.isArray(src)) return '';
  return src.map(it=>{
    const name = it.name || it.item || '';
    const qty  = it.qty || it.q || 1;
    const supP = it.supplPrice || it.suppl || 0;
    const supT = it.supplType || (supP? 'suppl.' : '');
    const sup  = supP ? ` (+${supP}‚Ç¨ ${supT})` : '';
    return `${name} √ó ${qty}${sup}`;
  }).join('<br>');
}

/* ===== Rendu ===== */
function render(list){
  // Tri d√©croissant (r√©cent en haut)
  const sorted=[...list].sort((a,b)=>{
    const da=toDate(pickTimestamp(a))||new Date(0);
    const db=toDate(pickTimestamp(b))||new Date(0);
    return db-da;
  });

  const total=sorted.length;
  elRows.innerHTML='';
  let newCount=0;

  sorted.forEach((o,idx)=>{
    const idVisu=total-idx;                        // 5,4,3,2,1‚Ä¶
    const idRaw = o.id || o.ID || o.Id || String(idVisu);

    // HDC: priorit√© API, sinon premi√®re apparition (persist√©e)
    let when = pickTimestamp(o);
    let dHdc = toDate(when);
    if(!dHdc){
      const saved = HDC_BY_ID[idRaw];
      if(saved){ dHdc = new Date(saved); }
      else { dHdc = new Date(); HDC_BY_ID[idRaw]=dHdc.toISOString(); saveHDC(HDC_BY_ID); }
    }
    const hdc  = HHMM(dHdc);

    const td=(label,html)=>{const c=document.createElement('td');c.setAttribute('data-label',label);c.innerHTML=html;return c;};
    const tr=document.createElement('tr');

    tr.appendChild(td('ID', idVisu));
    tr.appendChild(td('Client', o.name||o.client||''));
    tr.appendChild(td('T√©l√©phone', o.phone||''));
    tr.appendChild(td('HDC', hdc));
    tr.appendChild(td('Horaire', fmtSlot(o.slot||o.horaire||'')));
    tr.appendChild(td('Pizzas', pizzasFromOrder(o)));
    tr.appendChild(td('Total', euro(o.total||0)));

    const act=document.createElement('td'); act.setAttribute('data-label','Action');
    const x=document.createElement('button'); x.className='xbtn'; x.textContent='‚úñ'; x.title='Retirer';
    x.onclick=()=>tr.remove();
    act.appendChild(x);
    tr.appendChild(act);

    elRows.appendChild(tr);

    if(!seenIds.has(idRaw)){ newCount++; seenIds.add(idRaw); }
  });

  if(newCount>0 && localStorage.getItem('pizzamigo_sound')==='1'){ playBell(); }
}

/* ===== Fetch ===== */
async function getList(){
  try{
    const r=await fetch(api()+'?list=1',{cache:'no-store'});
    const data=await r.json();
    render(data.orders || data.data || []);
    ok('OK');
  }catch(e){ console.error(e); err('Erreur r√©seau'); }
}

/* ===== Hooks & init ===== */
document.getElementById('save').onclick=()=>{localStorage.setItem('pizzamigo_api', elApi.value.trim()); ok('Param√®tres enregistr√©s');};
document.getElementById('refresh').onclick=getList;

(function boot(){
  const saved=localStorage.getItem('pizzamigo_api'); if(saved) elApi.value=saved;
  bellEl.volume=parseFloat(volEl.value||'0.9');
  getList(); setInterval(getList, 10000);
})();
</script>
</body>
</html>
