<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dashboard — PIZZ’AMIGO</title>
<style>
  :root{--bg:#0d1117;--panel:#0f1623;--line:#243551;--text:#e6edf3;--muted:#9fb0c7;--green:#22c55e;}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:15px/1.45 system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:1100px;margin:18px auto;padding:0 14px}
  .row{display:flex;gap:8px;align-items:center;margin-bottom:10px}
  input[type=text]{width:100%;background:#0b1320;color:var(--text);border:1px solid var(--line);border-radius:8px;padding:8px 10px}
  .btn{border:0;border-radius:8px;padding:8px 12px;cursor:pointer}
  .btn.primary{background:var(--green);color:#05220f}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:10px;padding:14px}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--line);padding:8px 10px;vertical-align:top}
  th{color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:.04em;font-size:12px}
  .small{color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <h1>Dashboard — PIZZ’AMIGO</h1>

  <div class="card" style="margin-bottom:12px">
    <div class="row">
      <label class="small">API :</label>
      <input id="api" type="text" value="https://script.google.com/macros/s/AKfycbyBuj8uM-5Kpz4TH13xGuz12OoxTSj-J2CNugOuD_dJQcA0Tej-4UrCpNDLSNnHcb1z/exec" />
      <label class="small">Clé admin (facultatif) :</label>
      <input id="key" type="text" placeholder="ex: PIZZAMIGO-ADMIN-123" />
      <button class="btn primary" id="save">Enregistrer</button>
      <button class="btn" id="refresh">Actualiser</button>
      <button class="btn" id="demo">➕ Demo</button>
    </div>
    <div class="small">Dernière mise à jour — <span id="last">—</span> &nbsp;|&nbsp; <span id="status" class="small"></span></div>
  </div>

  <div class="card">
    <table>
      <thead>
        <tr>
          <th>Heure</th><th>ID</th><th>Client</th><th>Téléphone</th>
          <th>Horaire</th><th>Pizzas</th><th>Total</th><th>Statut</th>
        </tr>
      </thead>
      <tbody id="rows">
        <tr><td colspan="8" class="small">Aucune commande pour le moment.</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
const EL = id => document.getElementById(id);
const LS = {
  get k(){ return localStorage.getItem('pizz_api_key') || ''; },
  set k(v){ localStorage.setItem('pizz_api_key', v||''); },
  get u(){ return localStorage.getItem('pizz_api_url') || ''; },
  set u(v){ localStorage.setItem('pizz_api_url', v||''); }
};

if (!LS.u) LS.u = EL('api').value;
EL('api').value = LS.u;
EL('key').value = LS.k;

EL('save').onclick = () => { LS.u = EL('api').value.trim(); LS.k = EL('key').value.trim(); tick(); };

// JSONP loader (évite CORS)
function loadJSONP(url, cbName, onerror){
  const s = document.createElement('script');
  s.src = url + (url.includes('?')?'&':'?') + 'callback=' + cbName;
  s.onerror = () => { s.remove(); onerror && onerror(); };
  document.body.appendChild(s);
}

function render(orders){
  const tbody = EL('rows');
  tbody.innerHTML = '';
  if (!orders || !orders.length) {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td colspan="8" class="small">Aucune commande pour le moment.</td>`;
    tbody.appendChild(tr);
    return;
  }
  orders.forEach(o=>{
    const pizzas = (o.items||[]).map(i=>`${i.name} × ${i.qty}`).join('<br>');
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${o.when||'-'}</td>
      <td class="small">${o.id||'-'}</td>
      <td>${o.name||'-'}</td>
      <td>${o.phone||'-'}</td>
      <td>${o.slot||'-'}</td>
      <td>${pizzas||'-'}</td>
      <td>${(o.total??0).toFixed(2)} €</td>
      <td>${o.status||'new'}</td>`;
    tbody.appendChild(tr);
  });
}

function tick(){
  const API = (EL('api').value || LS.u).trim();
  const KEY = (EL('key').value || LS.k).trim();
  if (!API) return;

  const cb = 'onOrders_' + Math.random().toString(36).slice(2);
  window[cb] = (data) => {
    delete window[cb];
    EL('last').textContent = new Date().toLocaleTimeString('fr-FR');
    if (!data || !data.ok) { EL('status').textContent = 'Erreur API'; return; }
    EL('status').textContent = (data.orders||[]).length + ' commande(s)';
    render(data.orders||[]);
  };

  let url = API + '?list=1';
  if (KEY) url += '&key=' + encodeURIComponent(KEY);

  loadJSONP(url, cb, () => { EL('status').textContent = 'Erreur réseau'; });
}

EL('refresh').onclick = tick;

// bouton DEMO : insère une commande factice (aucun CORS : JSONP)
EL('demo').onclick = () => {
  const API = (EL('api').value || LS.u).trim();
  const KEY = (EL('key').value || LS.k).trim();
  if (!API) return;
  const cb = 'onDemo_' + Math.random().toString(36).slice(2);
  window[cb] = (data) => {
    delete window[cb];
    if (data && data.ok) { EL('status').textContent = 'Test créé : ' + data.inserted; setTimeout(tick, 700); }
    else { EL('status').textContent = 'Échec test'; }
  };
  let url = API + '?demo=1';
  if (KEY) url += '&key=' + encodeURIComponent(KEY);
  loadJSONP(url, cb, () => EL('status').textContent = 'Échec test réseau');
};

setInterval(tick, 5000);
tick();
</script>
</body>
</html>
